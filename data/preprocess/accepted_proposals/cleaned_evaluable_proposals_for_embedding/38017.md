time: add time/tzdata packag timetzdata tag emb tzdata program
go program current reli system provid timezon inform tzdata database, reli `goroot` access run time order read `$goroot/lib/timezoneinfo.zip`. alway true, particularli window (#21881) also environ (#38013).
therefore, desir go program mechan directli emb tzdata inform program itself, reli system timezon inform may absent.
make follow assumptions, think reasonable:
- ad timezon inform program optional, increas size program approxim 800k, program need timezon inform local system
- possibl emb timezon inform build arbitrari program
- possibl program alway emb timezon inform without requir special build step
- program alway prefer data system available, like date includ program
given assumptions, propos ad new packag `timezone/tzdata`. import packag (a `import _ "time/tzdata"`) caus timezon inform embed program. also, build build tag `timetzdata` forc packag imported, therefor caus timezon inform embed program. embed timezon inform use system inform avail timezone.
sampl implement approach
chang mention issue: `time/tzdata: new package`
think idea support compil flag packag great.
however, wonder whether oper system tzdata alway prefer present may make applic unpredict case use embed data highli preferred.
would make sens make time/tzdata work like certif pool root ca work? app emb set root ca creat cert pool ad cert pool http package' default transport. go stdlib could still tzdata package, still hook embed tzdata, think way get hook code-imports-a-packag version could less magic anonym import. could requir code explicitli set someth like `time.defaultloadtzinfo = tzdata.loadtzinfo` variabl would allow develop control exactli tzdata get use commun what' happen reader much clearer.
would support cases:
- make backup sourc tzdata (replac `defaultloadtzinfo` function tri call default `defaultloadtzinfo` come back nothing, call tzdata's)
- make authorit sourc (replac `defaultloadtzinfo` tzdata' function)
_some comment origin post
> given assumptions, propos ad new packag `timezone/tzdata`. import packag (a `import _ "time/tzdata"`) caus timezon inform embed program. also, build build tag `timetzdata` forc packag imported, therefor caus timezon inform embed program.
would support latter (the build tag), sure offer former (the `_` import package). forese time helper packag want "make sure" there' timezon inform includ this, end people' depend tree way exclud pester librari author fork.
`_` packag common load depend like databas drivers, think binari size impact packag lower 800k blob comparison.
realli like proposal. small caveat last assumption,
> program alway prefer data system available, like date includ program
like @leighmcculloch 's comment, would prefer give prioriti embed data alway available, deal platform specif heisenbug due data differ user mess system timezon files.
either way, 1000% improv hack go runtim everi release.
wonder wait progress given one could think tzdata opt-in asset file. either way, agre solut issu would useful.
kind problem peopl describ use system timezon data first problem peopl would see today, use system timezon data. peopl actual seen, practice, problem across differ system miss timezon information?
concern use embed timezon data first guarante date within six months. program rebuilt within time frame, certainli program built deploy once. program may emb timezon inform run restrict environments, still use updat timezon inform becom available. seen, practice, problem date timezon information, though date timezon inform system rather program.
particularli want give program choic here. lead complic api benefit few.
@zikaeroh think address issu documentation.
difficult make predictions. especi future. ~ danish proverb
reconsidered. think fine proposed.
>mi concern use embed timezon data first guarante date within six months.
that' great point. ðŸ‘ think approach good solv problem.
reflect would use feature, struggl see use it. case make sure tzdata instal oper system stay up-to-d part gener system health way root ca need present. rare case need consist tzdata led 4d63.com/tz longer problem. issu referenc pr descript get tzdata window address way (#21881). realiz reli oper system workflow everyon use given #38013 use case seem good.
@ianlancetaylor
years, never need time zone inform program. believ major go user situat me.
propos accepted, concern program becom 800k larger. mani users. think packag develop add `import _ "time/tzdata"` one sourc files, execut use packag silent becom 800k larger.
go execut larg - #6853 - lot develop spend time make execut smaller. everi 1 k counts. wast 800k effort someth user even use.
> * ad timezon inform program optional, increas size program approxim 800k, program need timezon inform local system
propos control 800k ad execut not?
reason solut see restrict `import _ "time/tzdata"` `main` packag only.
thank you.
alex
ps: runt. issu pleas user complain #21881, someon spent time implement
>the reason solut see restrict `import _ "time/tzdata"` `main `packag only.
could argument make build tag leav anonym import.
>someon spent time implement
mayb could wait implemented, evalu remain use case remain warrant it?
support light timezon data contain whole histori changes?
someth like:
@embeddedgo, know rule differ years, can't print time year. like us histori know appli differ rule 1995 vs 2015.
overal sound like peopl favor this, would small change. sure would nice embed file support. :-)
ad propos minut seem head like accept.
tzdata right name? see timezone.xml window 400kb (and xml file, got overhead). think may want switch bundl databas format future, "tzdata" specif databas format. mayb someth like "time/zonedb" format-agnost also clear peopl fulli timezon issues?
> ad propos minut seem head like accept.
@rsc comment ?
thank you.
alex
one transit depend import `time/tzdata` also mean binari becom 800k larger?
so, much weight pull especi done implicitli without knowing.
especi interest topic addit 800 kb destroy effort use go nich embed systems.
mainlin 32-bit mcu 1 mb flash. this, 400 kb user code,
quit enough mani applications.
@alexbrainman @komuw @embeddedgo said ( think issu import packag outsid main packag address documentation. sampl document
@raski opinion whether packag call tzdata zonedb. perhap peopl prefer could use emoji vote @rasky' comment ( thumb zonedb, thumb tzdata.
>i tzdata right name? see timezone.xml window 400kb (and xml file, got overhead). think may want switch bundl databas format future, "tzdata" specif databas format.
think name `tzdata` appropriate. right packag bundl format, seem clear packag indic name data contains.
googl search tzdata turn time zone database.
search zonedb turn unrel dn database.
time/tzdata seem like right answer.
except name, peopl seem agreement ad
(again, doc make clear import packag main).
seem like **like accept**.
chang consensus, accepted.
chang mention issue: `time/tzdata: test, permit extra element zone`
re-open cl 224588 roll back cl 228200.
chang mention issue: `time/tzdata: new package`
awesome! would import packag also solv
@xtonyjiang no, won't. cl prefer inform disk available, inform typic correct current system embed information. embed inform fallback use noth els available.
hey ian!
someth say topic may interest share!
> * ad timezon inform program optional, increas size program approxim 800k, program need timezon inform local system
reason time zone inform unix big zic flatten inform provid offici tzdata files. tzdata file defin time zone layer approach, file /usr/share/zoneinfo made independent, caus layer lost. reuse. intentional, program gener load singl time zone file disk.
point past want achiev thing (self-contain binari includ time zone without blow size), discov possibl come solut lot efficient. possibl come algorithm requir data flattened, still decent time complexity. think end manag store entir dataset algorithm ~110 kb. here' did:
1. wrote ugli script take iana tzdata text file pars them. addit that, comput implicit properti need algorithm run quickli (e.g., amount dst use right locat move one time zone another).
2. script stomp c header file contain unflatten definit compil format. definit struct type use found here.
3. wrote implement mktime localtim work top data structur (common subroutines).
4. last least, wrote script around `zdump -v` gener long list unit tests. time zone use test one discov problemat sens (e.g., countri move across intern date line, british doubl summer time).
unfortunately, hardli anyon use code. mayb wast time write first place? mayb not, may serv inspir someon someth similar go?
@edschouten thanks, nice idea.
start read current version go 1.15 releas note one seem strang me. sinc tzdata becom stale, data go modul updat independ standard library?
`golang.org/x/tzdata` go modul updat whenev upstream tzdb chang feel lot fit solut problem.
guess way late chang would like understand reason way, propos go aspect detail asking.
