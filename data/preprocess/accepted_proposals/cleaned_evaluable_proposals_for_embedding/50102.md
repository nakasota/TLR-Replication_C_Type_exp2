archive/tar: add fileinfonam interfac
**note**, feb 2 2022: current propos
---
## abstract
archive/tar function fileinfohead uid -> unam gid -> name lookups,
alway necessari sometim problematic. new function,
fileinfoheadernonames, propos address issues.
## background
chang
(which made way go 1.10) implement
user/group name lookup tar/archive' fileinfoheader.
fill tar file info header field unam gname,
look user group name (from uid gid)
via os/user.lookupid lookupgroupid functions.
alway desirable, sometim problematic:
1. chroot environment, /etc/passwd /etc/group may
absent, content may entir differ host.
2. fail name lookup current cached, may result
consider perform regression, caus re-pars
/etc/passwd /etc/group everi file entri ad tar.
3. case static link glibc, latter want dlopen
librari might either unavail (which result
panic/crash) (in case untrust chroot) malici librari
substitut bad actor.
4. may need creat tarbal without user/group name
(onli numer uids/gids), akin gnu tar' `--numeric-owner` option.
5. may need use custom uid -> name gid -> name
lookup functions.
now, problem 2 mitig use (indirectly, via os/us lookup{,group}id)
good c librari caching, cach fail lookup well.
problem 3 solv use `osusergo` build tag, compil unit wide,
mean also affect os/us uses, archive/tar.
yet seem imposs solv 2 3 time.
far know, easi solut problem 1 5.
particular, affect docker, perform imag unpack re-execut
main binari (dockerd) contain context (essenti chroot). workaround,
docker maintain fork archive/tar commit 0564e304a6ea partial revert
(see
## propos
add function similar `fileinfoheader`, perform id -> name lookups,
leav user. propos name `fileinfoheadernonames` (can also `*nolookup`,
`*num`, etc).
## rational
ad new function seem simpl eleg approach, littl code add, yet solv issu rais above.
altern are:
- (for users) maintain fork archive/tar
- (for archive/tar) implement build tag disabl lookup (e.g. `archivetarnolookups` `archivetarnumeric`)
- (for archive/tar) add way provid name lookup function
- (for archive/tar) add anoth way disabl lookup (so user `tar.namelookup = false` `tar.namelookup(false)`
- uncondit remov id -> name lookup archive/tar (might bring compat issues)
## compat
sinc new api, exist function fileinfohead left intact,
compat issues.
## implement
see exampl code.
cc @thajeztah @tianon @cpuguy83 @tonistiigi @errordevelop
> altern are:
>
> - (for users) maintain fork archive/tar
quit feasibl modul actual allow vendor standard librari packages. realli possibl "more traditional" vendor tools, quit compat featur modul either, major pain use those.
anoth altern would new tar package, new import path potenti new functionality.
fork enforc archive/tar import path basic realli feasibl far tell.
> - (for archive/tar) implement build tag disabl lookup (e.g. archivetarnolookup archivetarnumeric)
common pattern standard librari control function build tags? thought tag would suitabl toggl optimis implement variant (like netgo tag).
> - uncondit remov id -> name lookup archive/tar (might bring compat issues)
might make sens add new function current done, simplifi exist function. but, yes, compat question, howev perhap waiv function best effort herebi proven problematic, move option secondari function might quit reasonable.
throw alternatives: want keep impact go' public api minimal, current `fileinfoheader` could interfac check against.
```
interface {
  LookupUserName(int) (string, error)
  LookupGroupName(int) (string, error)
}
```
`fs.fileinfo` implement method would use instead caller control behavior. would remain advanc case though hidden nature, guess way move default path away current behavior backward compat guarante anyway.
cc @dsnet
> might make sens add new function current done, simplifi exist function. but, yes, compat question, howev perhap waiv function best effort herebi proven problematic, move option secondari function might quit reasonable.
take suggest back now, review see compat issu is.
often want file system-load info _except_ names?
mayb code clear sy field fileinfo pass fileinfoheader?
is:
```
type FileInfoNoSys { fs.FileInfo }
func (FileInfoNoSys) Sys() interface{} { return nil }
blah blah blah FileInfoHeader(FileInfoNoSys(info)) 
```
seem weird carv one detail leav work statunix doing.
docker rather leav _all_ extran system info?
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
> often want file system-load info _except_ names?
everi time tarbal unpack environ user/group name
resolut (id -> name lookup) problematic.
usually, resolut system-depend reli local plain text
/etc/passwd /etc/group, kind local database, remot
distribut system ni ldap.
cgo used, go os/us reli libc, implement methods,
configur system. right, except case static link
gnu libc, case glibc want dlopen nss librari (mean static
binari segfault system librari present).
glibc golang issu per se, make imposs go static
binari link glibc (onli archive/tar want look user/group
names).
anoth issu name resolut use glibc chroot (or pivot root)
untrust directori use (such as, chrooting/ent user container),
call fileinfohead may result dlopen- untrust library.
major secur issue.
solv ether disabl cgo use `osusergo` tag (avail
sinc go 1.13 so), case os/us switch nativ implement
pars plain text /etc/passwd /etc/group. also problemat
* way user/group name resolut /etc/passwd /etc/group
configur system, used;
* chroot use (see above), program end read wrong (untrust
potenti malicious) /etc/passwd /etc/group files;
* disabl cgo use `osusergo` come price, can't done select
archve/tar use only.
tl;dr: user group name resolut rather complic subject,
need make option (one way another).
> seem weird carv one detail leav work statunix doing.
way work / go 1.10.
thing is, id -> name lookup tricki part here, anyth els statunix
rather straightforward. pleas see above.
thanks, sure answer question. understand problem resolv names. question is: need inform extract `statunix` function? is, uid, gid, access time, chang time, devic major minor fields? inform valuabl unpack tar file docker container?
> question is: need inform extract `statunix` function? is, uid, gid, access time, chang time, devic major minor field
(sorri vagu before)
yes, definit do. need use case (i'm unsur atime) and, guess, use case fileinfoheader.
thanks.
> everi time tarbal unpack environ user/group name
resolut (id -> name lookup) problematic.
issu _packing_ tar file, unpack it?
alway possibl chang name return header.
mani use case abl that.
hard time come suitabl way
express 'don't name lookups' gener way.
seem like issu fundament glibc broken certain ways.
(fairli rare) case copi fileinfohead seem like worst workaround.
chang mention issue: `archive/tar: add fileinfoheadernonames`
> issu _packing_ tar file, unpack it?
yes, sorry, mix earlier. talk creat tar archive.
> alway possibl chang name return header.
sure, solv issu (2) (3) description. also performance-wis someth need, lookup might cheap.
> hard time come suitabl way
> express 'don't name lookups' gener way.
total agree, case package-specif (we want disabl lookup globally).
think loud, altern propos (can
a. build tag (e.g `archivetarnonamelookup`);
b. runtim switch (`tar.namelookup = false` `tar.namelookup(false)`);
c. way provid custom function name lookup (incontext would mean make `sysnames` public).
altern essenti similar `fileinfoheadernonames` proposal, let user name lookup functionality, keep backward compatibility.
> seem like issu fundament glibc broken certain ways.
glibc issu mostli work around use `osusergo` build tag. problem is, tag also affect functionality, case binari chroot may want keep use glibc name resolution, unless chroot otherwis untrust environment.
case want overrid mapping?
seem weird choos glibc nothing.
add option interfac packag tar,
fi.fileinfo implement interfac fileinfohead use method
prefer cache?
```
type FileInfoNames interface {
    Uname() string
    Gname() string
}
```
fileinfonam mayb right name, get idea.
@rsc yes, guess would work. @tianon @tonistiigi @thajeztah wdyt?
happi hear @tonistiigi' thought well
quick thoughts;
- propos interfac `uname()` / `gname()` work well non-unix-i platforms? (i know window pain, sure exactli what' expect tar header window wonder flexibl enough)
- there' alreadi package-level `sysstat()` platform-specif bits, get set linux `init()`. wonder would work either way overrid that, `fileinfoheader()` accept (a) function parameter(s) set overrid default, e.g. someth like;
    ```go
    func FileInfoHeader(fi fs.FileInfo, link string, infoFn ...func(fi fs.FileInfo, h *Header) error) (*Header, error) {
        if len(infoFn) > 0 {
            ...
        } else if sysStat != nil {
            ...
        }
    }
    ```
perhap that' much (?)
> propos interfac `uname()` / `gname()` work well non-unix-i platforms?
current set `uid` `gid` field unix systems, so, no. somebodi chang non-unix system somehow set `uid` `gid` fields, would certainli make sens use method avail set `uname` `gname` fields.
> there' alreadi package-level sysstat() platform-specif bits, get set linux init(). wonder would work either way overrid that,
alreadi overrid function' result simpli chang field `header` return `fileinfoheader`. reason overrid call function would want run it, reason run it--except case discuss issue: problemat convert `uid` `gid` `uname` `gname`.
> fileinfoheader() accept (a) function parameter(s) set overrid default,
can't chang signatur `fileinfoheader`, would break go 1 compat guarantee.
sound like peopl mostli happi come around fileinfonam name limit interface. emb fileinfo, though:
```
type FileInfoNames interface {
    fs.FileInfo
    Uname() (string, error)
    Gname() (string, error)
}
```
anyon object this?
**edit, jan 26**: ad error result unam gname.
mayb function also return error . current implement base `user.lookupid` etc return error. implement like open `/etc/passwd` user may want control behavior happen file can't read properli user found. blocker though, guess user pre-cach unam valu wrap `fileinfo` handl error well.
current code ignor error convert `uid`/`gid` `uname`/`gname`. suppos could leav determin method. method return non-nil error, return `fileinfoheader`.
differ issu probabl pass uid/gid methods. otherwis simpl way retriev them.
```Go
type FileInfoNames interface {
    fs.FileInfo
    Uname(uid int) (string, error)
    Gname(gid int) (string, error)
}
```
ok, anyon object iant'
> ok, anyon object iant' #50102 (comment)?
lgtm. @tonistiigi ptal
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
chang consensus, **accepted**. ðŸŽ‰
