net/http: add maxbyteshandler(h handler, n int64) handler
use ioutil.readal http.request.bodi rather common pattern (and one fact use least one net/http examples) somewhat danger caus unbound reads, lead memori exhaust and/or funki behavior line oper read content (i.e. caus stack overflow encoding/json massiv nest structur unmarshal interface{}, see #31789).
common solut problem use http.maxbytesread (or less ideal ioutil.limitedreader) either top level handler wrap http.request.bodi io.readclos incom request (which bit boilerplate-y), handler plan read request bodi (which also quit verbose, easi forget lead vulner endpoint).
ideal would abl set field http.server, non-zero would automat replac request bodi reader maxbytesread incom requests, prevent user either implement top level handler, per handler reader replacement.
@bradfitz @neild
maxheaderbyt http.server already.
suggest add maxbodybyt int64?
base discuss above, seem like **like accept**.
ah sorry, complet miss comment two week ago
> suggest add maxbodybyt int64?
yep, meat proposal.
chang consensus, accepted.
chang mention issue: `net/http: add maxbodybyt server`
sorry, see propos now, late feedback also left gerrit:
> realiz chang feel bit odd me: first http.server tunabl field done http.handler wrapper instead.
>
> histor ad knob server choice, case anybodi configur http.server alreadi wrap handler handler set maxbytesreader.
>
> super hot change. dislik enough argu strongli it, want make sure other agre break preced this.
top comment issu touch ("a top level handler wrap http.request.body"), sure other awar first case server tunabl that' realli required.
cool that?
handler need call `http.maxbytesreader` replac bodi request? seem simpl enough server knob necessary. origin propos even mention this. realli feel like much work could helper method wrap handler ad stdlib rather anoth knob server?
anoth downsid server knob can't control per path anyon need end use handler method.
also think extra field server add much visibl problem common use case listenandserv anyways.
additionally, librari want still handler method long support older version go.
> sorry, see propos
worries, probabl tag http folk initially.
origin rational propos one common http relat secur issu see internet face server peopl either limit request bodi size all, limit request bodi size inconsistently. part fix problem strongli document secur issu limit bodi size, anoth make fix problem frictionless possibl user (one thing heard repeatedli "if import this, enabl default").
agre break precedent, realli _love it_, think least terrible, probabl usable, solut issue. anoth consid solut add `maxbodysizehandler` complement exist `...handler` functions, downsid exist solut without default quit easi forget use ad new handler, leav unprotect route.
> anoth downsid server knob can't control per path anyon need end use handler method.
think reason issue, similar consider exist `readtimeout` field. quit common endpoint like significantli higher limit endpoint (i.e. upload, streaming, authent endpoint). perhap one solut would ad method `request` allow set max bodi size, `setmaxbodysize`, would wrap, explicitli re-wrap, `body` `maxbytesreader` allow singl endpoint overrid default limit (one propos would add method, think argument appli previously, much easier user set default overrid twice rememb set everi handler).
like idea handler wrapper func: would fit nice besid `timeouthandler` `stripprefix` godoc.
cc @fraenkel
easi make work http. tri figur would work http/2 sinc necessari plumbing.
@fraenkel, per discuss above, done http.handler wrapper. http2 packag need awar this: hand handler right thing.
get that. howev entir bodi sent queu pipe. http case add connect close header.
issu renam "net/http: add maxbytehandler(h handler, n int64) handler"? istm, that' consensus. happi open cl is.
benefici too. error defin case ensur user easili check error return e.g. `io.readall` return nice inform api client (e.g. proper error code custom description) log something.
yes, work well pair.
chang mention issue: `net/http: add maxbyteshandler`
