testing: add tb.setenv()
test often verifi behavior reli environ variables. unfortunately, peopl often realiz set environ variabl test use `os.setenv` set variabl entir lifetim process. thing get even complic test execut parallel.
result, test either fail worse: fail should.
first scenario (fail test), debug test probabl lead peopl conclusion, result code like this:
```go
func TestSomething(t *testing.T) {
	os.Setenv("KEY", "VALUE")
	defer os.Unsetenv("ENV")
}
```
necessarili bad, sinc explicit, handl error multipl env var would lot unnecessari copy-past boilerpl code.
second scenario, quit easi introduc leav bug code (i'v fix one today).
propos ad `setenv` method testing.tb, *testing.t, *testing.b someth like this:
```go
// Setenv sets an environment variable for the lifetime of the test.
// It also disables running this test in parallel with other tests.
// The environment variable is automatically cleaned up when the test exits.
func (t *T) Setenv(key string, value string) {
	if t.isParallel {
		panic("Setenv: test cannot be run in parallel with others")
	}
	t.disableParallel = true
	err := os.Setenv(key, value)
	if err != nil {
		t.Fatalf("Setenv: %v", err)
	}
	t.Cleanup(func() {
		os.Unsetenv(key)
	})
}
```
imho fetch data environ variabl ever done packag main, plumb throughout rest program use regular go data types. think would encourag good code hygien sinc environ variabl effect globals.
much agre @mdlayher, also note gotten lot good idea @frankban @rogpepp via cleanup mkdir. setenv unsetenv too.
perhap give input propos get decision.
@mdlayher
> imho fetch data environ variabl ever done packag main, plumb throughout rest program use regular go data types. think would encourag good code hygien sinc environ variabl effect globals.
even that' case, still good idea test code main fetch data environ variables, that, `setenv` primit helpful. moreover, sometim there' way plumb thing without break backward compatibility, and, bad practic not, environ variabl pragmat solut case.
although use huge amount (i count 73 use code base), found primit use times. entir trivial get right either, code sensit whether environ variabl present vs empty, call `os.setenv` old valu alway sufficient.
fwiw almost use test code precis get environ variabl turn configur avail rest system.
support propos (with modif unset instead reset appropriate) particularli `isparallel` check, someth extern code do, nice guard potenti pitfall.
agre `os.getenv` belong bootstrap part application, also need test @rogpepp mention (unfortunately) easi get wrong.
open propos fix number test (where even test run parallel caus flaki results), seem repeat pattern builtin function would make much easier. @rogpepp mentioned, guard parallel test possibl outsid test packag (although could becom separ proposal).
summar discussion, seem like argument favor that:
- program sometim need test behavior respons environ variables.
- undo setenv littl tricki (unsetenv vs setenv old value).
- helper testing.t also verifi parallel test running.
argument seem be:
- test code chang behavior base environ variables.
- provid featur may encourag peopl use environ variabl more.
balanc seem like argument favor outweigh one against.
right?
think that' fair summary.
base discuss above, seem like **like accept**.
chang consensus, accepted.
hi! would like work
chang mention issue: `testing: add tb.setenv function`
chang mention issue: `doc/go1.17: mention testing.[tb].setenv methods`
chang mention issue: `testing: add tb.setenv`
