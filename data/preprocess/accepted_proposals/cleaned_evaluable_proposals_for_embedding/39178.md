net/http: make dn lookup timeout return net.dnserror instead poll.timeouterror
get dn lookup timeout mani time day run go http client kubernetes, udp packet sometim drop due race condit linux kernel. like propos small standard librari chang help debug scenarios.
### version go use (`go version`)?

$ go version
go version go1.14.3 linux/amd64

### issu reproduc latest release?
yes. occur go 1.14.[1-3] <code>vers devel +c88f6989e1 tue may 19 04:10:43 2020 +0000 linux/amd64</code>.
### oper system processor architectur use (`go env`)?
seem appli platforms. experienc often kubernet linux execut compil regular linux server.
<details><summary><code>go env</code> output</summary><br>
$ go env
go111module=""
goarch="amd64"
gobin=""
gocache="/home/mhale/.cache/go-build"
goenv="/home/mhale/.config/go/env"
goexe=""
goflags=""
gohostarch="amd64"
gohostos="linux"
goinsecure=""
gonoproxy=""
gonosumdb=""
goos="linux"
gopath="/home/mhale/go"
goprivate=""
goproxy="
goroot="/usr/local/go"
gosumdb="sum.golang.org"
gotmpdir=""
gotooldir="/usr/local/go/pkg/tool/linux_amd64"
gccgo="gccgo"
ar="ar"
cc="gcc"
cxx="g++"
cgo_enabled="1"
gomod=""
cgo_cflags="-g -o2"
cgo_cppflags=""
cgo_cxxflags="-g -o2"
cgo_fflags="-g -o2"
cgo_ldflags="-g -o2"
pkg_config="pkg-config"
gogccflags="-fp -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=/tmp/go-build197760953=/tmp/go-build -gno-record-gcc-switches"
</details>
### do?
http.client use timeout set transport, timeout exceed error return challeng discov caus timeout error message. dn relat tcp relat someth else? consid follow simul dn lookup return within timeout.
<details>
<summary>dn lookup timeout simul code</summary>
```go
package main
import (
    "context"
    "net"
    "net/http"
    "time"
)
var timeout = 50 * time.Millisecond
var host = "http://example.com/"
// delayedDialer introduces a delay when performing DNS lookups.
func delayedDialer(ctx context.Context, network, address string) (net.Conn, error) {
    time.Sleep(2 * timeout)
    d := net.Dialer{}
    return d.DialContext(ctx, network, address)
}
func main() {
    r := &net.Resolver{
        PreferGo: true,
        Dial:     delayedDialer,
    }
    tr := &http.Transport{
        DialContext: (&net.Dialer{
            Timeout:  timeout,
            Resolver: r,
        }).DialContext,
    }
    client := &http.Client{Transport: tr}
    _, err := client.Get(host)
    if err != nil {
        panic(err)
    }
}
```
</details>
event dn lookup timeout, output is:
panic: get " dial tcp: i/o timeout
event tcp connect timeout (comment <code>time.sleep()</code> call) output is:
panic: get " dial tcp 93.184.216.34:80: i/o timeout
miss ip address dn lookup timeout output clue root caus dn problem, rather tcp problem. user expect see ip address error message, know missing, debug test effort may wast investig possibl tcp-relat causes, instead investig dn (which normal run udp).
think error messag could commun root caus user clearly.
### expect see?
panic: get " dial tcp: lookup example.com: i/o timeout
### see instead?
panic: get " dial tcp: i/o timeout
### propos solut
dn lookup timeout, error return <code>client.get()</code> look like go 1.14.3:
```go
&url.Error{
  Op:  "Get",
  URL: "http://example.com/",
  Err: &net.OpError{
    Op:     "dial",
    Net:    "tcp",
    Source: nil,
    Addr:   nil,
    Err:    &poll.TimeoutError{},
  },
}
```
note: &poll.timeouterror{} becom &net.timeouterror{} futur releas commit

resolv net/lookup.go sourc <code>*poll.timeouterror</code>. instead could return <code>*net.dnserror</code> error lookup time out. would provid addit error context use case (not http.client) may save debug time. exampl <code>client.get()</code> could return:
```go
&url.Error{
  Op:  "Get",
  URL: "http://example.com/",
  Err: &net.OpError{
    Op:     "dial",
    Net:    "tcp",
    Source: nil,
    Addr:   nil,
    Err:    &net.DNSError{
      Err:         "i/o timeout",
      Name:        "example.com",
      Server:      "",
      IsTimeout:   true,
      IsTemporary: false,
      IsNotFound:  false,
    },
  },
}
```
would preserv exist "i/o timeout" string abil call <code>err.timeout()</code>, ad "lookup example.com: " output capabl explicitli check <code>*net.dnserror</code>. output simul would also expect see:
panic: get " dial tcp: lookup example.com: i/o timeout
follow chang implement work usag pass test <code>all.bash</code>.
<details><summary><code>git diff</code> output</summary><br>
$ git diff
diff --git a/src/net/lookup.go b/src/net/lookup.go
index 5f7119872a..b1a22dd4e6 100644
--- a/src/net/lookup.go
+++ b/src/net/lookup.go
@@ -314,6 +314,9 @@ func (r *resolver) lookupipaddr(ctx context.context, network, host string) ([]ip
}()
}
err := maperr(ctx.err())
+ t, ok := err.(timeout); ok && t.timeout() {
+ err = &dnserror{err: err.error(), name: host, istimeout: true}
+ }
trace != nil && trace.dnsdon != nil {
trace.dnsdone(nil, false, err)
}</details>
submit pull request anyon think good idea implementation.
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
/cc @neild @ianlancetaylor thought
look like chang error code path net.dnserror, would lose go 1.15 established, use errors.is(err, os.errdeadlineexceeded) check exceed deadline. seem like mistake.
errors.is(err, os.errdeadlineexceeded) current return fals net.timeouterror despit deadlin exceeded. sure capabl would lost dn time out.
@mhale right. 1.15 establish `errors.is(err, os.errdeadlineexceeded)` work timeout due explicit call `setdeadline` friends. timeout due context expir dn timeouts. or, matter, tcp timeouts.
make propos chang seem reason me.
make `net.dnserror` seem reason me. `dnserror.timeout` `false`, however, sinc error result explicit timeout set `setdeadline` similar.
`dnserror.istimeout` `false`, `dnserror.timeout()` return `false` despit err string "i/o timeout" error result timeout set dialer. might clash expectations.
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
chang consensus, **accepted**. ðŸŽ‰
