build: move goexperi knob make.bash cmd/go
goexperi current allow tri hand differ experiment toolchain features, none need decid make.bash time. make rest toolchain goexperiment-aware. (if realli want toolchain built experi enabled, "goexperiment=foo go instal -a cmd" would work.)
mani `goexperiment` valu could instead `-gcflags` build constraints, `cmd/go` alreadi understands?
rather reduc add number way vari build configuration.
feel strongli whether goexperi knob use cmd/compil tools. think would simpler increment step continu use that, fine switch normal flag too.
think cmd/go probabl charg orchestr everyth still somehow. seen user frequent use `-gcflags=foo` instead `-gcflags=all=foo`; use `-gcflags` without realiz need pass linker flag too; etc.
chang mention issue: `cmd/compile: fix panic field track logic`
think kind interact variou propos build configur (#39005, #42343, perhap others; cc @mvdan @dominikh @jayconrod @matloob).
particular, think `goexperiment` valu essenti predefin shorthand set build flags. add mechan user defin shorthand set build flags, tri get `goexperiment` converg (or least harmonize) that.
chang mention issue: `[dev.regabi] cmd: move goexperi knob make.bash cmd/go`
cl 280113 demonstr mind this. test confirm work fieldtrack. see reason work others.
think rough edg still (e.g., suspect `goenv` work set `goexperiment`, set `goexperiment` probabl updat packag suffix), clean worthwhil direct pursue. think is.
/cc @rsc @aclement @cherrymui @thanm
definit run regist abi work. current use goexperi way control compiler, assembler, variou runtim packag together, done whole-build basis, whole make.bash-basis. current behavior goexperi mean can't easili build work tool chain individual, target build option enabled.
necessarili need goexperi change, coher whole-build option would make much easier. alreadi thing work like this, like go build' `-race` option, anyth that' easili extens like goexperiment.
here' variat @mdempski 's propos would backward compat satisfi need understand them:
add flag `go build`, say, `-goexperiment`, allow set experi singl build. alway appli whole build, would plumb compiler, assembler, runtim go tool (use convent goexperi use today). valu `goexperiment` make.bash time would set default valu flag; henc would behav exactli today pass `-goexperiment` go tool. (alternatively, `goexperiment` `go build` time could overrid make.bash setting, think give mean make.bash `go build` potenti confus also like fewer environ variables.)
eventu broader build configur mechanism, happi switch that, think someth could today (@mdempski alreadi work). sinc meant tool chain development, someth could back replac anoth mechan later.
appreci @mdempski 's propos goexperi set make.bash time becom default, overridden go build time set goexperi (so mostli backward compatible).
bunch us runtime/compil team chat today everybodi seem think good idea. strong consensu whether go build overrid goexperi environ variabl flag, peopl gener favor environ variabl environ variabl tend obvious flow whole process.
look like four activ experiments, cmd/internal/objabi/util.go, are:
{"fieldtrack", &fieldtrack_enabled},
{"preemptibleloops", &preemptibleloops_enabled},
{"staticlockranking", &staticlockranking_enabled},
{"regabi", &regabi_enabled},
preemptibleloop sound like dead code removed.
fieldtrack google-intern big deal other easier access to.
staticlockrank look like could easili build tag fine keep experi instead.
realli look like expos regabi, seem fine well.
wonder bit distinct godebug is. godebug pure runtime, suppose.
definit thing control godebug feel like (godebug=asyncpreemptoff=1 vs goexperiment=preemptibleloop example).
overal seem reasonable. think someth work go command compil need agre on, someth need commun buy-in. intern detail go built, anything. seem agree.
mark accepted.
chang consensus, **accepted**. ðŸŽ‰
