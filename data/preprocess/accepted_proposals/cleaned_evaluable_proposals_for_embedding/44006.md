syscall/js: remov wrapper type avoid extrem alloc improv perform
### introduct
truli remark accomplish compil go webassembl (`wasm`), virtual applic held back combin two factors:
1. everi function call js pass argument make multiple, unavoid go heap alloc
2. go garbag collector block main, only, thread larg fraction second
titl propos suggests, perform problem solv `js.wrapper` type removed. remov exist featur standard librari taken lightly, particular remov allow (`syscall/js` exempt go' compat promise) necessari given data.
### `wrapper` matter
core everi call js, `syscall/js` use `valueof` function convert go argument js equivalents. convers implement switch statement:
```go
func ValueOf(x interface{}) Value {
	switch x := x.(type) { // some cases omitted
	case Value:
		return x
	case Wrapper:
		return x.JSValue() // the problem
	case nil:
		return valueNull
	case bool:
		if x {
			return valueTrue
		} else {
			return valueFalse
		}
	case int:
		return floatValue(float64(x))
	case unsafe.Pointer:
		return floatValue(float64(uintptr(x)))
	case float64:
		return floatValue(x)
	case string:
		return makeValue(stringVal(x))
	default:
		panic("ValueOf: invalid value")
	}
}
```
one case `wrapper` interface. intend allow type implement `jsvalue` method easili pass argument js method. however, `jsvalue` may consist arbitrari pointer receiver, compil must assum worst:
```go
type BadWrapper struct {
    Value js.Value
}
var escapeRoute *BadWrapper
// Implements js.Wrapper
func (this *BadWrapper) JSValue() js.Value {
    escapeRoute = this // escape to heap
    return this.Value
}
```
mean argument `valueof`, includ argument pass js function, guarante escap heap.
### data
data report number heap alloc per unit work.
| optim (cumulative) | frame game (best case) | frame game (worst case) | typic canvas/webgl call | `[]byte` copi js | `string` manipul | garbag collector effect gameplay |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| control (no optimizations) | 858 | 40000 | 3 | 1 | 3 | frequent stutter |
| `//go:noescape` | 829 | untest | 3 | 0 | 3 | frequent stutter |
| `makeargs` slice stack (see #39740) | 383 | untest | 1 | 0 | 3 | less-frequ stutter |
| unexport `wrapper.jsvalue()` | 383 | untest | 1 | 0 | 3 | chang |
| remov `wrapper` type | 62* | 300* | 0 | 0 | 2 | bad, especi alloc reduc |
*on order number alloc happen unrel `syscall/js`
#### data collect method
1. debug output onlin game, implement go
2. micro-benchmarks: main.go
3. entir patch `syscall/js/js.go`: js.go.patch
### context
preliminari discuss propos alreadi taken place #39740. consensu remov `wrapper` way sustain call js function performance-crit setting. given `syscall/js` low level package, make sens priorit perform eas use afford `wrapper`.
#### context actual use case
1. game' client written `go`, compil `webassembly`, use `webgl 2.0` apis, intend run 60 frame per second.
2. webgl api requir mani function calls, mainli take integ float point parameters.
3. observ go garbag collector run everi 3-5 second normal circumstances.
3. observ go garbag collector run 10 time singl frame worst-case-scenario
4. observ go garbag collector take 300+ millisecond run
cc @neelanc @agnivad
support proposal. wrapper type ad conveni perform trump conveni low-level packag `syscall/js`.
author wrapper type also support removal:
@rsc pleas consid propos propos process.
> truli remark accomplish compil go webassembl
program anim led matrix, transfer frame @ 60fps, js ide rendering.
receiv binari frame websocket, ide start stutter around 9000 - 10,000 pixels.
receiv binari frame embed go js, server render anim copi byte js buffer within context requestanimationframe, ide handl 10,000 pixel like butter.. without break sweat!
read proposal, hear perform improv 1.17, give hope even better perform possible!
excit time web platform go both.
chanc get propos process cycle? ðŸ™‚
number often wrapper use today? miss above?
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
> number often wrapper use today? miss above?
miss anything; origin propos make effort enumer usag `js.wrapper`, probabl have.
anyway, search return 375 code results.
- comparison, close altern `js.value` return 2,790 result `syscall/js` return 16,253 results. base number alone, approxim 2-13% open-sourc go `syscall/js` ecosystem affected. attribut low percentag fact easi develop applic without `js.wrapper` (a `interface`, mainli conveni librari developers).
- vast major `js.wrapper` result fals posit (i.e. project use js "wrappers," syscall/js). mani code result comments, actual usag `js.wrapper` type less. made attempt check fraction `js.value` result fals positives, sinc many.
(potenti incomplete) list project would (at least temporarily) break (they refer `js.wrapper` type). list start seem "the big ones" proce particular order. projects, reli `js.wrapper` simpli call `.jsvalue()` themselves, instead actual pass `call`, `new`, `invoke` (which could adapt pass around `js.value` instead).
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
would interest get perspect maintain projects.
finally, sinc 8 month sinc propos began, context particular use cases: develop go version onlin game stopped, develop rust port start (but stalled). also start develop new onlin game base rust wasm. rust seem better fit perform critic wasm. would person benefit propos more, think would help close go<->rust wasm gap elimin major perform cliff.
> anyway, search return 375 code results.
search `syscall/js` number result 55.
interface, find code defin method `jsvalue() js.value`, alreadi mentioned.
sound like need data potenti impact here.
would still feel better data, syscal wasm, heavili used, liter _no one_ object this, seem okay see anyon come forward.
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
realli remov wrapper type, objection. realli understand escap part. exactli escapes, avoid wrapper removed? valu pass javascript know safe escape? i.e. sure javascript hold valu use asynchron way? thanks.
>what exactli escap
go' perspective, paramet `x` `valueof` escap data potion escape. `interface` go oper via indirection. one pointer type inform one pointer data. `interface` may copi value, data must live stack heap. chanc `interface` data could escap stack, go compil must ensur `interface`' data live heap (bi alloc data goe interfac heap, e.g. argument pass function take `interface` parameter).
> avoid wrapper removed?
outlin origin proposal, `case wrapper` decid factor whether interface' data escape. `wrapper` is, itself, `interface`, dynamically-dispatch `jsvalue` receiv run arbitrari code use interface' data, may pointer (includ store pointer global heap, crucially, stack; see `badwrapper`). case switch statement, convers js static dispatch go compil know noth escapes.
> valu pass javascript know safe escape? i.e. sure javascript hold valu use asynchron way?
`unsafe` js hold pointer go' memory, go alloc memory, may need expand webassembl linear memori array buffer. point, js would hold stale pointers. assum reason whoever design `syscall/js` made copi valu js. example, pass `string` js function, `string` copi js, becom new js alloc independ go `string`. anyway, least understanding, design decis mean go valu escap go js heap *due pass js*. could easili escap `badwrapper`.
disclaimer: understanding, gather optim go `syscall/js` code. go compil developer. feel free correct said anyth wrong misleading!
thanks. yeah, think make sens safe valueof escap interfac data least case (e.g. numbers).
chang consensus, **accepted**. ðŸŽ‰
