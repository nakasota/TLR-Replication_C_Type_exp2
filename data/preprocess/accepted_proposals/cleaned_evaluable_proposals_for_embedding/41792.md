flag: panic flag name begin - contain =
## propos
currently, `flag` packag allow string use name flag. valid whether name flag alreadi registered. (code)
but, name flag (1) empty, (2) start hyphen, (3) contain equal sign, flag pars properly. tri use flag describ usag message, fail. (code)
so, suggest `flag` packag valid name flag.
\+
> invalid flag names:
>
> * empti string:
>
> * flag name empti string use `-flag x` form, flag start hyphen('-''') non-flag argument flag start doubl hyphen('--''') terminator.
> * > flag pars stop first non-flag argument("-" non-flag argument) termin "--".
> * start hyphen:
>
> * accord document flag start '-' '--'. but, flag name start hyphen, packag canâ€™t distinguish '-''-flag' '--''flag'.
> * contain equal sign:
>
> * packag use equal sign split flag name-valu pair. so, flag name contain equal sign, packag can't split properly.
> * e.g. flag name 'foo=bar' flag '-foo=bar=value', packag can't find actual value.
## exampl
playgroud
```go
package main
import (
	"flag"
	"fmt"
)
func main() {
	fs := flag.NewFlagSet("", flag.ExitOnError)
	emptyString := fs.String("", "", "empty string")
	hyphen := fs.String("-hyphen", "", "hyphen")
	equalSign := fs.String("=equalsign", "", "equal sign")
	fs.PrintDefaults()
	// Output:
	//  - string
	//        empty string
	//  --hyphen string
	//        hyphen
	//  -=equalsign string
	//        equal sign
	_ = fs.Parse([]string{"-=foobar"}) // bad flag syntax: -=foobar
	// _ = fs.Parse([]string{"--hyphen=foobar"}) // flag provided but not defined: -hyphen
	// _ = fs.Parse([]string{"-=equalsign=foobar"}) // bad flag syntax: -=equalsign=foobar
	fmt.Println(*emptyString, *hyphen, *equalSign)
}
```
sinc check error `flag.parse` time, want point could potenti break current work programs. admittedli program someth odd.
@ianlancetaylor
besid valid `flag.parse` time, think options.
1. valid `flag.var` time: sinc flag defin point, think best time validate. but, way report error except panic.
2. valid `flag.parse` time: sinc flag pars point, itâ€™ appropri method above, itâ€™ still pretti good time validate. also handl error accord error handl method receiv `flag.newflagset`.
3. creat `flag.validate` function, make valid optional: donâ€™t think itâ€™ great way, itâ€™ feasible.
imho, long program use packag incorecctly, break inevitable. choos futur safeti backward compatibility.
nearli flag name constants, even literals. would `vet` check make sense?
vet check suppos meet three requirements: correctness, frequency, precision. think correct precis issu here, seem like frequent problem.
first need know valid flag name not.
seem like solut look problem.
peopl also use flag packag interest way never call `parse` (like use var easi way go string value, seen multipl time configur systems). case name essenti irrelevant, often either empti string (use flagset irrelevant) arbitrari string base properti name (when multipl var ad singl flagset), either break name rule suggest compil run time without error. reason check `var` time `vet` check seem like bad break chang me.
name rule appli `parse`, earliest check happen. would still need complet descript exactli rule though, presum would base actual behavior `parse` itself, var never assign could probabl produc error.
even still danger break change, librari regist global flag bad name could break everybodi depend (even indirectly) librari easi workaround. mean probabl add option enable/dis check least cases, get weed increas api surfac complex question gains.
thing would catch flag nobodi ever even tri use, seem like fairli low prioriti problem fix.
conclus start noth would agre check ad parse, right seem like overal benefici chang anyth all.
> first need know valid flag name not.
>
> seem like solut look problem.
@robpik
imho, flag name caus problem form list document, itâ€™ valid flag name. otherwise, invalid flag name.
invalid flag names:
- empti string:
- flag name empti string use `-flag x` form, flag start hyphen('-''') non-flag argument flag start doubl hyphen('--''') terminator.
- > flag pars stop first non-flag argument("-" non-flag argument) termin "--".
- start hyphen:
- accord document flag start '-' '--'. but, flag name start hyphen, packag canâ€™t distinguish '-''-flag' '--''flag'.
- contain equal sign:
- packag use equal sign split flag name-valu pair. so, flag name contain equal sign, packag can't split properly.
- e.g. flag name 'foo=bar' flag '-foo=bar=value', packag can't find actual value.
flag.flagset.var, end regist flag matter use creat flag, alreadi panic flag name regist multipl times. name pass second call invalid alreadi registered, call panic "flag redefined" message.
doubt would come much, seem like problem call also panic name (1) empty, (2) start hyphen, (3) contain equal sign. clear mistakes.
code point mistak made? seem like case could make mistak notic would system set bunch flag automat sourc string happen invalid. real world exampl that?
interest come practice. @kimmachinegun?
@carlmjohnson @rsc
seen code defin flag way. found problem write test code librari flago thought bug fixed. (sinc cannot satisfi specif document!)
\+ opinion, behavior code document (and specification) alway sync, especi open source.
empti string seem unlikely, could see someon unfamiliar flag packag work tri use flag.bool("-b") add -b flag. panic clear messag would better silent instal inaccess flag.
anyon object ad panic (like duplic registr current panic)?
mentioned, perfectli valid work program would break, recreat someth sure saw wild longer rememb where.
think would okay break change, would happi panic ad parse.
sinc problem caus 'defining' flag invalid flag name, panick time flag 'definition' appropri panick time flag parsing. defin flag invalid flag name entir fault author program, user program. but, error occur flag pars seem like user' fault.
@ianthehat
understand concerns. but, imho, solv problem proper way import keep compat program use flag packag strang way.
@ianthehat much sympathi program creat flag name "".
also can't tell opinion is: two halv line seem say opposit things:
> think would okay break change, would happi panic ad parse.
not? reason way get `flag.value` thing take paramet (notabl thing config file handling, `flag.value` name). agre trivial work around (pick non empti string place), document spirit exist api chang break chang code right now.
opinion is:
â›” : ad panic `flagset.var` okay, break chang question benefit
ðŸ†— : ad panic `flagset.parse` fine, unnam flag hidden problem
@andybon say safehtml (take \*flag.valu parameter), worth. still seem weird.
> @andybon say safehtml (take *flag.valu parameter), worth. still seem weird.
specifically:
anoth option make flag.bool etc panic use custom flagset.
would catch essenti easi case without affect "advanced" uses.
fwiw grep go corpu `flag.(bool|int|string...)\(""` turn exactli one instanc mistake, code:
github.com/rsc/rsc@v0.0.0-20180427141835-fc6202590229/c2go/main.go:28: strip = flag.string("", "", "strip input path write output directory")
appar never use flag!
would fine call directli end `flag.commandline.var` caus panic.
could make option flagset default `flagset` default one return `newflagset`
upsid librari declar empti flag depend chain viabl recours still use wait fix (flip valu main flagset initi reached)
@ianthehat, still convinc empti string case, mayb set aside.
realli want chang behavior base _which_ set is.
let "" go way "comment out" flag bypass (sketchily) safehtml' api,
panic flag begin `-` contain `=`?
definit wrong would confusing.
thing worri new go programm debug flag.bool("-b", ...) seem regist -b.
think clear opportun help case.
would okay that, think empti string truli special case, use seen use pars still (i think) use valid flag name (sometim accident, use thing like valid field name instance)
ok, retitl panick name begin - contain = signs.
anyon object that?
base discuss above, (panic name begin - contain =) seem like **like accept**.
chang mention issue: `flag: panic flag name begin - contain =`
chang consensus, accept (for go 1.17).
