go/ast: add func isgenerated(*file) bool
given #13560 accepted, resolved, now, wide accept go community, think help go parser tool written go could use (if desired).
rel easi write ad hoc parser use `regexp` package, also possibl write special one less overhead.
alreadi wrote one ago, current live `github.com/shurcool/go/generated`.
want move repositori current in, contain mani miscellan go packag lower util quality. origin plan move standalon repositori person site, thought might good fit `x/tools` subrepo, specifically, `x/tools/go` directory, sinc deal go code. propos import path would be:
```Go
import "golang.org/x/tools/go/generated"
```
henc proposal. accepted, happi maintain it/b owner. scope narrow, low volum work.
sure intersect #17244.
accepted, would like move instead:
```Go
import "dmitri.shuralyov.com/go/generated"
```
(the code current mit licensed, either case, relicens go license.)
/cc @andybon @bradfitz @alandonovan @matloob @ianthehat
concern regular express speed? so, rather improv speed regexp instead. perform issu packag already, one may alreadi cover particular expression: #11646 #26623 #21463
realis regex packag may take fast even one case, think there' sens urgenc faster implement `x/tools`.
predic express function ast? often tool need predic alreadi pars file.
```
package astutil
// Generated reports whether the file was generated by a program,
// not handwritten, following the conventions described in #13560.
// The syntax tree must have been invoked with the ParseComment flag.
// Example:
//   f, err := parser.ParseFile(fset, filename, parser.ParseComment|parser.ImportOnly)
//   if err != nil { ... }
//   g := Generated(f)
func Generated(f *ast.File) bool { ... }
```
seem like good fit x/tools/go/astutil packag sinc add dependencies.
regular express great experi complic patterns, need regexp packag express trivial:
```
strings.HasPrefix(line, "// Code generated ") && strings.HasSuffix(line, " DO NOT EDIT.")
```
posix-compli grep command work fine need shell scripts:
```
grep -Exq '^// Code generated .* DO NOT EDIT\.$' "$file"
# Exits 0 if $file matches.
```
case, concern fals posit line occur block comment raw string literal.
> concern regular express speed?
no. want avoid `regexp` depend easi implement match behavior myself.
`regexp` packag still optim independ code.
> predic express function ast?
good question. curiou try. expect possible, sure faster.
note comment would check ast, raw string liter well. .go file follow code need report posit match pattern:
```Go
package p
import "fmt"
func Foo() {
	const s = `this is a raw string literal. it happens to contain
some text in column 1, including a string that matches
the "Code generated ... DO NOT EDIT." comment, like so:
// Code generated  DO NOT EDIT.
to product a correct result, it needs to be detected`
	fmt.Println(len(s))
}
```
sinc fact contain line text match regular express `^// code gener .* edit\.$`.
> posix-compli grep command work fine need shell scripts:
indeed. quick easi implement parser format languag support regular expressions. packag meant avail use tool written go, prefer avoid incur cost spawn process import `regexp` package.
> case, concern fals posit line occur block comment raw string literal.
fals positives. accord spec, file consid gener match line text appear anywher file, includ block comment raw string literals.
> fals positives.
good know grep way hit fals posit :)
> packag meant avail use tool written go
anecdotally: frequent case need check whether file auto-gener manual filter `go list` output shell script, decid whether file run `go fmt`. me, would help could use `{{if .generated}}` part templat pass `go list -f`. chang `go list` issue.
would 1-declar 1-line package. tri avoid those. pleas propos new method top-level function exist package, like probabl go/ast.
ping @dmitshur; see previou comment.
agre comment @rsc would small package, better avoid x/tools.
think function could fit exist packages, initi thought share. pleas note final proposal; iter want share. complet happi want implement is.
### wip counter-propos revis 1
exist packages, function seem belong `go/parser`. api surfac chang would somewhat large. would involv new `parser.mode`:
```diff
// A Mode value is a set of flags (or 0).
// They control the amount of source code parsed and other optional
// parser functionality.
//
type Mode uint
const (
	PackageClauseOnly Mode             = 1 << iota // stop parsing after package clause
	ImportsOnly                                    // stop parsing after import declarations
	ParseComments                                  // parse comments and add them to AST
+	GeneratedComment                               // determine whether the file contains a "// Code generated â€¦ DO NOT EDIT." line comment
	Trace                                          // print a trace of parsed productions
	DeclarationErrors                              // report declaration errors
	SpuriousErrors                                 // same as AllErrors, for backward-compatibility
	AllErrors         = SpuriousErrors             // report all errors (not just the first 10 on different lines)
)
```
mode turn on, `parser.parsefile` would perform addit work determin .go file "// code gener â€¦ edit." line comment.
(there preced `go/build` package, specif `importcomment` import mode.)
order `parser.parsefile` report result, `ast.file` `go/ast` packag would also need modified:
```diff
// A File node represents a Go source file.
//
// [...]
type File struct {
	Doc        *CommentGroup   // associated documentation; or nil
	Package    token.Pos       // position of "package" keyword
	Name       *Ident          // package name
	Decls      []Decl          // top-level declarations; or nil
	Scope      *Scope          // package scope (this file only)
	Imports    []*ImportSpec   // imports in this file
	Unresolved []*Ident        // unresolved identifiers in this file
	Comments   []*CommentGroup // list of all comments in the source file
+	Generated  *Comment        // a "// Code generated â€¦ DO NOT EDIT." line comment; or nil
}
```
first, seem like appropri place exist packag add functionality. however, consid detail closely, seem like good fit.
"// code gener â€¦ edit." comment live parallel actual ast structur file. accord spec, comment appear insid block comment, would still count. also appear within raw string literal, match. work must done determin .go file comment littl pars actual ast .go file.
### wip counter-propos revis 2
altern propos consid add function `go/build` packag follow way. add `generatedcomment` import mode, similar exist `build.importcomment`:
```diff
 // If ImportComment is set, parse import comments on package statements.
 // Import returns an error if it finds a comment it cannot understand
 // or finds conflicting comments in multiple source files.
 // See golang.org/s/go14customimport for more information.
 ImportComment
+
+// If GeneratedComment is set, determine which .go files contain
+// a "// Code generated â€¦ DO NOT EDIT." line comment,
+// and populate GeneratedGoFiles with the results.
+// See golang.org/s/generatedcode for more information.
+GeneratedComment
```
result would popul new `build.package` field:
```diff
type Package struct {
	// ...
	// Source files
	GoFiles          []string // .go source files (excluding CgoFiles, TestGoFiles, XTestGoFiles)
	CgoFiles         []string // .go source files that import "C"
	IgnoredGoFiles   []string // .go source files ignored for this build
	InvalidGoFiles   []string // .go source files with detected problems (parse error, wrong package name, and so on)
+	GeneratedGoFiles []string // .go source files containing a contains a "// Code generated â€¦ DO NOT EDIT." line comment; populated only if GeneratedComment mode is set
	CFiles           []string // .c source files
	// ...
```
approach seem cleaner ad someth `go/parser` `ast.file`, sure good either. inform whether file gener feel like belong file level, packag level.
there' also factor `golang.org/x/tools/go/packages` meant use instead `go/build` now, ad someth new `go/build` seem like good idea.
"wip counter-propos revis 3" section can/should ad similar approach revis 2 evalu `golang.org/x/tools/go/packages` package.
### conclus
would lean toward either put propos hold (or wait iter further), outright declin it. made propos plan move exist package, want check there'd fit place `x/tools`. seem exist packag meet criteria inclusion.
additionally, given easi pars gener comment regexp, high demand function far tell (e.g., `github.com/shurcool/go/generated` current 1 known public importer), unclear addit work integr exist packag justifi time.
@dmitshur let' discuss person. per @golang/proposal-review ok ad util function iff decid good place good api.
chang mention issue: `cmd/go: copi miss bit document code gener comment`
reluct add field struct - seem like bit overkill.
ad generatedgofil go/build mean remov file gofiles, would break exist users.
seem like could use current parser packageclauseonli | parsecom
(or whole file concern much get parsed)
provid
packag ast
func isgenerated(f *ast.file) bool
think?
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
suggest seem good far. elabor minor detail below.
sinc there' `error` return value, understand would pre-condit input provid `isgenerated` comput correctly. is, `isgenerated` return `false` even origin file actual generated, ast parser configur correctli (e.g., left parsecomments). fine long document there' simpl usag example.
think use `*ast.file` instead someth like `io.reader` `filenam string` (what `dmitri.shuralyov.com/go/generated` api uses) make sens spec redefinit #41196, sinc entir file longer need scanned.
wrote packag primarili exercis test would possibl implement parser spec propos #13560, sinc import goal. yet use anywhere. pkg.go.dev report one known import `github.com/fatih/faillint/faillint` (cc @fatih), see faillint.go#l115-l119. `analysis.pass` access pars ast, support `func isgenerated(f *ast.file) bool` good signature.
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
chang consensus, **accepted**. ðŸŽ‰
