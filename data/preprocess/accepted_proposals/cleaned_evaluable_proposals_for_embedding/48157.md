cmd/go: add per-test timeout
test overal timeout entir binari timeout specif test case.
often want limit particular test case time much shorter overal binary.
propos add concept per-test (function) timeout go command user experi follows.
1. test get per-test timeout. timer given test tick test running. tick test block t.parallel, block t.run run subtest.
2. default per-test case timeout 1m (one minute). new `-testtimeout` flag specifi explicitly, set differ default. `-testtimeout` flag omit `-timeout` specifi explicitly, set default too. way, one realli long test use `go test -timeout=30m`, per-cas timeout kick 1 minut kill anyway.
3. new testing.tb method `settimeout(d time.duration)` allow test set timeout. call settimeout reset timer. test run 30 second call `t.settimeout(1*time.second)`, get kill time out. timeout set way inherit subtests. (they timer.)
4. test timeout happens, whole process still get killed. there' noth realli that. failur say test function time out.
chang help user generally, also help fuzzing, individu invoc fuzz function testing.t 1-minut timer, provid detect input caus infinit loop slow execution.
> test timeout happens, whole process still get killed. there' noth realli that. failur say test function time out.
suspect would help (at least somewhat) use-cas motiv #39038, too.
sound great. besid overal better experi there' hang test, may allow simpler test code situations. sometim written test exercis concurr code which, fails, expect hang/deadlock; spawn timer fail test complet after, say, 5s. depend whether kill-the-whole-test behavior acceptable, could chang simpli use `t.settimeout(5 * time.second)` instead.
would still 10m default `-timeout`?
would prefer be, sinc hit timeout without hit 1m per-test timeout seem like signal giant test suit oper correctly, hanging/broken test.
so, per reading, `-testtimeout` `-timeout` set per-test *default* timeout, `t.settimeout` alway take precedence. correct?
think that' intuit test author. someon want constrain overal run-tim tests, use global `-timeout`, presumably.
> 2. `-testtimeout` flag omit `-timeout` specifi explicitly, set default too.
understand reason behind this, also slightli uneasi it. mani ci current use line like `go test -timeout=30m ./...`; mean would get zero net benefit proposal, unless notic need chang `go test -timeout=30m -testtimeout=1m ./...`.
> 4. test timeout happens, whole process still get killed. there' noth realli that.
could expand reason can't better?
separ point; would updat take account timeout run test too? assum would be, clarifi sinc propos say.
overal realli like idea, reason bryan caleb mention too. think main worri set per-test timeout `t.settimeout` would hard. machin one even two order magnitud faster other term cpu, disk, network, especi take account busi machines, like public share ci runners.
problem `-timeout` `-testtimeout` flags; chang depend context. use `-testtimeout=1m` laptop, `-testtimeout=3m` public ci, example. however, `t.settimeout` fairli static can't adjust depend environment, far see.
mayb could also think "test timeout scales"; could run test way per-test timeout tripl know machin significantli slower averag laptop (e.g. public ci). think go' builder someth similar, slow comput small arm/riscv board get mani timeout multipli avoid benign timeouts.
> test timeout happens, whole process still get killed. there' noth realli that. failur say test function time out.
would failur includ messag log timeout?
> understand reason behind this, also slightli uneasi it. mani ci current use line like go test -timeout=30m ./...; mean would get zero net benefit proposal,
zero net benefit, also zero breakage. hard latter without former.
ci individu test case run 10 minutes, tri avoid break them.
think ok break them? (honest question.)
start scratch would much easier say two separate.
@rogpeppe:
> would failur includ messag log timeout?
yes, would hope so. think that' possibl independ propos though. right panic see go around flush output first. (mayb tricky, know.)
> zero net benefit, also zero breakage. hard latter without former.
that' fair - better altern mind. mainli highlight make clear releas notes: `go test -timeout` user see benefit unless tweak flags.
> could expand reason can't better? [than crash whole process]
way forc stop goroutin asynchronously. reason way unsafe: goroutin may hold locks, etc. also may goroutin run part test. safe way attribut goroutin need stop (and also way safe way stop them).
> safe way attribut goroutin need stop (and also way safe way stop them).
testing.tb context method test benchmark could cooper grace shutdown. (exampl bit trickier without changes, also less like problematic.)
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
benefit `settimeout(d time.duration)` well `-testtimeout` flag? would suffic former, latter? coupl issu see `-testtimeout`.
firstli basic usabl concern. would suggest appli per-test timeout test (be run) would unhelp lot time. howev much readili think situat want run `go test ./...`, appli specif timeout specif test ad call `settimeout`. far fewer situat would make sens appli per-test timeout test - would requir select longest-run test contain within specifi packag set `-testtimeout` accordingly. requir knowledg code base user run `go test` may possess.
secondli nuanc concern `-testtimeout` fit exist environment. run `go test ./... -testtimeout=1m` may signific effect outcom test - i.e. may fail previous passed. import detail detach test itself. currently, want test execut parallel (with like-mind tests), call `parallel` top test. `-parallel` flag caus test run parallel. given timeout similarli outcome-alt effect test, would consistent, explicit, per-test timeout set insid test itself?
@mvdan' suggest way scale valu pass `settimeout` seem good way make `-testtimeout` larg redundant, whilst also provid mechan adjust per-test timeout accord environ test run:
> mayb could also think "test timeout scales"; could run test way per-test timeout tripl know machin significantli slower averag laptop (e.g. public ci). think go' builder someth similar, slow comput small arm/riscv board get mani timeout multipli avoid benign timeouts.
@josharian, `context` method needed. test benchmark alreadi cooper grace shutdown via `deadline` method â€” need allow overhead today test end shut timeout expire.
exampl work today `cmd/go` tests, see:

@bcmill t.deadlin let predict test time out. provid mean receiv inform test fail (or time out) result promptli shut down.
ah, see mean. think more-or-less complet orthogon per-test timeout â€” that' interact `t.parallel()` exist `-test.failfast` flag.
@joe-mann me, *most* valu propos come `-testtimeout`.
way would use it, mostli improv handl deadlock tests. example, interact lot test suit take sever minut run heavili load ci worker individu test take second most. like would find longest-run test set `-testtimeout` slightli higher that; instead, would want `-testtimeout` high enough reason test could possibl hit without bug (whatev time scale happen domain). test suites, default valu 1m sound pretti good.
then, test deadlocks, `go test` fail faster (up 9m sooner would'v otherwise, assum default `-timeout 10m`, even set `-timeout` higher). realli larg test suites, go danc (1) start bump `10m` default timeout get spuriou failures, (2) look whether "natural" timeout deadlocks, (3) rais `-timeout`. (that' assum delet 10m default `-timeout` brought
think `settimeout` use certain test specif check particular thing *doesn't* hang. think would use `settimeout` occasion wherea `-testtimeout` would help everi day.
remain objections?
remain worri outlin last three paragraph - set absolut `time.duration` timeout test feel rigid. think built-in support "scale" multipli would necessary, e.g. slower machin ci. otherwis either end realist timeout caus sporad failur ci, inflat timeout reduc flake take long make test fail local iter testing.
coupl comment later thread seem agre problem warrant attention. person think sort multipli seem like sane solution, roughli defin "base" speed - averag laptop two year ago that' idle. solut seem work well enough build.golang.org, understand builder use multipli given slower hardware.
@mvdan alreadi absolut durat -timeout=, right? seem like mayb automat timeout scale (essenti elev cmd/dist does), could done separate, orthogon proposal. might worth information, sinc test cours check environ variabl scale own, peopl write helper that.
@rsc confirm whether propos includ remov 10m default `-timeout`?
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
@rsc guess problem peopl implement scaling, would shame project reinvent slightli differ wheel differ standard "base timeout scale" is. hope least get ahead defin scale default timeout be. project use "enough even slowest machine", other use "match modern fast machine", ad built-in scale later time work mismatch baselines.
@mvdan, pleas feel free file propos scale mechanism. thanks!
chang consensus, **accepted**. ðŸŽ‰
