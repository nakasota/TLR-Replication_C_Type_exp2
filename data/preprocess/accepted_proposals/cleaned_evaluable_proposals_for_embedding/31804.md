crypto/ed25519: implement ed25519ph
**update**, apr 6 2022: propos api
---
ed25519ph variant specifi rfc 8032 allow signing/verifi messag alreadi hash sha-512 without risk collision-resist properti "pureeddsa" use key messag sign use schemes.
use least two scenarios:
1. privat key isol anoth piec hardwar pass entir messag sign possible, exampl use hsm sign messag larger kb.
2. work larg messag larg reason buffer current one-shot api.
variant implement minim use exist `crypto.signer` api plu addit verif function, without encourag unsaf use provid easi access api take `io.reader` `io.writer`.
due addit intern hash initialization, way implement without fork packag upstream implement patch.
send cl propos implementation.
relevant: #31727
/cc @zx2c4 @filosottil
chang mention issue: `ed25519: implement ed25519ph`
+1
thank @titan , needed. confirm behav refer implement (libsodium). ðŸ‘
sure still time 1.13... @filosottil
late go 1.13, target go 1.14. (`crypto/ed25519` standard library.)
understand `crypto.signer` interfac fix stone can't changed, go happen, would nice support full `ed25519ph` algorithm describ rfc.
stand right now, propos implement support domain separ context.
sinc alreadi `sign` method package, pr add `verifyhashed`, could done ad `signhashed(privatekey privatekey, context, messag []byte) []byte` chang propos `verifyhashed` take anoth byte slice.
rfc 8032 defin context independ pre-hashing, support whole spec also support pure ed25519 custom context.
realli fan extend api surfac standard librari packag point user basic public key signatures. altern api, extens still make opt-in select variants?
```
// Options can be used with PrivateKey.Sign or VerifyWithOptions
// to select Ed25519 variants.
type Options struct {
    // Hash can be zero for regular Ed25519, or crypto.SHA512 for Ed25519ph.
    Hash    crypto.Hash
    Context string
}
func (*Options) HashFunc() crypto.Hash
func VerifyWithOptions(publicKey PublicKey, message, sig []byte, opts *Options) bool
```
propos api accepted, `verifyhashed` propos pr go away right? would favor this, sinc seem like cleaner way support functionality.
nitpicking: particular reason `context` `string` `[]byte`? understand fairli interchang (and `string` may `const` friendly). person would make `[]byte` make clear arbitrari "octet string 255 octets" (and includ size limit doc string comment).
> propos api accepted, `verifyhashed` propos pr go away right? would favor this, sinc seem like cleaner way support functionality.
yep.
> nitpicking: particular reason `context` `string` `[]byte`? understand fairli interchang (and `string` may `const` friendly). person would make `[]byte` make clear arbitrari "octet string 255 octets" (and includ size limit doc string comment).
mostli consistency, use string context elsewhere, case make differ type messag (which relev here). person think fit better natur value, usual fix least immutable, often human-readable, say const.
definit document max length, thank you.
went implement packag maintain dayjob (becaus dayjob need ph-with-context support), feedback.
happen `hash` `crypto.hash(0)` `context` `""`?
1) ed25519ctx 0 octet context ("the context input empty.").
2) ed25519pur
went option 2 option 1 somewhat nonsens recommend against, though happlili chang packag match runtim librari does. `context` byte, could disambigu `nil` vs `[]byte{}`, clear justifi loss consist `const` friendliness, sake completeness.
minor: use `opt crypto.signeropts` `verifywithoptions` possibl pass `crypto.sha512` context requir (follow `publickey.sign`). type name somewhat unfortunate, eas use suspect common case probabl win out.
> happen `hash` `crypto.hash(0)` `context` `""`?
>
> 1. ed25519ctx 0 octet context ("the context input empty.").
> 2. ed25519pur
>
> went option 2 option 1 somewhat nonsens recommend against, though happlili chang packag match runtim librari does. `context` byte, could disambigu `nil` vs `[]byte{}`, clear justifi loss consist `const` friendliness, sake completeness.
yeah, definit pure context `""`, altern confus someth peopl anyway, document it. also fan semant differ `nil` `[]byte{}` general.
> minor: use `opt crypto.signeropts` `verifywithoptions` possibl pass `crypto.sha512` context requir (follow `publickey.sign`). type name somewhat unfortunate, eas use suspect common case probabl win out.
thought that, think rather use concret type reasons:
* can't actual semant use `crypto.signeropts` here, reason sign match interfac need abstraction, verifywithopt semant justif
* ed25519ph someth need encourag make easy, explicitli use option seem fine
* interfac box still caus heap escapes, think
thank mail cl 174941 @titanous, unfortun make cut go1.14 freeze, pleas rebas master hope get go1.15. apolog lack eye go1.14.
think wrong,
```
If opts.HashFunc() is crypto.SHA512, the pre-hashed variant Ed25519ph
is used and message is expected to be a SHA-512 hash,
```
prehash mode must job internally, i.e. explicitli hash (like large) messag sha-512.
otherwise, guarante hash messag gener sha-512, could gener anoth hash function also output number bytes.
> prehash mode must job internally, i.e. explicitli hash (like large) messag sha-512.
> otherwise, guarante hash messag gener sha-512, could gener anoth hash function also output number bytes.
`crypto.signer` api works. expect hash messag call `sign` hash function option specified. example, look ecdsa packag it.
> `crypto.signer` api works.
> expect hash messag call `sign` hash function option specified. example, look ecdsa packag it.
cous work like `crypto.signer` take account use prehash signatur schemes. ed25519ph one them, prehash messag _internally_ use alway sha-512.
acknowledg lack signer go interfac handl new signatur scheme exampl rfc-8032, enabl prehash receiv domain separ string input.
so, dear @yawn @filosottil interest parties, implement ed25519 variant (pure, ctx ph), here: follow advic given issue. want summit pr follow api.
> > `crypto.signer` api works.
> > expect hash messag call `sign` hash function option specified. example, look ecdsa packag it.
>
> cous work like `crypto.signer` take account use prehash signatur schemes. ed25519ph one them, prehash messag _internally_ use alway sha-512.
point ed25519ph avoid pass whole messag signer, expect sign take digest perform sha-512 hash itself. option, use ed25519. also differ everi crypto.signer, take caller' word hash gener digest.
chang mention issue: `crypto/ed25519: implement ed25519ph sign verifywithoptions`
thank @filosottil cl, happi see implemented!
see sha-512 support hash cl, understand one defin rfc 8032. however, think would possibl make method support gener hashes? exampl see use support sha-256 hash (when applic need 512-bit long ones) better future-proof one day may need switch hash function (sha-3, blake2, etc).
> thank @filosottil cl, happi see implemented!
>
> see sha-512 support hash cl, understand one defin rfc 8032. however, think would possibl make method support gener hashes? exampl see use support sha-256 hash (when applic need 512-bit long ones) better future-proof one day may need switch hash function (sha-3, blake2, etc).
way implemented, want use differ hash provid 512-bit digest pre-hash message, "just work" pass sha-512 hash (though still use sha-512 internally), pre-hash messag treat opaqu blob.
want also use altern hash algorithm intern (eg: deriv r scalar), would requir substanti alter code (and would rather massiv deviat algorithm defin rfc/fip draft). far concerned, point want switch underli hash algorithm degree, might well use nicer signatur scheme entir (eg: sr25519 use keccak base merlin transcript + r255, support 256/512-bit digests, along xof pre-hash messages).
> want use differ hash provid 512-bit digest pre-hash message, "just work" pass sha-512 hash (though still use sha-512 internally), pre-hash messag treat opaqu blob.
make sens 512-bit hashes. right code would fail anyth 64-byte long (i see check make sure input length sha-512 hash).
> want also use altern hash algorithm intern (eg: deriv r scalar), would requir substanti alter code
can't speak others, concern with, problem. reason like use ed25519ph sign larg file calcul hash stream input, possibl ed25519. concern hash algorithm use internally.
> make sens 512-bit hashes. right code would fail anyth 64-byte long (i see check make sure input length sha-512 hash).
append 256-bit worth 0s digest. alreadi someth non-standard.
no, ed25519ph defin specifi singl hash, that' good thing. flexibl cryptographi liability, asset per se. sha-512 turn broken, consid progress cryptanalysi press concern, simpli specifi implement new ed25519 variant use differ hash everywhere. need sign non-sha-512 hash, use pure ed25519 understand domain separ responsibility, would suggest consid switch sha-512 64-bit platform sometim faster sha-256.
> however, think would possibl make method support gener hashes?
someth keep mind may immedi obviou look diff cl alon that, regardless "prehash" mode, ed25519 _already_ use sha-512 intern (twice sign, verify). that' someth anybodi talk chang modular here; work fine. so, given there' _already_ necessari sha-512 code path, complic thing ad someth differ prehash mode? keep code size small re-us hash function, sha-512.
and, filippo said, want go someth weird, figur safe you.
---
curiou specified, here' line copi past verif phase ed25519[ph]:
> 2. comput `sha512(dom2(f, c) || r || || ph(m))`
interpret `sha-512(somestuff concaten ph(the message))`. notic sha-512 hard code there. `ph()` function?
take look section. ed25519, vanilla version, says:
> `| ph(x) | x (i.e., ident function) |`
simplifi `sha-512(somestuff concaten message)`.
ed25519ph, prehash version, says:
> `for ed25519ph, [...] ph sha512 instead. `
simplifi `sha-512(somestuff concaten sha-512(th message))`.
point somewhat glad thing made _more_ complic two differ hash function there. write express two differ hash functions, would probabl tell me, "that' weird, use one?"
implement api
@golang/proposal-review, get slate go 1.19?
propos api
@filosottil kindli ping, look like 1 small comment left cl.
@cristaloleg wait @golang/proposal-review committee, cl effect ready.
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
readi âœ¨
chang mention issue: `crypto/ed25519: implement ed25519ctx ed25519ph context`
