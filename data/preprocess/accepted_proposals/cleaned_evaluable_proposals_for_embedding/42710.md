hash/maphash: add byte string
**update**, mar 16 2022 - current propos
---
overhead construct `hash` object order call `hash.write` greatli diminish util small buffers.
consid follow micro-benchmark:
```go
var source = []byte("hello, world") // 12 bytes long
var sink uint64
func BenchmarkMapHash(b *testing.B) {
	var seed = maphash.MakeSeed()
	for i := 0; i < b.N; i++ {
		var h maphash.Hash
		h.SetSeed(seed)
		h.Write(source)
		sink = h.Sum64()
	}
}
//go:linkname runtime_memhash runtime.memhash
//go:noescape
func runtime_memhash(p unsafe.Pointer, seed, s uintptr) uintptr
func BenchmarkUnsafeHash(b *testing.B) {
	for i := 0; i < b.N; i++ {
		sink = uint64(runtime_memhash(*(*unsafe.Pointer)(unsafe.Pointer(&source)), 0, uintptr(len(source))))
	}
}
```
machin produces:
```
BenchmarkMapHash      	56459700	        21.6 ns/op
BenchmarkUnsafeHash   	246443527	        4.90 ns/op
```
directli use `runtime_memhash` around ~4x faster sinc avoid unnecessari state contain `hash` rel pointless hash singl small string.
propos ad follow api:
```go
func Sum(b []byte, seed Seed) uint64
```
function thin wrapper `runtime_memhash`. take `seed` input forc user think applic seeds.
chose name `sum` consist `md5.sum` `sha1.sum`.
found `hash/maphash` unus string hash custom map implement due performance. better use `runtime.strhash` directli (..and accept potenti futur mainten hassle).
ideal `maphash.sum([]byte(s), seed)` would also fast, requir compil improvements. mayb `sumstring` ad well address use case?
> ideal `maphash.sum([]byte(s), seed)` would also fast, requir compil improvements. mayb `sumstring` ad well address use case?
see #2205. propos `sumstring` caus still hope compil optim avoid cases.
:= 0; < b.n; i++ {
var h maphash.hash
h.setseed(seed)
h.write(source)
sink = h.sum64()
}
suppos used. suppos do:
var h maphash.hash
h.setseed(seed)
:= 0; < b.n; i++ {
h.reset()
h.write(source)
sink = h.sum64()
}
tri instead?
> tri instead?
runtim drop ~22n 20ns, still much slower compar direct hash `[]byte` (~5ns).
@dsnet, fundament reason write+sum64 much slower singl call?
back setse loop, could see setse fundament unnecessarili expensive.
write+sum64 fundament slower one call? perform bug somewhere?
see sever reason slowdown:
* `hash.write` alway perform copi input slice. clear avoid copi without fundament chang oper `hash` works. hash short strings, half time spent copi (i.e., avoid copi bring runtim 10ns).
* `hash.reset`, `hash.write`, `hash.sum64`, `hash.initseed` inlineable. massaging, probabl get except `hash.write` inlined. save ns.
see. copi larg write bug - hash byte directly. benchmark, hash multipl 64 bytes, would copi all. point seem like win write+sum64 combin know final copi needed. mayb that' small win.
chang mention issue: `hash/maphash: optim write writestring`
chang mention issue: `hash/maphash: manual inlin setseed`
play bit, also hit recently. cl 278758 278759 278760 could squeez it. help fair amount larg writes, much littl ones, work (tri reduc perform regress due
chang mention issue: `hash/maphash: increas buffer size`
thank work optimizations, @josharian. probabl put propos hold made current api fast be.
fwiw, optim much know how. see way make current api faster small writes. need make write work ident regardless got chunk realli tie hand implementation.
**place hold**.
â€” rsc propos review group
attempt fix rediscov issu file bug report, stumbl one. share benchmark case useful.
```
package test_test                                                                                                                                                                                                                                                                                                                                                                               
import (                                                                                                                                                                                                                                                                                                                                                                                        
        "fmt"                                                                                                                                                                                                                                                                                                                                                                                   
        "hash/maphash"                                                                                                                                                                                                                                                                                                                                                                          
        "math/rand"                                                                                                                                                                                                                                                                                                                                                                             
        "testing"                                                                                                                                                                                                                                                                                                                                                                               
        _ "unsafe" // for linkname hack                                                                                                                                                                                                                                                                                                                                                         
)                                                                                                                                                                                                                                                                                                                                                                                               
// fnv is the fastest for size < 16, runtime is asymptotically fastest.                                                                                                                                                                                                                                                                                                                         
// maphash only beats fnv at when size >= 128, and is 6x slower than runtime                                                                                                                                                                                                                                                                                                                    
// when size = 1024 even though it's the same algorithm.                                                                                                                                                                                                                                                                                                                                        
//                                                                                                                                                                                                                                                                                                                                                                                              
// Benchmark/maphash-1-12               65962508                17.13 ns/op                                                                                                                                                                                                                                                                                                                     
// Benchmark/fnv-1-12                   1000000000               0.6944 ns/op                                                                                                                                                                                                                                                                                                                   
// Benchmark/runtime-1-12               291040464                3.793 ns/op                                                                                                                                                                                                                                                                                                                    
// Benchmark/maphash-2-12               69972840                17.02 ns/op                                                                                                                                                                                                                                                                                                                     
// Benchmark/fnv-2-12                   1000000000               1.052 ns/op                                                                                                                                                                                                                                                                                                                    
// Benchmark/runtime-2-12               282301180                3.786 ns/op                                                                                                                                                                                                                                                                                                                    
// Benchmark/maphash-4-12               74032375                16.76 ns/op                                                                                                                                                                                                                                                                                                                     
// Benchmark/fnv-4-12                   594186979                1.727 ns/op                                                                                                                                                                                                                                                                                                                    
// Benchmark/runtime-4-12               278877213                4.043 ns/op                                                                                                                                                                                                                                                                                                                    
// Benchmark/maphash-8-12               70253731                16.79 ns/op                                                                                                                                                                                                                                                                                                                     
// Benchmark/fnv-8-12                   420115022                2.600 ns/op                                                                                                                                                                                                                                                                                                                    
// Benchmark/runtime-8-12               291869521                3.903 ns/op                                                                                                                                                                                                                                                                                                                    
// Benchmark/maphash-16-12              72486172                16.24 ns/op                                                                                                                                                                                                                                                                                                                     
// Benchmark/fnv-16-12                  249103671                4.397 ns/op                                                                                                                                                                                                                                                                                                                    
// Benchmark/runtime-16-12              300819609                3.706 ns/op                                                                                                                                                                                                                                                                                                                    
// Benchmark/maphash-32-12              83406832                13.99 ns/op                                                                                                                                                                                                                                                                                                                     
// Benchmark/fnv-32-12                  140682667                8.300 ns/op                                                                                                                                                                                                                                                                                                                    
// Benchmark/runtime-32-12              292491626                4.171 ns/op                                                                                                                                                                                                                                                                                                                    
// Benchmark/maphash-64-12              72692757                16.07 ns/op                                                                                                                                                                                                                                                                                                                     
// Benchmark/fnv-64-12                  74951726                15.94 ns/op                                                                                                                                                                                                                                                                                                                     
// Benchmark/runtime-64-12              200250006                5.884 ns/op                                                                                                                                                                                                                                                                                                                    
// Benchmark/maphash-128-12             43835584                26.30 ns/op                                                                                                                                                                                                                                                                                                                     
// Benchmark/fnv-128-12                 33626848                35.25 ns/op                                                                                                                                                                                                                                                                                                                     
// Benchmark/runtime-128-12             131992580                8.546 ns/op                                                                                                                                                                                                                                                                                                                    
// Benchmark/maphash-256-12             24941272                48.08 ns/op                                                                                                                                                                                                                                                                                                                     
// Benchmark/fnv-256-12                 16829190                66.17 ns/op                                                                                                                                                                                                                                                                                                                     
// Benchmark/runtime-256-12             102915433               11.18 ns/op                                                                                                                                                                                                                                                                                                                     
// Benchmark/maphash-512-12             10526881                96.05 ns/op                                                                                                                                                                                                                                                                                                                     
// Benchmark/fnv-512-12                  9160648               127.0 ns/op                                                                                                                                                                                                                                                                                                                      
// Benchmark/runtime-512-12             64771675                18.82 ns/op                                                                                                                                                                                                                                                                                                                     
// Benchmark/maphash-1024-12             6152947               193.3 ns/op                                                                                                                                                                                                                                                                                                                      
// Benchmark/fnv-1024-12                 4535538               248.3 ns/op                                                                                                                                                                                                                                                                                                                      
// Benchmark/runtime-1024-12            35820849                33.13 ns/op                                                                                                                                                                                                                                                                                                                     
func Benchmark(b *testing.B) {                                                                                                                                                                                                                                                                                                                                                                  
        for size := 1; size <= 1024; size *= 2 {                                                                                                                                                                                                                                                                                                                                                
                buf := make([]byte, size)                                                                                                                                                                                                                                                                                                                                                       
                rand.New(rand.NewSource(0)).Read(buf)                                                                                                                                                                                                                                                                                                                                           
                s := string(buf)                                                                                                                                                                                                                                                                                                                                                                
                b.Run(fmt.Sprintf("maphash-%d", size), func(b *testing.B) {                                                                                                                                                                                                                                                                                                                     
                        for i := 0; i < b.N; i++ {                                                                                                                                                                                                                                                                                                                                              
                                maphashString(s)                                                                                                                                                                                                                                                                                                                                                
                        }                                                                                                                                                                                                                                                                                                                                                                       
                })                                                                                                                                                                                                                                                                                                                                                                              
                b.Run(fmt.Sprintf("fnv-%d", size), func(b *testing.B) {                                                                                                                                                                                                                                                                                                                         
                        for i := 0; i < b.N; i++ {                                                                                                                                                                                                                                                                                                                                              
                                fnvHashString(s)                                                                                                                                                                                                                                                                                                                                                
                        }                                                                                                                                                                                                                                                                                                                                                                       
                })                                                                                                                                                                                                                                                                                                                                                                              
                b.Run(fmt.Sprintf("runtime-%d", size), func(b *testing.B) {                                                                                                                                                                                                                                                                                                                     
                        for i := 0; i < b.N; i++ {                                                                                                                                                                                                                                                                                                                                              
                                runtimeHashString(s, 0)                                                                                                                                                                                                                                                                                                                                         
                        }                                                                                                                                                                                                                                                                                                                                                                       
                })                                                                                                                                                                                                                                                                                                                                                                              
        }                                                                                                                                                                                                                                                                                                                                                                                       
}                                                                                                                                                                                                                                                                                                                                                                                               
// maphashString computes the hash of a string using the maphash package,                                                                                                                                                                                                                                                                                                                       
// which is a wrapper around the implementation used by runtimeHashString.                                                                                                                                                                                                                                                                                                                      
func maphashString(s string) uint32 {                                                                                                                                                                                                                                                                                                                                                           
        var h maphash.Hash                                                                                                                                                                                                                                                                                                                                                                      
        h.SetSeed(seed)                                                                                                                                                                                                                                                                                                                                                                         
        h.WriteString(s)                                                                                                                                                                                                                                                                                                                                                                        
        sum := h.Sum64()                                                                                                                                                                                                                                                                                                                                                                        
        return uint32(sum>>32) ^ uint32(sum&0xFFFFFFFF)                                                                                                                                                                                                                                                                                                                                         
}                                                                                                                                                                                                                                                                                                                                                                                               
var seed = maphash.MakeSeed()                                                                                                                                                                                                                                                                                                                                                                   
// runtimeHashString computes the hash of a string using amd64 AESINC hardware.                                                                                                                                                                                                                                                                                                                 
//go:linkname runtimeHashString runtime.stringHash                                                                                                                                                                                                                                                                                                                                              
func runtimeHashString(s string, seed uintptr) uintptr                                                                                                                                                                                                                                                                                                                                          
// fnvHashString computes the FNV hash of s in software.                                                                                                                                                                                                                                                                                                                                        
func fnvHashString(s string) uint32 {                                                                                                                                                                                                                                                                                                                                                           
        var h uint32                                                                                                                                                                                                                                                                                                                                                                            
        for i := 0; i < len(s); i++ {                                                                                                                                                                                                                                                                                                                                                           
                h ^= uint32(s[i])                                                                                                                                                                                                                                                                                                                                                               
                h *= 16777619                                                                                                                                                                                                                                                                                                                                                                   
        }                                                                                                                                                                                                                                                                                                                                                                                       
        return h                                                                                                                                                                                                                                                                                                                                                                                
}                                                                                                                                                                                                                                                                                                                                                                                               
```                                                                                                                                                                                                                                                                                                                                                                                                
optim in. still think need new api make small write faster.
ran issu benchmark application.
here' worst case scenario:
```golang
func BenchmarkMaphash(b *testing.B) {
    var hash maphash.Hash
    var data [127]byte
    for i := 0; i < b.N; i += 1 {
        hash.Reset()
        hash.Write(data[:])
        hash.Sum64()
    }
}
```
27% time spent `write`, none hash take place. like mention earlier, due copi 127 byte buffer, hash comput `sum64` called. 53% time actual spent `rthash`; rest spent record keeping.
would propos ad `sum` method `seed`:
```golang
seed := maphash.MakeSeed()
sum := seed.Sum64(data)
```
imo fit api better function take `seed` argument.
propos would also make code readable.
before:
```golang
var seed = maphash.MakeSeed() // global
var hash maphash.Hash
hash.SetSeed(seed)
_, _ = hash.Write(data)
sum := hash.Sum64()
```
after:
```golang
var seed = maphash.MakeSeed() // global
sum := seed.Sum64(data)
```
context, hash set string unix timestamp (int64) use map key.
old code use sort strings, append together, use strconv build string key. new code use maphash hash string xor hash togeth (so order irrelevant). hash timestamp differ seed xor hash. 5x faster reduc service' cpu usag 5%.
use `unsafe` code ticket work great. however, fork `string` `int64` variants. cast `string` `[]byte` expens anticipated. best performance, would actual necessari expos type-specif hash function defin `src/runtime/alg.go`.
mayb someth like?
```golang
var nameSeed = maphash.MakeSeed()
var timeSeed = maphash.MakeSeed()
func myHash(names []string, timestamp int64) (sum uint64) {
  for _, name := range names {
    sum ^= nameSeed.HashString(name)
  }
  sum ^= timeSeed.HashInt64(timeSeed)
  return sum
}
```
current `maphash` api inadequ aforement buffer would requir name sorted.
peopl ping privat unhold per comment above, done.
chang mention issue: `hash/maphash: add bytessum64 stringsum64`
thank @josharian optim current api. look like got 2x, there' still 2x table. mail cl 392494 show 2x remains.
remain 2x gap seem fundamental, seem reason add new api.
hesit add method directli maphash.seed. seem like confus differ concepts. ad new concurrency-saf method maphash.hash confus hash share multipl goroutines. leav top-level functions, analog sha1.sum on, @dsnet origin suggested.
cl used:
func bytessum64(seed, []byte) uint64
func stringsum64(seed, string) uint64
thumb up/down: peopl think would better use
func bytes(seed, []byte) uint64
func string(seed, string) uint64
?
about?
```go
func Sum[Bytes interface{ []byte | string }](b Bytes) uint64
```
unclear gener make thing clearer case, know implement function body.
anyon object ad byte string describ
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
chang consensus, **accepted**. ðŸŽ‰
