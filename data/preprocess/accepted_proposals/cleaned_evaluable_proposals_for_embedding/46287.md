crypto/x509: use platform verifi windows, maco io
## background
crypto/x509 come pretti good chain builder verifier, doesnâ€™t ship root store, set root ca certif leaf certif need chain to. instead, x509.verifi either take explicit certpool, use â€œthe system rootsâ€.
â€œthe system rootsâ€ mostli lie (#39540). idea platform charg trust decisions, youâ€™d want go cli tool work like browser machin (includ trust â€œenterpriseâ€ develop roots). practic modern root store captur static list roots: mani addit rule â€œthi root sign certif end .frâ€ â€œthi root sign specif set certificatesâ€ â€œthi root sign certif log ctâ€. moreover, platform also space ca certif *not* trusted, use build chains.
current api leak idea system root list trust cas: x509.systemcertpool return certpool use verifi like certpool full custom certificates. visibl space custom logic untrust intermediates.
macos, go great length appli complex root store logic extract list certif uncondit trusted, invok security.framework apis. fickl complic logic (golang.org/cl/227037, #38888, #42414), prone security-relev errors, slow (#19561), memori intens (#26731), support reload (#41888, #35887), support untrust intermedi (#35631).
ios, donâ€™t access root store, hardcod copi it, best keep sync (#38843), even harder avoid memori usag issues.
windows, x509.systemcertpool support (#16736) verifi nil root invok platform verifi platform apis.
unix, isnâ€™t realli consist platform root store story, root mostli list certif find one mani somewhat arbitrari paths. logic find root kind grew organ improv (#38869), platform api better fit. platform verifier.
## propos
weâ€™d like move use platform verifi available, macos, ios, windows. verifi invok nil roots, pass rest verifyopt platform, return chain platform built, any. root set custom certpool, keep use chain builder.
order break exist code invok x509.systemcertpool add extra custom certif it, weâ€™ll verifi perform two verif case, one platform one custom roots, return chain both.
resolv load time issue, memori issue, risk mistak root extract code, need reload root store, lack support untrust intermediates, correctli appli custom platform logic.
## open question
### align
verif rule want appli regardless platform:
1. name constraint appli name certificate. critic verifyhostnam see leaf, need abl trust verifi return it, certif author claim names.
2. extend key usag valu enforc nest chain.
3. ip address certain invalid dn name supported, like verifyhostname.
platform verifi align rules, might hard compens it, rule influenc chain build itself.
### systemcertpool().subjects()
certpool return systemcertpool() placehold say â€œuse platform verifierâ€. doesnâ€™t work subject method, though, list root fact available.
two options: 1) keep complicated, slow, inaccurate, out-of-sync maco io code extract root use popul subjects, leav systemcertpool unsupport windows; 2) deprec subjects, make certpool fulli opaque.
(2) let us easili implement equal (#46057) copi (#35044), contain (#39179).
/cc @rolandshoemak @golang/secur
would *greatly* appreci use system verifi - _but requir use xcode linker_.
background comment: less x509, dn resolution. darwin builds, built linux containers, access system' resolver. platform, dn simpli /etc/resolv.conf - oper system complex set rule support rout dn queri domain differ services. tool built linux build farm end report problem like "host found" intern domains.
hate us repeat x509 well.
addit import use case break x509.systemcertpool, docker contain built scratch, singl go binary. suspect one who' learn bundl enterpris root apps.
> platform, dn simpli /etc/resolv.conf
like analog dns. arguably, "dn simpli /etc/resolv.conf" platform: (check second last diagram). x.509 handl similar complexity.
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
> would _greatly_ appreci use system verifi - _but requir use xcode linker_.
won't. use cgo-less link techniqu use get roots. actual surpris dn resolut doesn't, sinc link system intern releas now.
> addit import use case break x509.systemcertpool, docker contain built scratch, singl go binary. suspect one who' learn bundl enterpris root apps.
involv `x509.systemcertpool`? also, docker mostli run linux, scope proposal.
think cover concern alreadi (after reread propos times); particular:
>in order break exist code invok x509.systemcertpool add extra custom certif it, weâ€™ll verifi perform two verif case, one platform one custom roots, return chain both.
thank you.
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
chang consensus, **accepted**. ðŸŽ‰
