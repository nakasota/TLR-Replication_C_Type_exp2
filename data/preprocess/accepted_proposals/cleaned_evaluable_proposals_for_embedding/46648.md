go/types: add config.govers field set target languag version
compil type checker rewritten base `go/types` `cmd/compile/internal/types2`, certain compil featur port back `go/types`. one featur `types.config.goversion` field, configur target go version type checked, necessari `-lang` compil flag. issu propos export field `go/types` `types.config.goversion`. think could valuabl change, 100% confid make it, purpos propos hope start discuss get feedback.
specifically, `goversion` field could set valid go version string (e.g. `"go1.n"`) instruct type checker disallow languag featur ad go 1.n. note _wouldn't_ prevent import standard librari api ad go 1.n, except unsaf -- would domain importer.
may particularli relev larg number languag chang land generics. gener introduc larg chang type checker, incentiv tool break compat older go version leverag gener code.
gener alway user whose deploy target bound older go versions, varieti reasons. would good tool bound constraint. ad `types.config.goversion` field seem like necessari (though alway sufficient) mechan avoid coupling.
downsid see new api `go/types` continu support older version language. essenti alreadi case sinc want `go/types` `cmd/compile/internal/types2` stay sync (and mayb even converg areas). new languag featur definit additive, maintain support older version go usual simpl version check error message.
chang made casually, signal new model which, endorsed, support `go/*` packages. consensu good direct head, open similar issu `go/parser`, hold fragment discuss overal concept. curiou member tool commun think: univers good change? valuabl would be?
cc @dominikh @mvdan: know staticcheck gofumpt alreadi concept target version, perhap opinion change.
cc @griesem @mdempski
> may particularli relev larg number languag chang land generics. gener introduc larg chang type checker, incentiv tool break compat older go version leverag gener code.
understand `config.goversion` would chang impact tool use gener code.
> gener alway user whose deploy target bound older go versions, varieti reasons. would good tool bound constraint. ad types.config.govers field seem like necessari (though alway sufficient) mechan avoid coupling.
alreadi true go/typ process older version go code, backward incompat chang made language. see `config.goversion` would need support use case tool compil newer version go code tool oper on. think anyon reli tool tell code use new feature; peopl reli `go build` that.
@dominikh thanks, respons below.
> understand config.govers would chang impact tool use gener code.
may overli speculative, imagin scenario (say go 1.19 release) gener avail two major version (i hope!), staticcheck / gofumpt want start use code base. break gopl build, gopl team still want support develop go 1.15 still support appengin (disclaimer: special knowledg whether scenario could happen). case pin older gofumpt / staticcheck version order support build 1.15. clear, need build 1.15 want `type interfac { int }` type checker error.
> alreadi true go/typ process older version go code, backward incompat chang made language.
true _valid_ go code, may fine staticcheck fine gopls.
> think anyon reli tool tell code use new feature; peopl reli go build that.
disagre this, least interpret it. much reli editor tell this, way type checker errors.
however, point config.govers matter tool need work invalid go code. point, suspect tool gopls. would great gopl could support target go version, `types.config.goversion` one part puzzle.
envis futur abl thing like remov string(1) = "\x01" base go version.
also disallow newer thing older go versions, like 0b010101 avail go.mod say old version.
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
think make sense. tool author' perspect would perhap unfortun plumb "go version" mani librari like go/parser, go/types, go/packages, think reason path forward right now.
main reason gofumpt "go version" flag format chang would earli module. example, modul declar `go 1.13` later gofumpt encount `0666`, turn `0o666`, go version lower. pretti sure gofumpt command-lin tool would use go version api like go/parser, would good thing. right now, like say, simpli follow go version tool built with, peopl new, forc consid pin older versions.
one interest question kind flag would appli go/print go/format well, particularli major version go sometim chang "canon gofmt format" is. example, recent version go chang heurist break vertic align inlin go comments, mean older newer version gofmt (and tool use go/printer!) would incompat other' output.
anoth point bring name "target" might bit confus end users. maintain go modul support go 1.16.x 1.15.x time, want set `go 1.15` go.mod, `go 1.16`. similarly, config.govers 1.15. think peopl would call 1.16 "target" version 1.15 "minimum" version, akin java. talk good name version go.mod @bcmill @jayconrod @myitcv @rogpepp before, right recal end anywher github.
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
discuss extern tool call today. note follow-up thoughts:
regard @mvdan' point
- need better name version go.mod, purpos go/typ (and go/parser), think `goversion` unambiguous: languag featur ad version rejected. perhap could refer "compat version".
- version therefor control whether code accept go/pars go/types. think necessari configur version go/print go/format. `goversion` ad go/pars go/types, allow develop use tool built recent go versions, therefor latest behavior go/printer. dan point call, could get quit complex support multipl version format algorithms.
obvious work go/format reformat 0666 an 0o666, afaik go/format make type chang (and shouldn't). dan point `go fmt` add `//go:build` directives, least backward-compatible.
regard generics, @marwan-at-work point propos go/ast chang support gener (wip draft), would good mechan prevent go/pars produc new ast node types. could use protect tool panick case non-exhaust type switches, updat support generics. `goversion` configur option go/pars could serv mechanism.
chang consensus, **accepted**. ðŸŽ‰
