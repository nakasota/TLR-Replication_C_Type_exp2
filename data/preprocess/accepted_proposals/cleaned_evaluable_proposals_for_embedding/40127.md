encoding/json: add encoder.encodetoken method
current way decod json token-by-token, json packag support encod token way. state write token straightforward enough (citat needed), actual _that_ easi do.
here' code stream json input output: least 50 line code basic stream functionality, easi get wrong forget put colon comma right place, want indent html escaping, yourself.
propos add `encodetoken` method `json.encoder`:
```
// EncodeToken encodes a single JSON token to the encoder. The order of
// tokens must result in valid JSON syntax (as returned by the
// Decoder.Token method). That is, delimiters [ ] { } must be properly
// nested and matched, and object keys must be strings (but see the note
// on using Encode below).
//
// EncodeToken returns an error if the token cannot be encoded or is
// misplaced, for example because there's a delimiter mismatch, a
// non-string token is passed where an object key is expected, a string
// contains invalid UTF-8 or a Number isn’t formatted correctly.
//
// Note that it’s OK to mix calls to EncodeToken with calls to Encode.
// In particular, it’s also valid to call Encode when an object key is
// expected - in this case, the value is subject to the same conversion
// rules as for map keys.
func (enc *Encoder) EncodeToken(tok Token) error
```
would way produc syntact invalid output (other truncat output complet encod value). encod would keep track current state stack internally.
example: want stream larg array json objects, could do:
```
enc.EncodeToken(json.Delim('['))
for {
    enc.Encode(arrayItem)
}
enc.EncodeToken(json.Delim(']'))
```
slightli comprehens exampl
code stream set json valu would becom consider simpler:
## complet valid
might use provid caller final check encod valu fact complet (that is, final close token omitted). that, follow method could provided:
```
// ClosingToken returns the token necessary to close the current encoding object or array.
// It returns either Delim('}'), Delim(']'), or nil if there is no current object or array.
func (enc *Encoder) ClosingToken() Token
```
method make straightforward check object complet (`if env.closingtoken == nil`), also could use saniti check developing, better errors, implement flush method automat close open object arrays:
 ```
for enc.ClosingToken() != nil {
    enc.EncodeToken(enc.ClosingToken())
}
```
## discuss
current `decoder.token` implementation, `encoder.encodetoken` particularli efficient, requir pass string number string insid interfac value. think consid orthogon issue: solut `decoder.token` garbag issu may also appli `decoder.token`. symmetri `decoder.token` `encoder.encodetoken` use properti make api easier explain use, shouldn’t discard lightly, view.
`encoder.encode` invoked, there’ way return stream mode, exampl encod larg array within `marshaljson` method. limit `json.marshaler` interface, could potenti address fix area.
would _almost_ possibl implement without ad method chang `encode` method recogn `delim`. however, it’ current valid pass `delim` valu encod (it encod number), would break backward compatibility. also, it’ arguabl cleaner separ low level token api higher level encod api.
## relat propos

encodetoken seem like nice analog decoder.token.
less convinc closingtoken. program know syntax come next, busi encod json token token?
thank review!
> less convinc closingtoken. program know syntax come next, busi encod json token token?
deepli attach `closingtoken` either. tri think might happen api use across modules. program _should_ alway produc valid syntax, perhap compon produc invalid token check error. thought would nice abl assur json encod valid without pars whole thing again. initi thought `complete() bool` method, error messag produc return fals inform - would better, think, say someth _how_ incomplete, idea came `closingtoken` provid functionality, would trivial implement might possibl use too.
what' expect flush behavior feature? expect everi call `encoder.encodetoken` result least one `write` call underli `io.writer`?
see sever reason semantics:
1. everi call `encoder.encodetoken` result data immedi written underli `io.writer`. however, would signific perform implic semantic.
2. `encoder.encodetoken` flush underli `io.writer` whenev intern buffer get suffici full. order ensur data fulli flushed, provid `encoder.flush` method.
3. `encoder.encodetoken` flush underli `io.writer` whenev intern buffer get suffici full top-level json valu complet encoded. example, encod follow sequenc tokens: `[`, `"foo"`, `1`, `null`, `]` would flush final `]`, mark end top-level json array.
opinion, think option 3 reasonable. requir new api, decent performance. track whether top-level valu complet logic `encoder` anyways.
also vote option 3. structur log log record typic top-level json object flush object nice properties.
also agre option 3 seem like right approach, although might also use provid explicit flush method.
seem like peopl gener favor (if accepted, would go 1.17). right?
okay api, like saniti check behavior `numbers`.
document current says:
> encodetoken return error ... number isn’t format correctly.
sinc `number` constructor `json` package, leav format number user. obviou function use would `strconv.formatfloat`. think import properti `strconv.formatfloat` used, format number guarante valid json number.
seem that:
* `e`, `e`, `f`, `g`, `g` format flag alway produc output valid json number. (technically, go' grammar floating-point number express json' grammar, seem `strconv.formatfloat` implement way compatible; e.g. lead zero least one digit decim point).
* except `nan` `infinity`, think accept valu result encod error alreadi (i.e., `json.marshal(math.nan())` report error today).
correct?
@dsnet that' good call. _think_ right, would good definit assur (and could mention formatfloat doc too).
yes, strconv.formatfloat produc valid json finit numbers, except perhap use prec=0 'f'.
base discuss above, seem like **like accept**.
chang consensus, accepted.
appetit chang function name prevent stutter? see `encoder.token()` maintain consist `decoder.token()` possibl alreadi alreadi defin exported. suggest contextu appropri altern time.
chang mention issue: `encoding/json: add encoder.encodetoken method`
hi all, kick discuss possibl "encoding/json/v2" packag address spirit proposal.
see "encod decoder" section discussion. `encoder.writetoken` method implement propos ask for.
