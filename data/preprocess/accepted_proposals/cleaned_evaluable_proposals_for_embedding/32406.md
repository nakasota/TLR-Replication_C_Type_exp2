crypto/tls: add (*tls.conn).handshakecontext add context clienthelloinfo certificaterequestinfo
## propos
propos unexport `context.context` field ad `clienthelloinfo` `certificaterequestinfo` `crypto/tls` types. also add `context() context.context` method type access context. further, add new method, `handshakecontext(context.context) error` `tls.conn` struct, use propag context handshak call stack. exist `handshake() error` would call new method `context.background()` context.
standard librari use `(*tls.conn).handshake()` move new method, appropriate. example, clear appropri chang exist `read` `write` method `*tls.conn` use new handshak method, `(*net/http.server).serve`, clear move new function would enhanc request lifetim control function.
`context.context` provid `handshakecontext` would use cancel handshak itself, handshak completed, cancel context effect. line predec set `(*net.dialer).dialcontext`.
## motiv
recent go releases, abl use handi `getcertificate` `getclientcertificate` method `*tls.config` dynam control certif manag go apps. fantastic, lead thing like somewhat uniqu go ecosystem.
unfortunately, one glare omiss api connect context cancel request scope variabl propagation. mean user implement custom timeout block tl connect forev case problems. also mean power observ tool like trace metric make use context cannot used.
## interact net/http
`net/http.server` provid `basecontext`, use set global context durat `(*http.server).serve`, `conncontext`, use everi new connection. context pass `(*tls.conn).handshakecontext` would necessarili child contexts, exist `handshake` call made context created. see
* basecontext use
* conncontext use
* *tls.conn first test
would help could elabor variou use cases: tri situation, work moment, context would help.
past want surfac detail clienthelloinfo net/http handlers, see use case, like build gener solution.
use case specif allow librari (`certify`) cancel outgo request incom connect closed. additionally, would allow detail trace captur latenc cost dynam provis tl certificates, someth current hidden insid tl handshak time standard library. simpli context associ underli connect could use outgo `net/http` request would enough.
@johanbrandhorst, sound like good reasons. reason add context struct field net/http.request use method instead, instead add context method crypto/tls.clienthelloinfo.
ok, attempt implement this.
tag need updating?
chang mention issue: `crypto/tls, net/http: add context tl structs`
sinc tree recent open again, bump anoth look initi implementation. could tag 1.14? think propos accept
@bradfitz @filosottil could pleas clarifi whether propos accepted? so, mileston 1.14 review cl.
look like stuck crypto propos review queue. @filosottil own meeting.
friendli ping this. @filosottil updat this?
friendli ping.
friendli ping. @filosottil anyth help crypto propos review queue?
friendliest bumps.
1.14 out, plan review crypto proposals?
@johanbrandhorst, crypto propos review proceed fairli well (see crypto propos minut many.
ping @filosottil @katiehockman.
hey, sorri delay, one fell radar.
anoth common problem would nice solv time propag info callback net/http handlers. mayb expos context also connectionst would work, expos request.tls? net/http request context child tl one? (how would work server.basecontext server.conncontext?)
anoth reason expos connectionst new verifyconnect callback get connectionst input. callback cover clienthelloinfo certificaterequestinfo.
get full api propos issue, along detail would interact net/http?
thank loop back @filosottile, updat first post full api proposal. support pass data back via context read only. would need make context export field support this, argu open discuss solutions, chang context export field.
thoughts?
tl context need child conncontext, happen? can't see way crypto/tl reach conncontext, net/http set tl context.
unfortun design lot api context, could use advic (mayb @bcmills?) proposal.
expert net/http server stretch, thought could assign here: `ctx` inherit conncontext `*tls.conn`.
assign how? propos expos way set context.
ah, good point, would expos someth like withcontext assign context conn.
updat proposal.
ad `(*crypto/tls.conn).withcontext` method descript proposal.
ping @filosottil @katiehockman
talk @filosottile.
http.request.withcontext return deriv http.request context. callback tri use, there' way return _new_ tls.conn, tls.conn.withcontext _setter_ - mutat receiv instead return deriv copy.
least proposal, withcontext name setcontext.
problem first setcontext standard library, unclear that' right path go down.
/cc @bcmill @sajmani
agre analysi setcontext would set potenti danger precedent. re-examin problem see there' better way merg http context tl connection.
updat propos chang use `setcontext` method instead creat new `handshakecontext` method `tls.conn`. method would use propag context call stack `getclientcertificate` `getcertificate` callbacks. ptal.
chang mention issue: `do review: crypto/tls: add handshakecontext method conn`
took stab would look like here: forgiv inappropri make sort experiment chang propos accepted.
admit bit confus handshakecontext would use cl.
expect mayb new callback return context.
would client use handshakecontext instead old callback look like?
