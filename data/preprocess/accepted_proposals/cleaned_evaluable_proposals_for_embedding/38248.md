cmd/compile: replac callimport go:wasmimport direct
wasm architectur current use special `callimport` assembl instruct call function imports. approach quit inflex compat abi use wasm_exec.js.
webassembl ecosystem converg use wasi (webassembl system interface) standard interfac webassembl binari host (similar system calls). work ad support wasi go. first step, go need abl use function import abi use wasi.
reason propos replac `callimport` new compil direct `go:wasmimport`. use like this:
```go
//go:wasmimport __wasi_proc_exit wasi_unstable proc_exit
func __wasi_proc_exit(code int32)
```
default `go:wasmimport` use abi use wasi. option paramet use backward compat `wasm_exec.js`. paramet call `abi0` `wasm_exec.js` read paramet form memori go' normal abi0 layout:
```go
//go:wasmimport wasmExit go runtime.wasmExit abi0
func wasmExit(code int32)
```
plan add abis. contrary, `abi0` mode suppos go away wasi use primari interfac (it still miss certain features).
`go:wasmimport` direct cover go' compat promis long wasm architectur consid stable.
confus two differ abi also option not. would nice option field last, middl list. tell thing mean look argument count - know "go" appar magic word arg[2] real arg[2].
could pleas write suggest doc describ syntax full? mayb rotat option word end? would even better two differ option abi words. reduc one?
right, forgot includ clear explan argument directive. usag like this:
```go
//go:wasmimport localname importmodule importname [abi0]
```
`localname` name go function, `//go:linkname`.
`importmodule` `importname` identifi function import. webassembl function alway live within module. wasi modul current call `wasi_unstable`, see here. wasm_exec.j call `go`, see
`[abi0]` option flag indic import use abi0 way pass arguments.
hope helps.
//go:linknam kind odd one compil direct (see go doc compile) implicitli appli next function declaration. instead ad anoth like that, would probabl better attach function implicitly, like other (example: //go:noinline).
instead of:
```
//go:wasmimport wasmExit go runtime.wasmExit abi0
func wasmExit(code int32)
```

```
//go:wasmimport go runtime.wasmExit abi0
func wasmExit(code int32)
```
alway function declar attach to?
syntax would to:
//go:wasmimport importmodul importnam [abi0]
skeptic expos name abi0. default like go code, mayb use [wasi] option mode? mayb importmodul go, assum go abi?
still feel like simplif possibl here.
fulli agre version without `localname` would better. fact initi plan.
however, current direct appli next function flag without parameters. get process `pragmavalue` function lex.go return type `type pragma uint16`. argument possible.
opt larg chang go' lexer/pars instead copi solut alreadi exists: `//go:linkname`.
abi flag: default abi wasi uses, sinc nativ way pass argument webassembl function. `abi0` flag need exist chang everyth massiv cl. way still support abi wasm_exec.j use slowli migrat wasi. special case importmodul `go` possible, sure, implicit behavior chang seem bad me.
> however, current direct appli next function flag without parameters. get process pragmavalu function lex.go return type type pragma uint16. argument possible.
true coupl week ago longer true (i chang that, prepar possibl `//go:` directives). let' make propos want, appli next function. happi work off-issu need help make work.
abi flag. problem `abi0` yet expos name realli plan to. would rather refer `go` abi. seem kind redund say `go` importmodul use `go` abi. importmodul use abi?
also littl confus "the abi0 flag need exist chang everyth massiv cl." sinc `//go:wasmimport` direct exist today.
@neelanc case long term _nothing_ say `abi0`? is, futur go releas _removes_ support `abi0` annotation?
/cc @aclement feel expos name `abi0` here?
> let' make propos want, appli next function.
great!
> importmodul use abi?
not.
> case long term noth say abi0? is, futur go releas remov support abi0 annotation?
yes, that' long term plan, can't say case. depend lot fast develop wasi goe enough featur complet replac custom interfac wasm_exec.j current uses.
mind pick differ flag name `abi0`. make implicit name importmodul feel bit bad me, strongli oppos either.
actual fine expos name abi0. intent call abi0 abiintern could expos name "abi0" ever froze another, faster abi abi1. sure want spell "abi0" "abi0" given initialism.
however, actual seem reason assum everyth "go" modul follow "go abi" omit abi directive. understand correctly, effect "closed" modul wasm_exec.js' export user can't defin new abi0 interfac either modul module, set thing use abi0 fix bound exactli "go" module.
right, agre good discourag anyon els use abi0 expos less. shall edit propos first post add new version below?
@neelance, pleas add new comment below, easier see history. thanks.
new full propos text:
---
wasm architectur current use special `callimport` assembl instruct call function imports. approach quit inflex compat abi use wasm_exec.js.
webassembl ecosystem converg use wasi (webassembl system interface) standard interfac webassembl binari host (similar system calls). work ad support wasi go. first step, go need abl use function import abi use wasi.
reason propos replac `callimport` new compil direct `go:wasmimport`. use like this:
```go
//go:wasmimport importmodule importname
```
concret example:
```go
//go:wasmimport wasi_unstable proc_exit
func __wasi_proc_exit(code int32)
```
`importmodule` `importname` identifi function import. webassembl function alway live within module. wasi modul current call `wasi_unstable`, see here. wasm_exec.j call `go`, see
default `go:wasmimport` use abi use wasi. special case backward compat `wasm_exec.js`: `importmodule` `go`, argument get pass way `wasm_exec.js` read memori go' abi0 layout. special case remov interfac `wasm_exec.js` fulli supersed wasi (current still miss certain features).
`go:wasmimport` direct cover go' compat promis long wasm architectur consid stable.
tinygo side, fulli support proposal. right use someth like (follow example):
```go
//go:wasm-module wasi_unstable
//export proc_exit
func __wasi_proc_exit(code int32)
```
work stopgap, propos accept make sure tinygo switch new format.
one comment:
> default `go:wasmimport` use abi use wasi.
abi? specifi somewhere? seem realli c abi so, think specifi such. relat discussions:
*
*
lowest level abi consist pass data via argument (on webassembl stack) webassembly' `call` instruction. may higher level addit future, standard way pass strings, current seem still development. "abi use wasi" realli mean whatev wasi right future.
> lowest level abi consist pass data via argument (on webassembl stack) webassembly' `call` instruction.
nitpick: abi much call convention! also involv struct layout, alignment, etc. (relev pass pointer around).
general, use facil wasi (e.g. `-buildmode=c-shared`) think import specifi thing wasi specify. example, wasi abi pass struct reference, sidestep issu whether small struct may pass directli (virtual) regist instead stack. go pick side here. therefor would suggest investig abi use clang rust follow that.
goal `go:wasmimport` support wasi whatev wasi need future. think reasonable, wasi set certain standard webassembl ecosystem pass data webassembl modules. may includ aspect call convention.
want defin "webassembl interfac go" here, sinc believ earli go rather follow webassembl ecosystem (name wasi) diverg interface. concern peopl use interface, would okay restrict `go:wasmimport` `runtime` `syscall/js` packages. peopl realli want experi contexts, would need patch go compil first.
everyon seem favor converg on. thank good discussion.
base discussion, seem like **like accept**.
sorri late.
`go:wasmimport` work arbitrari modul functions, list special functions?
bit bikeshedding: "go" best name wasm_exec.js? go code side, everyth go _except_ import functions. true modul current name "go", chang that. mayb "jsgo" "gojs"?
> go:wasmimport work arbitrari modul functions, list special functions?
list. paramet type need supported. like said above, would okay restrict `runtime` `syscall/js` peopl worri usag outsid go project itself.
> bit bikeshedding: "go" best name wasm_exec.js?
fine chang name. prefer end.
repli previou two comments:
- certainli seem reason start restrict `go:wasmimport` runtim syscall/js, make sure time correct mistakes.
- @cherrymui suggest chang importmodul field `go` `jsgo` `gojs`. @neelanc said fine either way. opinions? restrict `go:wasmimport` runtim syscall/js, easili changed.
leav like accept anoth week seem converged.
thanks. also think reason start restrict runtim syscall/js. make gener later necessary.
chang consensus, accepted.
chang mention issue: `[dev.link] implement wasmimport directive`
chang mention issue: `[dev.link] implement wasmimport directive`
chang mention issue: `[dev.link] implement wasmimport directive`
wonder, exports? start patch quit trivial implement `go:wasmexport` direct like:
```
//go:wasmexport myExportedFunc
func myExportedFunc() {}
```
might first step toward
take care file pr it, alreadi prototyp machin
@slinkydevelop see issue, addit `//go:wasmimport` discuss propos first. probabl file propos `//go:wasmexport`, too.
@neelanc think pretti much cover it, sure open anoth issu
#25612 proper proposal, sinc lot aspect intend behavior clear. see difficulti around `//go:wasmexport` goroutines, look forward discuss could solv these. proper place discuss proposal.
@neelanc fill questions, look forward address them.
chang mention issue: `all: implement wasmimport directive`
@rsc @cherrymui new go abi chang (not sure that' right term) affect proposal? work version propos abi changes, look there' signific chang past months.
