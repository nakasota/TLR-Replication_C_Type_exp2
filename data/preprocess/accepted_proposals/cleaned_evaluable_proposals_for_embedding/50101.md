net: make lookupcnam consist unix windows, document
lookupcnam pretti weird right now.
despit name, entir ignor cname record unix. launch `a` `aaaa` record lookup recurs resolv return first respons name found `a` `aaaa`, skip `cname`. (and even ask `cname`)
document that...

> canon name final name follow zero cname records. lookupcnam return error host contain dn "cname" records, long host resolv address records.
otoh, windows, would expect name itself: look cname records:
```go
func (*Resolver) lookupCNAME(ctx context.Context, name string) (string, error) {
        // TODO(bradfitz): finish ctx plumbing. Nothing currently depends on this.
        acquireThread()
        defer releaseThread()
        var r *syscall.DNSRecord
        e := syscall.DnsQuery(name, syscall.DNS_TYPE_CNAME, 0, nil, &r, nil)
```
here' demo program behav differently:
```go
func main() {
	txt, err := net.LookupTXT("cname-to-txt.go4.org")
	log.Printf("LookupTXT = %q, %v", txt, err)
	cname, err := net.LookupCNAME("cname-to-txt.go4.org")
	log.Printf("cname = %q, %v", cname, err)
}
```
linux/mac:
```
2021/12/10 21:19:45 LookupTXT = ["foo=bar"], <nil>
2021/12/10 21:19:45 cname = "", lookup cname-to-txt.go4.org: no such host
```
windows:
```
2021/12/10 21:11:45 LookupTXT = ["foo=bar"], <nil>
2021/12/10 21:11:45 cname = "test-txt-record.go4.org.", <nil>
```
like window behavior better, fwiw. that' look for, appar exist.
either:
1. add `lookupcnamerecord` actual look cname record
2. redefin `lookupcname` like windows, perhap ad `lookupcanonicalname` current weird unix behavior `lookupcname`?
minimum: document whatev rule make unix window match? least `resolver.prefergo` mode?
think lookupcnam came way use getaddrinfo, return underli name almost side effect lookup, res.ai_canonname. stop use glibc call make match windows? might make fail succeed before? sure.
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
problem need use getaddrinfo(ai_canonname) macs, port 53 block non-libc code. way make getaddrinfo succeed host cname record name host a/aaaa records? not, hard implement window lookupcnam behavior system like macs.
look like even though man pages, maco may res_ninit. mayb look use place getaddrinfo(ai_canonname). that' possible, would seem ok chang this.
specif case chang name cname a/aaaa record, current error unix succe windows. change, would succeed everywher (unusual) case.
anyon want look hard would make go code use libresolv mac? might also help thing like mx lookups.
sound like still wait someon check done mac.
@bradfitz say cl net got roll back use libresolv directly. problem use res_init instead res_ninit, latter undocu (but appar present). relev issu #12524. perhap someon want tri resurrect cl use thread-saf apis? also related: #16345 #31705. rollback
hold anyon want tri implement new behavior mac.
**place hold**.
â€” rsc propos review group
hack someth seem work macos. clean mail next week.
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
clean yet, certainli seem work pass brad' test txt record.
anyon object chang lookupcnam succeed host cname record unix, like alreadi windows?
seen use get local machine' fqdn, pass result os.hostnam lookupcnam let resolv worri search domain not. seem exactli kind thing reli lookupcnam essenti behav like gai' ai_canonname.
quick search surfac packag github.com/showmax/go-fqdn that. fall back method lookupcnam work reli properli configur ptr record (or explicit /etc/host entries).
chang lookupcnam cname records, would prefer "canon name" behaviour avail way.
sorry, understand. realiz ai_canonnam meant anyth 'do cname lookup'.
circumst ai_canonnam consult someth cname records, consult?
invok getaddrinfo name "host" ai_canonnam ai_flag otherwis zero hint structur (mean af_unspec) follow (at least glibc):
- consult /etc/resolv.conf get name server search domain
- configur search domain *d*, well aaaa queri host.*$d*
- return name sucess respons caller ai_canonnam [**edit**: first name found return caller]
that' "file dns" list nsswitch.conf. anyone' guess might nss modules.
linux man page describ behaviour as:
> hints.ai_flag includ ai_canonnam flag, ai_canonnam field first addrinfo structur return list set point offici name host.
guess "offici name" meant refer host' fqdn here.
@slrz ok, sound like differ host a/aaaa record cname, 'google.com'.
lookupcname("google.com") = "google.com", nil, least unix.
probabl window lookupcname("google.com") error actual look cname records.
behavior differ get at?
normal tri hard avoid behavior changes, case hard see would break given window never behav way unix does, make window behavior standard one.
two possibl options.
1. make lookupcnam everywher match lookupcnam window today, mean look cname record that' it.
2. make lookupcnam match combin unix windows, look cname record also fall back return input string (like "google.com") name a/aaaa record cname.
given rest api, thing like lookupmx, think everyon expect lookupcnam mean (1) today. certainli did. seem like least tri go path, find (2), least know why.
mayb could get code (1) readi land start go 1.20 cycl see far get?
anyon object this? anyon know _must_ (2)?
> @slrz ok, sound like differ host a/aaaa record cname, 'google.com'. lookupcname("google.com") = "google.com", nil, least unix. probabl window lookupcname("google.com") error actual look cname records. behavior differ get at?
exactly, importantli also `lookupcname("amsterdam") = "amsterdam.example.com.", nil` invok system example.com dn search list.
> normal tri hard avoid behavior changes, case hard see would break given window never behav way unix does, make window behavior standard one.
besid "go-fqdn" librari link above, know least one program *will* broken chang behaviour. companion program server part video conferenc system run linux anyway (bigbluebutton), current window behaviour relevant. usag like go-fqdn lookupcname("amsterdam") exampl above: invok lookupcnam result os.hostnam part attempt mimic `hostnam -f`.
say unfix good idea, break before.
> 2. make lookupcnam match combin unix windows, look cname record also fall back return input string (like "google.com") name a/aaaa record cname.
return input string sufficient: caller gener tri mimic `hostnam -f` dn search list handl consult host alias /etc/host that' required.
> exactly, importantli also lookupcname("amsterdam") = "amsterdam.example.com.", nil invok system example.com dn search list.
definit someth want break. thanks.
want make lookupcnam much possibl linux window without break exist uses, look like could cname lookup (includ ad dn search suffixes), work done, otherwis fall back a/aaaa lookup, works, return name record. linux would mean ad explicit cname lookup, window would mean ad a/aaaa fallback.
could separ add `strictcnam bool` field net.resolv make resolver.lookupcnam mean cname lookup.
sound reasonable?
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
chang consensus, **accepted**. ðŸŽ‰
