runtime/pprof: newcpuprofil + cpuprofile.start allow profil configur
> think setcpuprofiler is, albeit confusing, still functioning. need call right order startcpuprofile. last time look (~a month ago), probabl print warnings, chang rate.
>
> pprof packag seem way set profil rate. sure realli use feature.
_origin post @cherrymui
pprof packag inde allow us custom cpu profil rate moment. someth critic applic sinc default profil rate 100 extrem low allow see anyth cpu profile.
work around this, make call `runtime.setcpuprofilerate(800)` (with rate around 800 hz see someth meaning help cpu profile) call `pprof.startcpuprofile`. sinc hard-cod call `runtime.setcpuprofilerate(100)` insid `pprof.startcpuprofile`, warn print termin moment say "runtime: cannot set cpu profil rate previou profil finished" call `runtime.setcpuprofilerate(100)` fail (the boolean `cpuprof.on` alreadi set true previou call `runtime.setcpuprofilerate(800)`). warn annoy sinc mislead someon know intern `pprof.startcpuprofile`, import cpu profil done first profil rate manual set (800, want want user point view).
given this, tri say public/export method **`runtime.setcpuprofilerate`** still useful, sometim even critic allow us use well `pprof` see someth relev profiles, depend application. alon see (stack overflow) (googl group discussion). even one princip softwar engin (l8) work googl found use review pr copi code use one applications, set higher profil rate critic well.
said, believ could, on, follow three differ paths:
1. ideal would **`pprof.startcpuprofile`** method **alreadi receiv argument cpu profil rate** want, allow us custom it, argument default valu set 100 specifi function call. would ideal, support default argument go. but, achiev someth similar similar method signatur `pprof.startcpuprofilewithspecifiedrate(w io.writer, hz int)`, addit `pprof.startcpuprofile(w io.writer)` method alreadi have. way, `runtime.setcpuprofilerate` method would necessarili need export method anymore.
2. could **keep `runtime.setcpuprofilerate` public/exported**, would fix problem mislead warn messag "runtime: cannot set cpu profil rate previou profil finished" alreadi manual set profil rate call `pprof.startcpuprofile`. could:
2.1. auxiliar boolean method `runtime.iscpuprofileratealreadyset`, call insid `pprof.startcpuprofile` hard-cod call `runtime.setcpuprofilerate(100)` there, tri set profil rate 100 rate alreadi previous set. way, would see strang warn call `pprof.startcpuprofile` alreadi previous set profil rate manually. like solut make minim chang code, chang signatur resolv exactli problem tri solv here, keep warn messag call `runtime.setcpuprofilerate` `pprof.startcpuprofile` situat above.
2.2. make `runtime.setcpuprofilerate` return error case profil rate alreadi previous set, allow caller handl decid (insid `pprof.startcpuprofile` could ignor error example). would chang signatur `runtime.setcpuprofilerate`.
3. could **move `setcpuprofilerate`** public signatur **to `pprof` package** (with chang explain avoid mislead warn message), deprec / make unexport insid `runtime` package.
altern thought now. would like hear think suggest fix explain above.
chang mention issue: `runtime/pprof: method startcpuprofil add paramet allow custom cpu rate.`
add method `startcpuprofilewithspecifiedrate` issue? @ianlancetaylor
think best name, but, yes, someth along line could work.
ok, let think
chang mention issue: `runtime/pprof: method startcpuprofil add paramet allow custom cpu rate.`
turn issu propos api change.
@ianlancetaylor thank turn proposal.
current propos specif `startcpuprofilewithrate`. decid add addit api, come version that' flexibl enough extens future? far rememb coupl api chang request reject put hold desir avoid api changes.
1) pmu-bas profiling: seem one main blocker propos current api chang (in addit implement details). propos origin propos `pprof.startcpuprofilewithconfig`.
2) symbolization: propos option skip symbol `pprof` tool may way perform addit symbol band.
3) differ polici profil rate setup: exampl issu @rhysh report ( made wonder may end complet differ cpu profil polici futur requir beyond simpl `hz` adjustment. example, user may want tri per-thread timer ( runtim supports. user may want adjust profil rate base gomaxproc (
@hyangah sound like suggest kind
cpu := pprof.newcpuprofile()
... configur prof ...
cpu.start()
even
cpu := new(pprof.cpuprofile)
...
cpu.start()
?
sound like mayb interfac previou messag answer want solv problem.
need solv problem? often peopl need profil rate 100 hz?
full stack trace make profil event bit expensive, want peopl set rate high complain overhead.
@rsc choos right profil rate hard. mani theori differ opinion around choos right valu - talk lockstep sampl issue, #35057 discuss scale frequenc base system' capabl 100hz sometim high, @rogerlucena want higher 100hz (asid whether 800 hz reason not). look paramet peopl still want experi tune.
> need solv problem? often peopl need profil rate 100 hz?
@rsc applic crucial set sampl rate higher 100 hz see someth use profil output, explain detail issu descript above. apart that, descript also referenc peopl custom sampl rate still useful: stack overflow googl group discussion.
ok, well sound like api earlier comment, introduc idea configurable-because-not-yet-run project, would good rate mayb also leav open way handl thing like kind perform counters.

right? retitl see peopl think.
> right? retitl see peopl think.
@rsc lgtm.
base discuss above, seem like **like accept**.
(newcpuprofil + cpuprofile.setr + cpuprofile.start).
chang consensus, **accepted**. ðŸŽ‰
