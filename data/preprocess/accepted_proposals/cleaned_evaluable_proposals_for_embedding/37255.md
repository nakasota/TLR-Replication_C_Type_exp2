os/signal: add notifycontext function
previous discuss issu #21521 #16472, sever place handl posix signal context seem somewhat use (and littl bit hard correctly?), would like propos way handl ad new signal.withcontext function.
there' also idea improv current approach handl signal (see give tri yet, unfortunately. found earlier propos tri write code, decid creat new issu anyway share idea.
peopl use sort talk subject:
* (packag wrote ago)
* (thread)
* (thread)
* make ctrl+c cancel context.context (blog post)
*
*
*
* list 18 packag thing.
chang mention issue: `os/signal: add withcontext control singl usag signal easily.`
also pleas notic chang would, unfortunately, requir introduc packag time context depend packag os/signal.
could describ new function issue, figur cl? thanks.
new function receiv parent context variad number signal use cancel context. parent context cancel one signal handled, context canceled.
exampl handl cancel slow process sigterm sigint:
```go
func main() {
	ctx, cancel := signal.WithContext(context.Background(), syscall.SIGTERM, syscall.SIGINT)
	defer cancel()
	// ...
	slow.Run(ctx)
	cancel()
	// to verify if the slow function was terminated by a signal, we can use:
	var sigErr signal.ContextError
	if errors.As(ctx.Err(), &sigErr) {
		fmt.Printf("slow function terminated by signal %q\n")
	}
}
```
anoth side, exampl shown that, opinion, would simplifi this.
perhap function context packag instead, sinc creat context pretti much contexts.
ctx, cancel := context.signal(context.background(), syscall.sigterm, syscall.sigint)
sure right idea all, throw there.
sever packag handl signal, runtim handl context equally, context.sign work correctly, think. runtim handl them, `context.signals` best way . os/sign packag potenti feel us use applications, context packag use everyone. think `signal.withcontext` better sinc make user known one place. (but also sure right idea)
clear, runtim alreadi broadcast signal anyon sign hear them, use signal.notify. could done separ packag without worri possibl use os/signal.
context.withcancelsign seem like clearest name, would appear right next context.withcancel docs.
/cc @sajmani thought
sound like mayb converg `context.withcancelsignal`. retitled.
base discuss above, seem like **like accept**.
great! thank feedback. tri send new cl propos implement `context.withcancelsignal` command monday.
plan would documented? signal process scoped, librari use featur could problematic. server would normal catch signal main level propag down, easily/lazili done alreadi cancel singl parent context. use signal local task cancel seem suit interact apps. that' controversial, could made clear docs?
push new implement
note current accord go/build/deps_test.go context depend
{"errors", "internal/reflectlite", "sync", "sync/atomic", "time"}
go add depend context os os/signal, pull lot more. know matter much, seem worth mentioning. anybodi concern addit dependencies?
worri too, look full list add much transitively. current tree:
```
% deps io os os/signal | sort -u
errors
internal/bytealg
internal/cpu
internal/oserror
internal/poll
internal/race
internal/reflectlite
internal/syscall/execenv
internal/syscall/unix
internal/testlog
io
os
runtime
runtime/internal/atomic
runtime/internal/math
runtime/internal/sys
sync
sync/atomic
syscall
time
unsafe
% deps context
errors
internal/bytealg
internal/cpu
internal/oserror
internal/race
internal/reflectlite
runtime
runtime/internal/atomic
runtime/internal/math
runtime/internal/sys
sync
sync/atomic
syscall
time
unsafe
%
```
addit would `io` `os` themselves, three internals:`internal/syscall/{unix,execenv}` `internal/testlog`.
say happi this, arguabl ok.
receiv signal goroutin context.withcancelsignal, wonder work.
```
package main
import (
	"context"
	"os"
	"os/signal"
	"time"
)
func doSomething(ctx context.Context) {
	// ...
}
func main() {
	s := make(chan os.Signal, 1)
	signal.Notify(s, os.Interrupt)
	ctx := context.WithCancelSignal(s)
	doSomething(ctx)
	go func() {
		<-s
		println("interrupted")
	}()
	var b [1]byte
	os.Stdin.Read(b[:])
	time.Sleep(time.Second)
	println("exit")
}
```
one possibl avoid ad depend os os/sign context packag reach runtim packag os/sign packag alreadi does. one consider depend os/sign packag os/sign packag init function slightli chang runtim packag handl signals. might abl get rid anyhow.
@mattn propos `context.withcancelsignal` function take signal argument, channel.
assum meant pass `os.interrupt` `context.withcancelsignal`, receipt signal 1) context would canceled; 2) signal would sent channel `s`.
oh, see.
worri number chang signal packag too. take look runtim packag friday see understand @ianlancetaylor' idea see come something.
fwiw, think easili hook runtim packag directli (with intern packag needed) bypass os os/signal, keep dep lite. gener trend avoid os possible, code need runtime.
chang consensu here, accepted.
fwiw put signal-rel behaviour `context` packag feel wrong me. current function context packag entir context time. clean delimit api. however, signal system-specif concept. inclus `syscall` public api make quit clear. `context.withcancelsignal` read nice name, admit, feel like mix concern inappropri me, would much prefer function go signal packag itself.
think may also concern implement go run limit infrastructure. exampl tinygo, `context` packag current avail `os/signal` packag not. ad function `context` would mean `context` api could implement platform.
agree. domain expert seem model break go on.
thanks, @rogpeppe. concern sound solid me.
perhap inde go signal packag (or mayb issu besid feel unnatural)?
thoughts? /cc @deadprogram
@rsc disagr aros propos move like accept accepted. move back propos stage?
ok, move propos back activ (un-accepting).
@rogpeppe, littl confus "the inclus syscal public api".
public api would
packag context
func withcancelsignal(ctx context, ... os.signal) (context, func())
mention _os_, syscall. true call might pass signal defin syscall, happen regardless.
seem like three choic would be:
- syscall.somethingcontext - syscal import context, argument can't os.signal, would need syscall.signal, os-depend previous accepted.
- os/signal.somethingcontext - os/sign import context. argument could os.sign
- os.somethingcontext - os import context. argument could os.sign
seem cleaner keep context constructor context. good argument os os/sign start import context turn around?
know "it feel wrong me" great argument, agre @rogpepp - felt wrong accept still feel wrong. `context` feels, me, rel pure abstract signal-handl like rel platform-depend use-case.
tri tangibl argument: say, hypothetically, opentrac api would make stdllib. would put startspanfromcontext `context`-package, return `context`? seem far-fetched. course, put opentrac api stdlib whatev *would* make might well natur answer. imo still illustr someth might return context, still fit natur anoth package.
anoth "argument" `signal.withcontext` (or whatever) natur implement pretti simpl wrapper around `context.withcancel`, least need share namespac rest context package. cours also need share namespac signal-package, least seem closer align concern imo.
end day, locat seem fulli satisfi corollari also live either. one who' vagu feel get to, put `signal` well :)
decid os/sign right place functionality, think name simpli `signal.context`.
```Go
package signal
func Context(ctx context.Context, ...os.Signal) (context.Context, context.CancelFunc)
```
see `signal.withcontext` make sense, name realli describ scenario get pretti long, `signal.cancelcontextonsignal`. think `signal.context` clear enough.
@robpik note suggest context packag chang mind fine, want doubl check.
@ianlancetaylor exactli chang mind. read comment again, think see posit tent best along. @meroviu explain well, think. context perhap remain abstract free outsid dependency.
want reiter though speak point view gener api designer, someon heavi user either context signal packages.
> mention os, syscall. true call might pass signal defin syscall, happen regardless.
yes, sorry, mistak - read `syscall` valu exampl assum wrong signature. think point still stand though. `os` packag quit larg system specific, seem fit small `context` api me.
> seem cleaner keep context constructor context. good argument os os/sign start import context turn around?
think so. anyon wish add _any_ kind custom cancel context must provid constructor, see signal-bas cancel different.
ineffici so, perhap that' someth gener could address context package.
fwiw support @ianlancetaylor' suggest `signal.context` function.
@ianlancetaylor @bradfitz bikeshed name while. best came with:
```
package signal
func NotifyContext(parent context.Context, signals ...os.Signal) (ctx context.Context, cancel context.CancelFunc)
```
> notifycontext return copi parent context mark done
(it' done channel closed) one list signal arrives,
return cancel function called, parent context'
done channel closed, whichev happen first.
> cancel context releas resourc associ it, code
call cancel soon oper run context complete.
thoughts?
