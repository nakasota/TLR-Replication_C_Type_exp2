net/smtp: add client.tlsconfig field client.sendmail method
`smtp.sendmail` actual great job, fact alway use `smtp.dial` make less flexibl test certain case like ours, want custom `client.localname`
fact, certain operations, `client.localname` must correspond fqdn hostnam send email (alway `localhost` current implementation), lack flexibl led us duplic entir sendmail (and tests) code address issue.
propos add new public method `smtp.sendmailwithdialer` `smtp.sendmailwithdialerfunc` new type `dialer`/`dialerfunc`
```go
type Dialer func() (*Client, error) // or DialerFunc ?
func SendMailWithDialer(dial Dialer, a Auth, from string, to []string, msg []byte) error
```
chang set requir minim backward compatible, `smtp.sendmail` could use `smtp.sendmailwithdialer` pass `smtp.dial` dialer:
```go
func makeDialer(addr string) func() (*Client, error) {
	return func() (*Client, error) {
		return Dial(addr)
	}
}
func SendMail(addr string, a Auth, from string, to []string, msg []byte) error {
	return SendMailWithDialer(makeDialer(addr), a, from, to, msg)
}
```
would allow much control test real use case minimum code, example:
```go
func myDialer() (*smtp.Client, error) {
	cl, err := Dial("remoteSmtp:25")
	if err != nil { return nil, err }
	if err := cl.Hello("my_FQDN") {
 		return nil, err
	}
	return cl, nil
}
smtp.SendMailWithDialer(myDialer, auth, from, to, msg)
```
will make cl accept
edit:
- first propos ad `sendmailwithclient`, turn line valid would duplic `sendmailwithclient` `sendmail` valid must occur dial
- propos includ propos make `config.localname` public, sinc `client.hello` exist sendmail use `client.hello` intern noth hello call chang longer requir dialer function could call `hello` pass `sendmailwithdialer`
@g13013 pleas send patch use gerritt github pull request, describ pleas post patch issu tracker. avoid concern copyright. thanks.
@ianlancetaylor oh know that, sorri ! comment remov
originally, smtp.sendmail tini littl wrapper around client type, convenience.
gotten rather larg tl variou valid added.
@bradfitz point mayb would make sens add client.sendmail method.
make client c howev want call c.sendmail.
avoid callback favor much direct code.
thoughts?
@rsc interesting, sound good me. think even better origin proposal.
last thought,
tend think ad client.sendmail would solv origin issu would make smtp.client usabl unless includ dial capabl initi state.
ex. : user want custom tl configur add valid ca, naiv solut would extend client overrid client.starttls, sinc client.conn & client.servernam hidden initi via smtp.dial smtp.newclient alway return smtp.client struct, extend would possible. exampl could found smtp.sendmail hook ad test use here.
solut would add client.dial addit client.sendmail? pretti much smtp.dial smtp.newclient together, would make client fulli extens even make client instanc reusabl operations, so, would make smtp.dial, smtp.newclient smtp.sendmail wrapper client
think ?
ps: could even add client.dialandsend conveni only!
chang mention issue: `net/smtp: allow control client`
thought cl possibl chang would better visual needs. sure well though, sorri inconvenience!
@g13013, thank sketch api. let' leav dialandsend out, sinc done two separ calls.
quit understand need c.dial. client _alreadi connected_ connection. get one call smtp.dial use net.dial + smtp.newclient. seem necessari expand api contempl not-yet-di client.
think follow said want modifi tl config use starttls, see new api exampl cl enabl flexibility. need flexibility, seem like could export tl config field client. use smtp.dial net.dial+smtp.newcli get client c, set tl config, call c.sendmail. new export field chang seem necessari (along c.sendmail discuss earlier) enabl custom tl configs.
right?
> think follow said want modifi tl config use starttls, see new api exampl cl enabl flexibl
absolut right, put problem see client one cl, mislead comment tls, obvious poor argumentation.
> seem necessari expand api contempl not-yet-di client
probabl right, want suggest client.sendmail variou check actual dialing.
say export tls.config field move sendmail client best choic have.
one note change, move sendmail client, valid occur dial, now, valid localnam recipi occur alway dial, . could harm sens ip could get poor reput case attack, includ exampl enforc best practic suffici ? also, feel odd valid case occur multipl times, dial within sendmail hello !
consid keep signatur client.sendmail, `addr` make dial new connect addr empti (no need export client.dial), export also client.localname, valid could occur actual make transact remot system
```
cl := &smtp.Client{LocalName: "fqdn", TlsConfig: myTlsConf}
cl.SendMail(addr, auth, from, to, msg) // checks all, dials and send
```
> consid keep signatur client.sendmail, addr make dial new connect addr empti
seem bit odd - right client pre-dialed. introduc new kind client, much win. valid happen dial seem like huge problem. connect get lost time, often sendmail get call invalid arguments?
retitl note chang (1) add tlsconfig \*tls.config field smtp.client, like http.server; (2) add sendmail method.
anyon object change?
> often sendmail get call invalid arguments?
often guess, unless hacker involv
> right client pre-dialed. introduc new kind client
emm, that' good point
ok then, think everyth said, accept updat cl insha'allah. thank @rsc
base discuss above, (add client.tlsconfig field client.sendmail method) seem like **like accept**.
would new expos field `*tls.config` `client` interact exist `(*client).starttls(*tls.config)` method allow specifi `*tls.config` use `starttls`?
seem like call starttl manual tl config, would overrid thing struct.
chang consensus, accepted.
sorri delay, lot work finish last days. updat cl accept changes.
mention cl, client.starttl check connect alreadi use tls, ex creat *tls.conn newclient, chang return error case. also client.sendmail tri starttl alreadi use tl connection. know ok think necessary.
let know chang required.
anyth new cl?
