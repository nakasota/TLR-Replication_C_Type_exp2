cmd/go: default & improv -mod=readonli
go 1.16, propos default & improv `-mod=readonly`, make `-mod=mod` complet equival `-mod=readonly`.
would mean go command `go mod ...` `go get` longer updat version `go.mod`.
`go.mod` need fixed, command would report error stop.
error `go list` report packag can't resolv - overal `go list` oper succeed.
discuss previous golang-tools@:
sent there:
probabl know, tri make go 1.16 releas blocker remain anyon adopt modules, includ thing like "go get -b" jay work on.
wondering, part polish modules, chang default behavior stop much updat go.mod.
obvious justifi current behavior length, past, think past think fall apart bit user make mistakes.
example, work modul recent (let' call m) packag (let' call p), decid renam packag (to q). caught m/p import path updat m/q. all, next time ran "go build", go command went tri find modul provid no-longer-exist m/p. m/p real thing exists, automat updat go.mod use make sense. m/p mistak need updating, network work slow real fix.
anoth exampl ad import actual want. might copi file modul somewher else, "go build" add someth go.mod silently, perhap even chang version exist requir statements. case - sinc want import - would better tool stop tell instead addit damag undo.
suspect mani these. general, automat addit go.mod seem good paper, impress deliv vision wanted: wrong thing often, slow compile-edit-debug cycl typos, confusing.
alreadi mode report error instead make changes, name -mod=readonly. flag appli "go get" "go mod" - commands' job updat go.mod would still - stop command like "go list", "go build", "go test" chang go.mod. made mode default also clean rough edg (go list probabl better job report partial results, example), might go long way fix problem list above.
chang default, would probabl make sens chang -mod=mod (the name current automat updating) someth like -mod=autoupdate, leav -mod=mod alia course.
command "go get" (with arguments) alway done build packag current directory, includ download necessari dependencies. default -mod=readonly, "go get" would becom way one-tim fix-up go.mod. "go build" "go list" fail miss requir problem go.mod, "go get" would way fix it. "go test" fail due import specif test, need provid way deal that, probabl ad back "go get -t", pre-modul way download depend test.
along think want chang goimport way say new requir think go along import paths. tool invok goimport could present new import new go.mod requir together. user opt kind autom would still option both. happen automat command like "go build". (thi list new go.mod requir matter goimport exhaust module' current requir grub around modul cache. find match, especi v0, probabl want get version found whatev go command decid latest internet. let goimport specifi new go.mod requir would correct sort race current behavior anyway.)
heard mani peopl suggest default -mod=readonli before, mayb other seen current behavior much problem. mayb peopl figur worth bring can't chang point. believ that' true - behavior wrong, go 1.16 would time get right (and soon).
> heard mani peopl suggest default -mod=readonli before, mayb other seen current behavior much problem.
fwiw, person start complain whole magic behaviour earli feel like anyon take serious point essenti stop particip discuss (iirc even invit comment propos move thing forward natur ignored).
think default behaviour c@#0%, 99% sure secur issu (which believ brought somewher else). make simpl typo, goe pull packag internet input user. know happen rl previous ran experi regist common typo `golang.org` observ peopl pull packag it. request return 404 checksum database, know real secur impact feel like fact was/i possibl extent bad enough.
**tl;dr**
still salty, imo best thing happen go modul sinc introduct support fulli ðŸ’¯
anoth compel example:
% go run main.g
go: find modul packag main.g
^c
actually, run go run modul good way peopl run cli tool written go. would broken propos peopl run command folder go.mod even exist?
@raski modul mode, invok outsid module, `go run` can't build packag outsid standard librari requir modul lookup. get error like this:
```
$ GO111MODULE=on go run use.go
use.go:3:8: cannot find module providing package golang.org/x/mod/semver: working directory is not part of a module
```
#32027. that, pretti much everyth requir sever network fetches, build slow non-reproducible. felt good user experience, especi new users.
@rsc think side effect change, would chang make `go mod download` necessari prestep ci?
consid modul know complet `go.{mod,sum}`, test empti modul cach (a regular situat ci). run `go test` necessit download modules, order determin `go.{mod,sum}` inde complete. say download longer automat happen? therefor `go mod download` necessari prestep, potenti modifi `go.{mod,sum}` files?
@myitcv, `-mod=readonly` prevent resolv new modules, prevent `go` command fetch modul alreadi select requir `go.mod` file list `go.sum` file.
long modul alreadi tidi (or least complete) get sent ci, explicit `go mod download` needed.
> #32027. that, pretti much everyth requir sever network fetches, build slow non-reproducible. felt good user experience, especi new users.
thank pointer, miss discussion. realli happi outcom life.
@bcmill - thanks, forget actual default semant `-mod=readonly` here, despit title. minor brain fade. apolog noise.
chang mention issue: `cmd/go: default -mod=readonli commands`
chang mention issue: `cmd/go: let 'go list -mod=readonly' succeed go.mod inconsistent`
chang mention issue: `cmd/go: updat test work -mod=readonli default`
chang mention issue: `cmd/go: refactor modload.import better -mod=readonli errors`
chang mention issue: `cmd/go: refactor -mod flag parsing`
propos feedback: test run tip broke bisect find dbde566219336e84360b4a38da10b5f63b19021 culprit.
travisci let specifi `before_script` command run script/tests, execut repo work directory. one `before_script` command `go instal github.com/mattn/goveralls`, use push coverag profil coveralls.io use module.
new behavior (`cannot find modul provid packag github.com/mattn/goveralls`) surprising. admittedly, old behavior `go install` modifi go.mod also surprising.
expect break non-trivi number users.
@abursavich case cover combin #40276 use side effect free `go instal pkg@version`
awar workarounds. "break" mean impli irreparable. test run previou minor release, current release, tip. probabl use `go111module=off go instal pkg` switch `go instal pkg@version` go 1.17 released.
understand reason chang behavior go tool well document tip. however, longtim go user run test tip, minim sophist enough find break chang go tool, tell _intuitive_ use `go install` instal command would ever edit go.mod. want instal command, want depend module. would use `go get` that.
side note: append version switch "global" mode intuit consist go command either.
> probabl use `go111module=off go instal pkg` switch `go instal pkg@version` go 1.17 released.
run tip, `go instal pkg@version` equival previous (becaus take latest version `pkg`).
interest, run `tip`, would delay switch approach 1.16 (i assum meant 1.16, oppos 1.17)?
> interest, run `tip`, would delay switch approach 1.16 (i assum meant 1.16, oppos 1.17)?
travisci `before_script` command run environ (e.g. go version) using. run `oldstable` (the previou minor release), `stable` (the current release), `tip`. sinc `go instal pkg@version` new go 1.16, wait go 1.15.x age out, `oldstable` 1.16.x, `stable` 1.17.x.
fwiw, think actual need `go111module=off go get github.com/mattn/goveralls`.
mayb take comment cl 243077, now.
big propon differenti `get` `install`. however, think there' orthogon discuss whether certain command should:
1. modifi go.mod
2. fallback network
think `install` modifi go.mod fallback network. tri instal command current module, `go instal package` behav `go instal package@latest`. would make symmetr familiar behavior `get`.
@abursavich
thank feedback issue. know incompat chang cli. tri caus disrupt necessary, think import long term get default behavior right.
> understand reason chang behavior go tool well document tip. however, longtim go user run test tip, minim sophist enough find break chang go tool, tell intuit use go instal instal command would ever edit go.mod. want instal command, want depend module. would use go get that.
modul mode (and arguabl gopath mode, too), `go install` `go get` lot overlap. like distinguish further: `go install` may eventu use instal executables. `go get` may use manag depend `go.mod`.
> side note: append version switch "global" mode intuit consist go command either.
short, tri address two use case `go install` modul mode: instal execut context current module, instal execut without regard current modul (if even one).
instal tool current modul import use case. fact, one recommend ci. could add requir minimum version tool' module, `go install` that. want keep tool requir `go.mod`, could put anoth `.mod` file specifi `-modfile`.
cours that' alway desirable, need way instal tool regardless current module. #40276 main issu that. there' extens discuss (and previous #30515), feel work differently, pleas comment there.
> think instal modifi go.mod fallback network. tri instal command current module, go instal packag behav go instal package@latest. would make symmetr familiar behavior get.
would make `go install` unpredictable. depend `go.mod` others? want modul command repeatable: set version use either 1) come `go.mod`, 2) written `go.mod` someth new needed, 3) command line indic repeat (e.g., `@latest`).
base discuss above, seem like **like accept**.
question would mean, tri run go tip, alreadi default.
chang consensus, accepted.
alreadi implemented.
chang mention issue: `cmd/go/internal/modload: allow 'go get' use replac versions`
chang mention issue: `cmd/go/internal/modget: resolv path request versions`
@rsc @bcmill miss releas note still, right? seem like big chang beta1 tagged.
chang mention issue: `cmd/go: releas note -mod=readonli default`
chang mention issue: `content/static/doc: document -mod=readonli enabl default`
man guy kick ass!!! keep good work!
