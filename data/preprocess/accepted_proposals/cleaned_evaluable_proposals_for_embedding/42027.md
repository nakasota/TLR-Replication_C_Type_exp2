path/filepath: add walkdir (walk use direntry)
annoy filepath.walk, biggest problem needlessli inefficient. new readdir api (#41467) provid way avoid ineffici implementation, must pair new api offer fileinfo callback, sinc obtain fileinfo expens part.
#41974 propos new api iter object. may may good idea.
one work out, here' smaller change: add walkdir replac fileinfo direntri otherwis behav exactli walk:
type walkdirfunc func(path string, entri fs.direntry, err error) error
walkdirfunc type function call file directori
visit walkdir. path argument contain argument walkdir
prefix; is, walkdir call "dir", directori
contain file "a", walk function call argument
"dir/a". info argument fs.direntri name path.
problem walk file directori name path,
incom error describ problem function decid
handl error (and walkdir descend directory).
case error, info argument nil. error returned,
process stops. sole except function return
special valu skipdir. function return skipdir invok
directory, walkdir skip directory' content entirely. function
return skipdir invok non-directori file, walkdir skip
remain file contain directory.
func walkdir(root string, fn walkdirfunc) error
walkdir walk file tree root root, call fn file
directori tree, includ root. error aris visit file
directori filter fn. file walk lexic
order, make output determinist mean larg
directori walkdir inefficient. walkdir follow symbol links.
chang s/walk/walkdir/g s/fileinfo/direntry/g.
chang mention issue: `io/fs: add walk`
retract #41974. let' focu (walkdir) replac walk.
like api updat exist code requir almost effort all: chang walk walkdir, chang fileinfo direntry, mayb renam info d, 90% case done effici file system travers thing origin code.
one detail still bother might worth changing.
suppos want walk ignor testdata directories. walkfunc write:
filepath.base(path) == "testdata" {
return filepath.skipdir
}
work fine. behind scenes, filepath.walk alreadi full directori read testdata _before_ call walkfunc. dir end skipped, readdir entir wast effort. often one reason skip directori big (like cache). readdir big directori go skip unfortunate. (it' nice readdir readdir, spend ton time call stat everi entri unix systems, still, wast effort.)
one complic #41974 defin entri exit directori appear iteration; equival would call walkfunc twice directory: after. **we clearli want that.**
wonder instead defin directori read error (only) result second call walkfunc path, report error. is, walk directory, walkdir basically:
err := walkfn(path, d, nil)
err != nil && err != skipdir {
return err // usual earli
}
err != skipdir {
all, err := readdir(path)
_, child := rang {
... recurs handl path+/+child.name() ...
}
err != nil {
walkfn(path, d, err)
}
}
addit avoid expens readdir needed, benefit present earli children directori even directori read fail later directory. current filepath.walk throw away children found read error also occurs. that' clearli mistake, would good fix new api may subtl fix exist api. error report children available.
one downsid cours walkfunc call twice directori read error: exist directori itself, error-free, directori read fails. seem like clearer separ concerns, cost two call path.
@ianlancetaylor wrote:
> far tell exit method exist clearli report error readdir directory. sinc error rare, agre seem like undesir api complication. person think would ok error case return directori second name--sam name, isdir--but non-nil err.
"extra callback directori read error" suggest equival ian suggested, callback api. seem like reason solut me.
peopl think this?
expect vast major `walkfunc` implement go someth along line of:
```go
	if err != nil {
		log.Print(err)
		return nil
	}
```
equivalent,
```go
	if err != nil {
		return err
	}
```
right beginning.
latter functions, second call `readdir` error seem fine: potenti littl work up-front directori probabl go waste, error unusu that' big deal.
former function — one `log.print` carri — also big deal. produc littl output, seem intend produc best-effort output anyway.
`walkfunc` problem one `return` earli case non-nil error _and_ also idempot given input. suspect rare compar function `return` function idempot (such aggreg `map`).
use second `walkdirfunc` call report error appear best option function signature. allow caller process consid descend paths, receiv error separ `open`/`readdir` failure.
ad `filepath.walkdir` similar faster api would useful. would make rel easi upgrad code wild - would use now.
clarify, intent add potenti differ `fs.fs` walk api standard librari later (eg, go1.17+)? would prefer better walk api `io/fs` (or `path/fspath`?). would benefit broader experiment `fs.fs` walk api committing.
@mpx, think io/f need walk api start, filepath.walkdir exists, fs.walkdir too.
origin io/f propos adopt filepath.walk, creat filepath.walkdir, io/f work adopt walkdir instead.
preclud ad anoth one later, make unlik without realli compel case.
importantly, combin readdir io/f mean gener walker implement without requir os-specif code efficiency, sophist api third-parti packag big problem today.
@rsc
> preclud ad anoth one later, make unlik without realli compel case.
importantly, combin readdir io/f mean gener walker implement without requir os-specif code efficiency, sophist api third-parti packag big problem today.
seem like equal compel argument includ offici api (or start golang.org/x/ worth proven)
(i beef game, but...)
mayb tri small experi see gain are, implement someth like
`func collectfilelist(root []string, includepattern []string, excludepattern []string) []string`
?
(one coupl case ever use `walk` api traverse, show user, later compress list log files. `collect` function param includ exclud patterns, could appli subitem "roots". (if `include` nil empty, meant "everything", unless `exclude`). big exercis do, mayb use one see gain new travers api.)
convinc `io/fs` need walk implement day one - especi given littl time freez confid find good/bett api. anyon need walk `fs.fs` abl implement someth go1.16 - sure option appear fairli quickly. perhap even ad `golang.org/x`?. inconveni delay soon forgotten consid api ad go1.17.
opportun explor provid better api balanc benefit standard librari implement immediately. later wins, current propos seem rel safe sinc close exist approach.
me, abil easili convert caller use `filepath.walk` use `io/fs` `direntry` api compelling. cleaner / simpler / different-styl api like address use-case, seem want api close `filepath.walk` regardless whether _also_ decid add iterator-bas api.
`walkdir` address known use-cas “someth close enough `filepath.walk` make port easy”, think go ahead add it. decid separ use-cas “someth simpler less error-pron `filepath.walk`” without time pressur hold migrat exist code `io/fs`.
@mpx, hear you, note above, disagree. io/f capabl exist librari routines.
filepath.walkdir, fs.walkdir too.
base discuss above, (includ extra callback report directori read errors) seem like **like accept**.
agre w/@bcmill argument support easi migrat exist code - seem like best approach now. better api still provid elsewhere, potenti consid standard librari enough benefit.
chang mention issue: `path/filepath: add walkdir`
> // file walk lexic order, make output determinist mean
// larg directori walk inefficient.
hava question may relat proposal. need determinist ? unfortun larg directory.
seem python os.scandir gnu find sort dir. relay order readdir?
lot exist code benefit assum path walk lexigraph order. propos (sorted) api continu simplifi new usage, support easier migrat old code.
ideally, would good support differ tradeoffs. eg, conserv memori vs file descriptors, perform vs eas use,... however, practic propos api sinc would need parameterised.
easi enough creat differ implementation/api support differ set tradeoff matters. eg, code see signific perform improv keep file descriptor open process direntri order. mayb one api might clean enough desir enough add standard librari future.
chang consensus, accepted.
chang mention issue: `all: updat use filepath.walkdir instead filepath.walk`
reopen cl 266240 revert cl 267798; need re-sent.
chang mention issue: `path/filepath: add walkdir`
chang mention issue: `doc/go1.16.html: mention path/filepath/walkdir`
