image, image/draw: add interfac use rgba64 directli
applic involv calcul imag data extrem high resolutions, sometim scale gigapixels, resampl result smaller sizes. use packag x/image/draw perform resampl give excel results, rather slowly. one signific reason everi call allocates, result type interface. quick benchmark show respons 80% alloc application.
packag x/image/draw alreadi contain special fast path mani raw imag type packag image. however, imag calcul histogram sometim trillion iter chaotic process, cannot use type accumul image. also cannot copi type prior rescaling, imag work alreadi occupi memori available.
order resolv this, propos creat standard interfac packag imag allow imag process routin defin fast path avoid unnecessari allocations. interfac would follows:
```go
package image
// RGBA64Image is an image with pixels that can be transformed directly to
// color.RGBA64.
type RGBA64Image interface {
	// RGBA64At returns the RGBA64 color of the pixel at (x, y). It is
	// equivalent to calling At(x, y).RGBA() and converting the resulting
	// 32-bit values to color.RGBA64, but it may avoid allocations from
	// converting concrete color types to the color.Color interface type.
	RGBA64At(x, y int) color.RGBA64
	Image
}
```
additionally, propos correspond interfac ad packag image/draw (with alia x/image/draw):
```go
package draw
// RGBA64Image is an Image with a SetRGBA64 method to set the color of a
// single pixel. It is like Image, but using it may mitigate allocations from
// converting concrete color types to the color.Color interface.
type RGBA64Image interface {
	SetRGBA64(x, y int, c color.RGBA64)
	Image
}
```
propos imag type alpha, alpha16, cmyk, gray, gray16, nrgba, nrgba64, paletted, rgba extend implement interfac (note rgba64 alreadi does), nycbcra, uniform, ycbcr extend implement former.
interfaces, imag process algorithm image/draw, x/image/draw, elsewher implement gener fast paths, rather fallback image.imag forc least alloc per pixel. experi use modifi version x/image/draw implement fast path kernel.scal show resampl imag 1280x1280 128x128 goe 3296775 32775 alloc per operation, 100x improvement, approxim 3x speed improvement. particular, primari culprit method applic disappear complet memori profile.
-----
origin propos add interfac `rgba64at` x/image/draw specifically, rather standard library, interfac alloc impact process extrem larg images, resampl seem like like oper them. however, sinc talk other seriou perform issu use image/draw color transform mani images, @nigeltao suggest comment interfac ad standard library.
cc @nigeltao
note `rgbaat(x, int) (r, g, b, uint32)` propos conflict exist `func (p *rgba) rgbaat(x, int) color.rgba` standard library' `packag image`.
perhap add interfac standard librari (and make concret imag type implement them):
---
```go
package image
type ImageV2 interface {
    Image
    // AtDotRGBA(x, y) is equivalent to At(x, y).RGBA() but it can be more
    // efficient, as it does not allocate an intermediate color.Color.
    AtDotRGBA(x, y int) (r, g, b, a uint32)
}
// or perhaps
type ImageV2 interface {
    Image
    // RGBA64At(x, y) is equivalent to At(x, y).RGBA(), after packing RGBA's
    // four uint32 return values into one color.RGBA64, but it can be more
    // efficient, as it does not allocate an intermediate color.Color.
    RGBA64At(x, y int) color.RGBA64
}
```
---
```go
package draw
type ImageV2 interface {
    Image
    // SetRGBA64(x, y, c) is equivalent to Set(x, y, c) but it can be more
    // efficient, as it does not allocate an intermediate color.Color.
    SetRGBA64(x, y int, c color.RGBA64)
}
```
---
`golang.org/x/image/draw` obvious gets:
```go
type ImageV2 = draw.ImageV2
```
yeah, name horribl inconsistent, constrain go 1 backward compatibility...
cc @dmitshur
@nigeltao
forgotten image.rgba.rgbaat. consid this, `rgba64at(x, int) color.rgba64` interfac seem appropriate.
read again, packag imag also somewhat convent would suggest better name. concret imag type `rgba`, `gray16`, &c. wherea interfac type `image` `palettedimage`. so, would natur add `rgba64image`.
unless objections, tomorrow retitl chang propos ad
```go
// RGBA64Image is an image with pixels that can be transformed directly to
// RGBA64.
type RGBA64Image interface {
	// RGBA64At returns the RGBA64 color of the pixel at (x, y). It is
	// equivalent to calling At(x, y).RGBA() and converting the resulting
	// 32-bit channels to color.RGBA64, but it may avoid allocations from
	// converting concrete color types to the color.Color interface type.
	RGBA64At(x, y int) color.RGBA64
	Image
}
```
packag image, updat concret imag type implement it, ad correspond `rgba64image` interfac image/draw x/image/draw, updat concret imag type packag imag implement interfaces, implement fast path image/draw x/image/draw use types.
sound good me.
new fast paths, bother with:
- "image.rgba64imag draw.rgba64image"
e.g.
- "image.imag draw.rgba64image"
- "image.rgba64imag draw.image"
submit separ propos add addit fast path x/image/draw resampl destin types. propos would solv mani similar problem much eleg way. realli hope see come fruition!
@ianlancetaylor (march 12), propos (affect std `image` package) sound good me.
what' formal process here? upgrad issu *proposals/incoming* *proposals/active*?
chang mention issue: `image: add rgba64imag interface`
@nigeltao no, move done propos review committe get issue.
add list consid next meeting.
seem ok. ad minutes.
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
chang consensus, **accepted**. ðŸŽ‰
