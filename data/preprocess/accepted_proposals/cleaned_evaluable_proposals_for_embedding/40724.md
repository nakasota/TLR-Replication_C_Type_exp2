cmd/compile: switch register-bas call convent go function
propos switch go intern abi (use go functions) stack-bas register-bas argument result pass go ~1.16~ 1.17.
lay detail propos work requir document.
abi specif found here.
previous propos #18597, @dr2chase excel prototyp work new propos build on. multipl abi support, we’r much better posit execut without break compat exist bodi go assembl code. i’v open new issu focu discuss new proposal.
/cc @dr2chase @danscal @thanm @cherrymui @mknyszek @prattmic @randall77
incomplet evolv list tasks:
- [x] defin abi specif (cl, @aclements)
- [x] add goexperiment=regabi asm macro (cl)
- [x] cmd/compile: late call lower (cls)
- [x] cmd/compile: implement regist argument (@dr2chase)
- [x] spill around morestack call (cl)
- [x] add temporari abi pragma test (cl)
- [x] add abstract argument regist (wip cl)
- [x] implement abi rule (cl)
- [x] use abstract argument regist
- [x] cmd/compile: implement regist return
- [x] late return lower (cl, @dr2chase)
- [x] implement abi rule (cl, @thanm)
- [x] cmd/compile: abi wrapper (cl, old cl)
- [x] cmd/link: mangl wrapper name elf (cl)
- [x] cmd/link: mangl wrapper name pe (cl)
- [x] implement zero x15 abi0->abiintern wrapper (cl)
- [x] cmd/asm: add syntax runtim packag refer abiintern symbol (cl)
- [x] mark runtime.{goexit,asyncpreempt}, reflect.{makefuncstub,methodvaluecall} definit abiintern (cl)
- [x] mark refer runtime.callbackwrap sys_windows_amd64. abiintern (cl)
- [x] runtime: fix assembl closur call (mcall) (@aclements, cl)
- [x] reflect: support call abiintern (cl)
- [x] reflect: support makefunc method valu call (cl)
- [x] go defer statement
- [x] cmd/compile: desugar go/def zero-argu (@thanm, cl)
- [x] cmd/compile: fix `defer recover()` (@cherrymui, cl)
- [x] cmd/compile: desugar go/def result (@cherrymui, cl)
- [x] cmd/cgo: decoupl cgo callback abi (cl)
- [x] runtime: final support (cl)
- [x] runtime: window callback support (cl)
- [x] cmd/internal/obj: introduc use `regentrytmp` regist prologu (@mknyszek, cl)
- [x] cmd/compile: gener correct abi0 argument map body-less function (see `writefuncmap`) (@dr2chase, cl)
- [x] cmd/compile: make `cgo_unsafe_args` gener abi0 function (or abiinternal-with-no-regist function) (@cherrymui, cl)
- [x] runtime: updat debug call protocol (cl)
- [x] fix abi0/abiintern confus cgo (cl)
- [x] run signatur fuzzer fix bug (everyone)
- [x] get all.bash pass linux, windows, darwin (everyone)
high-prior non-crit path
- [x] export abi inform across packag boundari elimin wrapper (@aclements, cl)
- [x] make `funcpc` alway return "native" pc function (mayb also introduc `abiother`) (@cherrymui, cl)
- [x] strip unnecessari abiintern annot `funcpc`
- [x] traceback
- [x] defin extend argument metadata format (in progress, @cherrymui)
- [x] cmd/compile: produc extend argument metadata (@cherrymui, cl)
- [x] runtime: consum extend argument metadata (@cherrymui, cl)
- [x] cmd/compile,runtime: traceback metadata spill slot live
- [x] dwarf
- [x] cmd/compile: ensur argument appropri dwarf locat
- [x] ensur gdb delv find regist argument
- ~[ ] cmd/compile: add dwarf vendor attribut function argument frame size (context)~
- [x] wrapper mangl non-crit arch
- [x] cmd/link: mangl wrapper name mach-o (cl)
- [x] cmd/link: mangl wrapper name xcoff
- [x] cmd/link: mangl wrapper name plan 9
- [x] runtime: simplifi go/def call path
- [x] assert go/def frame zero size (cl)
- [x] replac defer reflectcal direct closur call (cl)
- [x] cmd/internal/obj: reject splittabl abiintern function without morestack spill info (e.g., asm functions) can't gener correct morestack path (cl)
- [x] cmd/asm: refer `args_stackmap` abiintern function (becaus abi0) (cl)
- [x] port performance-crit assembl abiintern (see cl 296372 valuabl functions) (cl 308931, cl 310184)
- [x] math: fix overhead assembly->go call cl 310331
- [x] releas note
- mention undocu behavior observ applic depend may changed.
- use `reflect.valueof(fn).pointer()` get pc assembl function return pc abi wrapper
- perform surprise: call assembl go slightli expensive.
- perform surprise: call assembl function via closur slightli expensive.
- traceback format much improv
enabl step
- [x] enabl regabiwrapp default amd64 (linux, windows, darwin)
- [x] enabl regabidef
- [x] enabl regabireflect
- [x] enabl regabig
- [x] enabl regabiarg
test
- [ ] function signatur fuzzer (ongoing)
- [ ] static call, closur call, method call, interfac call, `reflect.{valueof(target),makefunc(x, target),method(x)}.{call,interface}`, call `defer`, call `go`, call final
- [x] {big,small} {argument,result} {memory,registers} {not addressed,address leak heap,address leak heap}
- [x] use `defer` test function (check arguments, modifi results)
- [x] pass pointers-to-stack pointers-to-heap
- [x] caus result move heap
- [x] runtime: add `movestackonnextcall`, assert pointer-to-stack/pointer-to-heap, assert live/dead (@aclements, cl)
- [x] integr runtim test hook
- [ ] clean fuzzer, get tool repo.
- [x] cmd/compile: reviv clobberdead (cl)
- [x] cmd/compile: add clobberdeadreg (cl)
post-mvp
- [x] move g tl regist (cl)
- [x] use g regist non-linux ose (see cl)
- [x] reserv use x15 zero regist (cl)
- ~[ ] x0 compact instruct encoding?~
- [ ] port platform
- [x] amd64
- [x] arm64
- [ ] mip
- [x] ppc
- [ ] s390x
- [x] risc-v
- ~[ ] port guide~
- [x] elimin legaci abi path platforms, even use abiintern 0 regist
- [ ] elimin spill slots?
- [ ] pass pointer-shap method receiv context regist (#44827)
- [x] runtime: simplifi go/def call path
- [x] simplifi go/def path assum zero args/result
- [x] simplifi special _defer alloc remov special _defer case mallocgc (becaus _defer record fix size).
- [ ] cmd/vet: add syntax check regist argument result assembl like x+0(fp)
- [ ] cmd/vet: check argument size abiintern function fix runtim asm declar
cleanup (can done later)
- [ ] runtime: port assembl -> go call abiinternal?
- [x] elimin abialia support cmd/compile, cmd/link, object format
- [x] remov now-redund field ssa.auxcal
- [x] ration use localsoffset/frameoffset (for regist use link register, e.g. arm64, powerppc).
- [ ] cmd/compile: revisit abiutils.go clean api (also reduc abiconfig copying)
- [ ] cmd/internal/obj: gener stack map obj better compact morestack/bodi map reduc subtlety?
- [x] cmd/compile,runtime: re-en pass argument `go` runtim (context)
- [ ] cmd/compile: alway attach `ir.func` function `ir.name` (context)
- [x] cmd/compile: support abiintern tail call (context)
- [x] cmd/compile: wrap defer arch/o combinations, possibl simplifi remov opendef process ssagen (notablli could get rid opendefersave()
- ~[ ] runtime: think abi-insensit debugcall~ delv use dwarf inform
- [ ] fix name slot & valu associ
- [ ] fix `firstpos` `ssa.go` – sometim late.
upon time, one sever peopl whose primari work activ think two day track weird kernel crash, ultim caus callee-sav registers. well, crash caus [foo_max] array overrun. thing result overrun overwrit singl automat variable, never address taken, five call frame away? _that_ caus callee-sav registers.
say:
> platform abi typic defin callee-sav registers, place substanti addit requir garbag collector. altern callee-sav regist share mani benefits, much better suit go.
+1 +1 +1 +1 +1 +1 [...]
understand propos correctly, assembl code continu written current stack base call conventions.
understand excel reason behind this, note sure go frustrat assembl code writer abl pass receiv arg regist often assembl code fragment tini overhead call massive.
@ncw restrict `abi0` assembl writer necessarili permanent. see
right writebarri special builtin allow argument pass registers. concept extend other like memmov memcpi avoid call overhead even though asm?
@labog , yes, consid special-cas assembl functions. hottest one far `memmove`, `memclrnoheappointers`, possibl `syscall.syscall`. write barrier call convent *very* special context unusu performance-sensitive. probabl switch other use regist abi rather anyth special (and teach toolchain special even though assembly).
comment "stack growth" section doc, specif spill regist state `morestack` guard space goroutin (copi gerrit):
worri littl bit case function mark `nosplit` eventu call non-`nosplit` function. `nosplit` frame larg (but exceed guard space) might find space left. case? throw seem quit right sinc work fine today (though, careful). "guard space" subset "no, really, guarded" space? would requir extend guard space bit great...
one altern manag per-goroutin space this, that' great either, sinc memori use per goroutine.
good point. especi true architectur lot registers. mayb could decid regist never live across call?
that' excel point. possibl solut come mind:
1. would realli sad make per-goroutin space sinc almost alway space stack. one possibl spill stack there' room, otherwis keep pool alloc "spill space" objects. that, could keep one pre-alloc per p goroutin need it, pull p, spill it, enter runtim alloc new one (probabl get global alloc pool) attach p. return, return alloc pool.
2. similar option would one spill space per p. again, use stack can, otherwis spill p, enter runtime, *grow stack* even preemption, dump spill regist back onto stack right place.
3. could revisit nosplit rules. often (though always) mistak call nosplit function non-nosplit function. sure exactli would look like. mayb non-nosplit function call nosplit function special prologue? related: think case enumer comment intent call nosplit non-nosplit function run user g stack thu can't grow anyway.
chang mention issue: `cmd/asm: defin macro goexperiment=regabi`
chang mention issue: `cmd/internal/objabi: add regabi goexperiment`
chang mention issue: `runtime,cmd/cgo: simplifi c -> go call path`
@alexbrainman , ran bit snag window mayb better inform on. look like `syscall.newcallback` go also need implement go intern abi rule tri figur exactli need look like. (i ping look like last substanti touch code, feel free pass ping.)
document say "the argument expect function one uintptr-siz result. function must argument size larger size uintptr." actual mean argument (and result) must integral, floating-point, pointer type? mean, say, `struct { x, uint16 }` `struct { x [4]byte }` allowed, sinc technic larger size uintptr? current implement permit latter, though know actual works.
must int/float/pointer, map window abi go regist abi rel straightforward. compound allowed, get much harder.
cc @jstark abi question.
@aclement reckon instanc syscall.newcallback usage. use lot.
want build window gui, use syscall.newcallback, window gui api requir syscall.newcallback.
similarly, want build window service, use syscall.newcallback.
two pretti much cover syscall.newcallback usage.
window service, look golang.org/x/sys/windows/svc. use registerservicectrlhandlerex window api

requir lphandler_function_ex

lphandler_function_ex return dword (uint32).
gui grep golang.org/x/exp/shini - use registerclass

use wndclassw.lpfnwndproc

wndproc

return lresult long_ptr uintptr (in go)

also recommend look github.com/lxn/walk syscall.newcallback usage. ultim packag creat gui apps. but, doubt, find differ usag golang.org/x/exp/shine. (i look myself)
reckon, it. microsoft api (mayb googl code syscall.newcallback windows.newcallback).
peopl might use custom / proprietari interface. sure support go. judge.
alex
iiuc exampl microsoft doc show compound allowed:
```cpp
struct Struct2 {
   int j, k;    // Struct2 fits in 64 bits, and meets requirements for return by value.
};
Struct2 func4(int a, double b, int c, float d);
// Caller passes a in RCX, b in XMM1, c in R8, and d in XMM3;
// callee returns Struct2 result by value in RAX.
```
chang mention issue: `go/analysis/passes/asmdecl: add support abi selector clauses`
chang mention issue: `reflect,runtime: use intern abi select asm routines`
chang mention issue: `cmd/dist,cmd/go: broaden use asm macro goexperiment_regabi`
chang mention issue: `cmd/compile,cmd/link: initi support abi wrappers`
chang mention issue: `cmd/asm: allow def/ref func abi compil runtime`
chang mention issue: `cmd: go get golang.org/x/tools@d1624618 && go mod vendor`
chang mention issue: `cmd/compile: delay expans oparg expand_calls`
chang mention issue: `cmd/compile: avoid gener cses; aggregates; maintain debug names`
chang mention issue: `runtime: fix sub-uintptr-s window callback arguments`
updat this: hope land 1.16, alway go bit stretch, point abl make 1.16. sinc make good progress lot work flight, current plan branch freez come finish work there. land begin 1.17 worst thing sinc give lot soak time. there' concern risk land gener 1.17, believ fairli orthogon natur regist abi work abl test pretti thoroughli thing like fail loudli bugs.
> there' concern risk land gener 1.17
1.17 -> 2.0?
sound like everyon involv board go 1.17.
ad propos minut wider visiblity, seem head like accept.
> incomplet evolv list tasks:
@aclement consid ad bullet point track implement dwarf locat argument result (contain registers). good support go call convent gdb delv well worth track bullet point :)
work alreadi outlin
> dwarf locations: compil need gener dwarf locat list argument results. alreadi abil local variables, reus much possible. need ensur delv gdb compat this. alreadi support locat list general, unlik requir much (if any) work debuggers.
@mewmew , thanks, ad bullet list this. hope there' noth actual here, right good track need make sure works.
chang mention issue: `reflect,runtime: support amd64 regist abi reflect.call`
