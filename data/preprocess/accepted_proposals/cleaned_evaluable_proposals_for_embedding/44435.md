cmd/go: narrow 'mod download' default set
## context
`go mod download` often use build system "warm cache" subsequ oper need fetch data. however, current download expected. see #41431.
@bcmill suggest use `go list -test -dep ./...` instead. would fetch modul transit import packag main module.
similar suggest `go list -test all` made recent gopher slack.
## propos
issu propos chang default select `go mod download` match `go list all`. would make `go mod download` intuit cache-warm case typic involv need dependencies' test dependencies.
current select could move flag necessary.
cc @jayconrod @matloob
clarity, right `go mod download` download modul list `go list -m all`.
propos limit modul suppli packag `go list all`, smaller set.
note would still need download go.mod file someth like whole origin set,
still report `go mod download -json`, entri would simpli omit
full-sourc link full sourc downloaded.
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
think would break cach warm case `go.mod` `go.sum` none code, describ in:
case common build docker contain allow popul modul cach copi code in. modul cach state sole depend code (which `go list all` effect does), cach popul code ad new layer, code chang invalid layer caus cach thrown away.
seem like base support case would actual improv future, `go list all` `go.mod` `go.sum` net packag `go list -m all` appear queri them.
cc @jayconrod
@zikaeroh, set fast docker builder, probabl want prime build cach â€” modul cache.
case, would either want `go build $packages` (where `$packages` externally-comput list packag expect relev build), go ahead upload baselin copi code build run `go test -c -o /dev/nul ./...` similar.
or, put anoth way: ok wast space build imag (a would `go mod download` today), like better wast space redund copi sourc code _your_ modul instead redund copi sourc code _unused_ modul depend graph.
> set fast docker builder, probabl want prime build cach â€” modul cache.
experience, get 2 gb depend project need (or 1 gb non-test) much, much time consum actual build itself.
> case, would either want `go build $packages` (where `$packages` externally-comput list packag expect relev build), go ahead upload baselin copi code build run `go test -c -o /dev/nul ./...` similar.
>
> or, put anoth way: ok wast space build imag (a would `go mod download` today), like better wast space redund copi sourc code modul instead redund copi sourc code unus modul depend graph.
unfortunately, docker can't work way. build context docker base current file system. can't pre-copi differ version (which version?) code contain build there' one version; current one. make chang sourc code, layer depend invalidated, henc copi `go.mod` `go.sum`, chang often provid info requir pre-popul cach (even overzealous).
note "wast space"; build binary, copi anoth imag (see: case, "waste" cach that'd builder (versu imag runs), want happen anyway. common pattern build docker imag compil code; there' reason ship source, go compiler, caches, etc.
work way: use old version build stage base imag newer builds. (note newer `docker` version mount volum cach remov need layer gymnastics)
"wast space" refer build stage, obvious cach abl reus it. case old copi code + accur depend take less space extend set dependencies. wast space also translat longer build time ci stateless need restore/sav larger cach remot
believ done, would appreci sort exampl look at; hard time conceptu would work without shift cach respons extra script (manag parent imag use that' encod dockerfile, remov old items, etc) break stateless (some at-build volume). seem like shame manag simpl achiev follow docker' best practic documentation.
chang default `go mod download` arguments.
@bcmills, would `go mod download all` still get old behavior?
mayb default "what' list go.mod", would work well new modul pruning?
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
@rsc understand `go mod download all` would retain current behaviour download go.mod/sum exists? total supprt @zikaerohâ€˜ case fast docker build without addit step mount volum (which might ci). make chang would break build least allow fix ad `all`.
> mayb default "what' list go.mod", would work well new modul pruning?
would break anybodyâ€˜ build (and even get rid pars step?)- neg side effects?
> would break anybodyâ€˜ build (and even get rid pars step?)- neg side effects?
definit "what' list go.mod" download modul list go.mod none depend (a "all dep deps" old behavior), effect chang would chang over-warm under-warming, rest depend would pull futur step, probabl `go build`. would caus element unpredict base project happen import (and dep import), probabl caus confus cach chang exist dockerfiles.
way avoid unpredict would bump modul 1.17 enabl lazi load extra entri go.mod (which sure project given misconceptions/lack clariti around version actual indicates; #46201, #30791).
@zikaeroh
> way avoid unpredict would bump modul 1.17 enabl lazi load extra entri go.mod
or, conversely: enabl new `go mod download` behavior modul specifi `go 1.17` higher.
like idea make chang conting `go` version default download modul list explicitli `go.mod` file. give abil run `go test ./...` (which expect ci system running) `go mod download` without need re-scan entir packag import graph.
agre `go mod download all` continu download modul `go list -m all` regardless.
ok, sound like converg chang 'mod download' set go.mod use modul graph prune (go 1.17+), featur would ship go 1.18 sinc alreadi go 1.17 freeze.
right?
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
chang consensus, **accepted**. ðŸŽ‰
