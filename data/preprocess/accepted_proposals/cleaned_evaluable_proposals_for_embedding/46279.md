runtime: automat bump rlimit_nofil unix
read nutshel says:
* use `select`
* systemd set rlimit_nofil soft limit 1024 compat reasons, break `select` user
* systemd set rlimit_nofil hard limit 512k, program want (without escalation), rais soft limit past 1024, implicitli acknowledg `select` work.
realiz sinc go use select, go runtim could automat fd soft limit bump linux.
select wrapper though, perhap could thing #42347 18510ae88ffcb9c4a914805fde3e613539f9b6dc ( bump condit base whether `unix.select` func binary. `cgo` too, suppose.
suspect mani user unawar 512k hard limit that' free bump to. certainli unaware. (i normal go manual tweak systemd limit instead, usual respons problem hit limit...) think fix automat would help user hurt. (i actual can't think hurt anybody?)
think need backpressur mechanism. blog post mentions, memori limit alreadi mechanism.
/cc @ianlancetaylor @aclement @rsc @randall77
limit `select` kernel limitation. limit implement `fd_set` glibc. inherit limit `x/sys/unix.fdset`, perhap could fix that. did, could rais soft limit hard limit unconditionally.
note debian system soft hard limit `131072`. cento 6 system soft limit `1024` hard limit `4096`. recent fedora system soft limit `1024` hard limit `524288`.
yeah, saw `fdset` `struct { bit [16]int64 }`. make opaqu `[16]int64` use default spill-ov lazily-alloc bitmap `(*fdset).set(fd int)` call "big" fd? doable, wonder worth effort. anybodi actual use `unix.select`?
still need condit mechan regardless `cgo` assume, know whether c code use select easily?
fwiw, variou debian (buster) & ubuntu (focal lts, hirsute) machin here, see 1024 & 1048576.
> anybodi actual use unix.select?
github code search say .... mostli wireguard-go' `rwcancel` package.
(cc @zx2c4 fyi)
~i'm happi get rid replac poll. (want send patch?)~ done:
propos sound like good idea, caveat probabl initi -buildmode=shared.
happen today, even program noth file i/o (no select etc), open mani file get errors. auto-bump would let program run longer.
go startup, would inherit non-go program fork+exec. potenti incompatibility, probabl larg one. technically, suppos could undo subprocess fork exec.
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
summar limit use case rais soft limit.
* select implement glibc (or libc like musl too?) use
* cgo use dynam link load anyth dlopen also caus exec call place know.
* select implement syscal unix packag used, unless one chang suggest above.
* nss (user/group lookup dn lookup) use glibc.
* need reset, call exec famili syscal
one problem restor limit exec know limit intent chang program interim. program explicitli rais limit exec today? would drop back down.
seem like go rais limit, that, tri put back.
ran problem gofmt mac, limit default 256 (and gofmt edit mani file parallel). love go rais limit too.
much realli matter rais limit subprocess?
peopl alway set hard limit want go tri bump soft limit up.
pretti aw limit break complet reason go program like gofmt -w.
seem wrong gofmt put bump in.
seem like bump limit startup - go use select.
hard see program benefit limit practic anymore.
understand systemd can't make global decision, think go can.
think seem quit reasonable.
even document `unix.select`/`syscall.select` mark deprec editor bring attent mayb add someth `go vet` too. seem alway possibl move poll similar.
sure anyon use syscall.select fd' anyway.
everi time use past decad get sub-second-resolut sleep api (select fds).
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
titl updat mention unix someth instead linux?
personally, constantli run limit macos; would like see resolved.
consider may differ differ unix systems. linux detail somewhat specif systemd.
may well appropri maco also, know tradeoff there. maco default low limit?
abl find, default goe back first os x releas probabl even back bsd. constant there.
course, maco deal-break annoyance.
issu awar aris rlimit_nofil set high valu is, binari (that may execut go program thu inherit limit) want someth like (pseudocode):
```go
for fd := 3; fd < getrlimit(RLIMIT_NOFILE); fd++ {
      close(fd) // or set CLOEXEC flag
}
```
specif example, `rpm` packag manag use (fix also older version python (but sure).
probabl issue, sinc docker also similar thing ( sinc everyon seem use contain now, let' hope issu like fix (yet better, mayb program even start use `close_range()`).
also, sure showstopp accept propos -- someth keep mind.
chang consensus, **accepted**. ðŸŽ‰
