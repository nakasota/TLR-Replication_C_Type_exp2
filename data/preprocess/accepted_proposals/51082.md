=== Fetching Proposal: I_kwDOAWBuf85DN5Oq ===
Issue URL: https://github.com/golang/go/issues/51082

==== [Issue Title] ====
go/doc: improve headings, lists, and links

==== [Issue Body] ====
This proposal improves support for headings, lists, and links in Go doc comments,
while remaining backwards compatible with existing comments.
It includes a new package, `go/doc/comment`, exposing a parsed syntax tree for
doc comments, and it includes changes to `go/printer` and therefore `gofmt`
to format doc comments in a standard way.

For example, existing lists reformat from the display on the left to the one on the right:

<table>
<tr><td><img src="https://github.com/golang/proposal/raw/master/design/51082/list-before.png" width="308" height="271">
<td><img src="https://github.com/golang/proposal/raw/master/design/51082/list-after.png" width="307" height="289">
</table>

URL links can be rewritten to change the display on the left to the one on the right:

<table>
<tr><td><img src="https://github.com/golang/proposal/raw/master/design/51082/link-before.png" width="307" height="94">
<td><img src="https://github.com/golang/proposal/raw/master/design/51082/link-after.png" width="308" height="103">
</table>

And package doc comments (and others) can be rewritten to link to specific symbols:

<table>
<tr><td><img src="https://github.com/golang/proposal/raw/master/design/51082/doclink.png" width="366" height="383">
</table>

The full design doc is at https://github.com/golang/proposal/blob/master/design/51082-godocfmt.md.


==== [Comments] ====

--- Comment #1 by gopherbot ---
Change https://go.dev/cl/384263 mentions this issue: `go/doc/comment: new package`

--- Comment #2 by gopherbot ---
Change https://go.dev/cl/384257 mentions this issue: `all: fix various doc comment formatting nits`

--- Comment #3 by gopherbot ---
Change https://go.dev/cl/384267 mentions this issue: `cmd/go: gofmt alldocs.go`

--- Comment #4 by gopherbot ---
Change https://go.dev/cl/384258 mentions this issue: `all: fix TODO comment hanging indents`

--- Comment #5 by gopherbot ---
Change https://go.dev/cl/384265 mentions this issue: `go/doc: use go/doc/comment`

--- Comment #6 by gopherbot ---
Change https://go.dev/cl/384266 mentions this issue: `cmd/doc: use new go/doc APIs`

--- Comment #7 by gopherbot ---
Change https://go.dev/cl/384268 mentions this issue: `all: gofmt main repo`

--- Comment #8 by gopherbot ---
Change https://go.dev/cl/384264 mentions this issue: `go/printer: format doc comments`

--- Comment #9 by gopherbot ---
Change https://go.dev/cl/384259 mentions this issue: `all: remove trailing blank doc comment lines`

--- Comment #10 by gopherbot ---
Change https://go.dev/cl/384260 mentions this issue: `all: separate doc comment from //go: directives`

--- Comment #11 by gopherbot ---
Change https://go.dev/cl/384274 mentions this issue: `internal/pkgdoc: update go/doc API usage for links`

--- Comment #12 by rsc ---
The top comment has been filled in now. 
See https://github.com/golang/go/issues/51082#issue-1127715754.


--- Comment #13 by jimmyfrasche ---
This solves 90% of my problems working with docstrings and makes the remaining 10% trivial. I am ecstatic!

I'd be perfectly happy to have this accepted as-is but I do have a couple minor thoughts:

I'd s/Text/Inline/g and then s/Plain/Text/g to align with html. That could just be familiarity but it seems clearer to me.

Allow subheadings with `##`, `###`, and so on. I've seen a few packages since the original discussion that could use at least one extra level of indentation for grouping subsections (I did not think to record the packages in question, sorry). This could be added later, but if so it may be prudent to accept `## x` as a heading now so it doesn't change from a paragraph to a heading later. Though at that point you're most of the way to an implementation.

--- Comment #14 by rsc ---
For now I think we should keep things simple and not increase scope past the previous discussion. There would really be no problem with having ## render as a paragraph during a later transition. Single # is rendering as a paragraph during this one.

--- Comment #15 by kortschak ---
In numbered point 5 in the goals and non-goals, the absence of in-line image support is noted for a couple of languages and support by one, but no mention of Python (a much more relevant language than for example Perl). Here it does exist in some projects https://numpy.org/doc/stable/reference/generated/numpy.fft.fft.html#numpy.fft.fft and in general, Python doc strings may be valid reStructuredText which allows embedding of images.

--- Comment #16 by rsc ---
Python supports images in their docs, noted. 
All the problems listed for images still exist though, and images remain out of scope for this change.


--- Comment #17 by ainar-g ---
I am extremely excited about this!  A couple of questions / suggestions.

1.  Currently, the pkg.go.dev renderer automatically converts text like `RFC NNNN` into a link to the corresponding RFC.  From what I can tell, that's a feature of the website's renderer as opposed to one of godoc itself.  Will that behaviour of the renderer remain intact?

2.  The point about ASCII double quotes doesn't mention if they are reformatted in the preformatted text.  I think, it is worth explicitly mentioning that they won't be replaced with the Unicode ones in that position and adding test cases for that if there isn't one.

    (This may seem obvious, but anyone who ever tried editing a Shell script with the macOS TextEdit program will know that it sometimes isn't, heh.)

3.  In the numbered list section, it's currently not clear, what happens when N is above 9.  I assume that it will become “␠NN.␠”?

4.  In the heading section, perhaps there should be an example of a line that begins with a space and then a `#`.  Markdown allows a certain amount of spaces before the heading character, and if the new format doesn't allow that then it's a differrence worth mentioning explicitly, I think.

Again, really looking forward to this in any case.

--- Comment #18 by kortschak ---
Overall this looks good, but I want to restate my concern about the accessibility issues I raised with the approach to marking links.

--- Comment #19 by rsc ---
Thanks for the questions, @ainar-g.

1. I dont know for sure, but I think the idea is to drop the special case RFC NNNN support on pkg.go.dev and let people write links. The current support does not handle references to subsections well, for example. It was probably a mistake for pkg.go.dev to diverge this way. There is a bit more prior discussion at https://github.com/golang/go/discussions/48305#discussioncomment-1304365.

2. Doubled ASCII single quotes (` `` ` and ` '' `) are reformatted. This is called out explicitly:
   > The ASCII double-single-quote forms that have always been defined to render as “ and ” are replaced with those.

3. If N is 10, then “␠N.␠” would be “␠10.␠”. This seems clearer than writing “␠NN.␠” - wouldn't that be “␠1010.␠”?

4. Thanks for the suggestion. Added that as an example.





--- Comment #20 by rsc ---
@kortschak Noted re link syntax. I don't have anything more to add beyond https://github.com/golang/go/discussions/48305#discussioncomment-1304760.


--- Comment #21 by kortschak ---
It's worth noting that I did follow that up OOB with a detailed response, but did not receive a reply.

--- Comment #22 by thepudds ---
Overall, this is exciting to see. 

A few quick questions about linking to headers and the relationship to the base URL.

1. For linking to headers in the same package, would something like the following work?

```
See [Some Heading] for more information.

[Some Heading]: #some-heading
```

2. Would that rely on knowing the default header anchor ID algorithm (or doing a copy/paste or similar)? From the API, it looks to be proposed as:
```
// The default anchor ID is constructed by dropping all characters
// except A-Z, a-z, 0-9, space, and tab, converting to lower case,
// splitting into space-or-tab-separated fields, and then rejoining
// the fields using hyphens. For example, if the heading text is
// “Everybody Says Don't”, the default ID is “everybody-says-dont”.
```

3. Would you be able to link to headers in other packages without needing to know the base URL, such as something like:

```
[Another Heading]: /some/import/path#another-heading
```

3. Anchor IDs removing non-ASCII letters certainly simplifies things, but if linking to something like this (one of the examples from [#7349](https://github.com/golang/go/issues/7349)) is contemplated for the future, simply changing the anchor ID algorithm might then break other links that are mixed ASCII/non-ASCII headers?

```
# これは、ヘッダです
```

In any event, I think the ability to link to headers would be extremely useful, especially for complex packages.


--- Comment #23 by rsc ---

This proposal has been added to the [active column](https://golang.org/s/proposal-status#active) of the proposals project
and will now be reviewed at the weekly proposal review meetings.
— rsc for the proposal review group


--- Comment #24 by ajanata ---
> * If N is 10, then “␠N.␠” would be “␠10.␠”. This seems clearer than writing “␠NN.␠” - wouldn't that be “␠1010.␠”?

Will this not cause misalignment issues with the following lines of the list item? See:

> All list item continuation text, including additional paragraphs, is indented by four spaces.

Should this not be the number of spaces to line up with the actual text of the list item it belongs to?

For example,

```
//  10. This is an example list item.
//     This is how my reading of the spec would reformat it.
```

Additionally, I am concerned by not having nested lists. I can do some digging if requested, but it seems incredibly likely that there are a lot of \<pre\>-block lists that would use nested lists like so:

```
//  - an item
//  - another item
//    - some important subitem
//    - another important subitem
//  - some other item
```

Yes, this has subtle space counting, but existing comments would already be doing that with preformatted blocks. I think the lack of nested lists would be more harmful than the space counting it would entail. I know I'd have to go back and re-structure several godoc comments I've written to avoid nested lists.

--- Comment #25 by beoran ---
I am not sure about nested lists, but one way to avoid subtle space counting would be to require doubling or tripling the list marker a bit like this

```
 1.
 2.
 2. 1.
 2. 2.
 2. 3. - 
 2. 3. -
```

--- Comment #26 by thepudds ---
Hi @ajanata 

> Should this not be the number of spaces to line up with the actual text of the list item it belongs to?
> 
> For example,
> ```
> //  10. This is an example list item.
> //     This is how my reading of the spec would reformat it.
> ```

As I understand it, that is a deliberate choice. There’s some more discussion of the rationale here:

https://github.com/golang/go/discussions/48305#discussioncomment-1310150

…including see the example there of what you suggested vs. how the current proposal intentionally keeps the continuation lines aligned. 

A third option might be to realign all the text in a numbered list the moment you add item 10 or item 100, but that makes the diffs less clean and the rules more complex. 


--- Comment #27 by jba ---
The [doc link syntax section](https://github.com/golang/proposal/blob/master/design/51082-godocfmt.md#new-syntax-for-documentation-links) of the proposal implies that `[pkg.ID]` renders as a single link, and `doc/comment.DocLink.DefaultURL` returns a single URL. But when `pkg.go.dev` renders symbols in declarations, it links to both the package and symbol. For example, look at the link to `io.Writer` in https://pkg.go.dev/hash#Hash. It is actually two links: `io` links to `/io`, and `Writer` links to `/io#Writer`.

I don't have any data on how often people use that package link, nor on how often they accidentally click it when they wanted the symbol. In other words, it may be a feature, or it may be a misfeature. But it is an inconsistency with this proposal.

--- Comment #28 by beoran ---
@jba I didn't even know that there are two links there. I think the package link isn't very useful and can be dropped.

--- Comment #29 by perillo ---
Consider the documentation of https://pkg.go.dev/flag#Func.
It would be nice if the formatting of `name`, `usage` and `fn` in the text can be improved, since they refer to the parameters of the function.


--- Comment #30 by JAicewizard ---
As it hasnt been mentioned, there was also some discussion around the docs API over at these places:
https://github.com/golang/go/issues/34875
https://github.com/golang/go/pull/37868
Both are centered around markdown, but eventually spiral into a more generic API like discussed here.
