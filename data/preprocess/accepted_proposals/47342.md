=== Fetching Proposal: MDU6SXNzdWU5NTA2MjUzOTg= ===
Issue URL: https://github.com/golang/go/issues/47342

==== [Issue Title] ====
hash/maphash: Provide a `purego` implementation

==== [Issue Body] ====
### What version of Go are you using (`go version`)?

1.17rc1

### What operating system and processor architecture are you using (`go env`)?

GopherJS with Go 1.17

### What did you do?

https://github.com/golang/go/commit/64d323f45a5d6a36cdcb190bed56424a633af3ad improves the performance of the `hash/maphash` package, but in doing so makes the package even "less" safe than it was before. In 1.16 this was worked around in GopherJS (where pointer arithmetic is not possible) with https://github.com/gopherjs/gopherjs/commit/ccebfda74f29e7f37a55c1ce3d059160bd248601.  The recent changes will require a much larger delta, as now every caller to `rthash` will need to be updated, to use calling semantics more similar to the 1.16 version.

### What did you <strike>expect</strike> hope to see?

A `purego` implementation of `hash/maphash` would solve this problem. And perhaps it would be useful in other scenarios as well?


==== [Comments] ====

--- Comment #1 by flimzy ---
cc @dmitshur 

--- Comment #2 by mvdan ---
My initial reaction was "I thought purego was for avoiding asm and cgo, not unsafe", but I'm wrong: https://github.com/golang/go/issues/23172#issuecomment-359569548

--- Comment #3 by randall77 ---
Are you proposing to replace `hash/maphash` with a purego implementation? What implementation would that be?
`unsafe` is used in that package for performance reasons. Any different implementation would probably need to be equally fast.


--- Comment #4 by flimzy ---
> Are you proposing to replace `hash/maphash` with a purego implementation?

No. I would keep the existing one for performance where useable, and add a purego version behind build tags.

> What implementation would that be?

TBD. But probably logically equivalent to what GopherJS is doing now (i.e. a slight variation from the Go 1.16 version).


--- Comment #5 by randall77 ---
So far the only purego tags in the main repo are crypto libraries. I think there's a higher level decision to be made as to how much we want to sprinkle the standard library with purego backstops. For instance, we'd probably need a purego builder to test that the code works.
But other than that (big) concern, it sounds reasonable to me.


--- Comment #6 by rsc ---

This proposal has been added to the [active column](https://golang.org/s/proposal-status#active) of the proposals project
and will now be reviewed at the weekly proposal review meetings.
â€” rsc for the proposal review group


--- Comment #7 by rsc ---
In net and os/user we have netgo and osusergo tags instead of purego.
The only purego I see is in some crypto packages.
However, it looks like we accepted the idea of purego and did not get around to the documentation of it: https://github.com/golang/go/issues/23172.

Given that, it seems fine to have a purego hash/maphash.


--- Comment #8 by cristaloleg ---
Not sure but maybe this should be accepted first? https://github.com/golang/go/issues/23172

--- Comment #9 by randall77 ---
#23172 is accepted. It just needs to be done.


--- Comment #10 by rsc ---

Based on the discussion above, this proposal seems like a **[likely accept](https://golang.org/s/proposal-status#likely-accept)**.
â€” rsc for the proposal review group


--- Comment #11 by rsc ---

No change in consensus, so **[accepted](https://golang.org/s/proposal-status#accepted)**. ðŸŽ‰
This issue now tracks the work of implementing the proposal.
â€” rsc for the proposal review group


--- Comment #12 by nevkontakte ---
I would like to contribute to the implementation, but I don't think I would be able to help much with testing infrastructure concerns @randall77 mentioned in https://github.com/golang/go/issues/47342#issuecomment-885015038.

One alternative I can think of is that both optimized and purego implementations are included in the default build as private functions, and build constraints only select which one is actually used. In that case it would be possible to add a test that verifies that both implementation behave exactly the same. Dead code elimination should be able to strip out one of the implementations in the build.

The drawback of this option would be that the code might get a bit less intuitive, and it's not an approach that's easy to generalize other packages we might want a purego version of.

--- Comment #13 by gopherbot ---
Change https://go.dev/cl/468795 mentions this issue: `hash/maphash: add purego implementation`

--- Comment #14 by shehackedyou ---
This ultimately will make a novice programmers try to use binaries from system commands; and instead will be able to build proper libraries around ABIs from C libraries; this project may have a specific scope for you but overall this is pretty massive for the Go community; it will make it both easier and faster to use C tools which was becoming a problem. 

--- Comment #15 by adonovan ---
In https://go.dev/cl/657297, @FiloSottile proposes restoring the use of linkname in hash/maphash, to break the dependency from it to crypto/rand. Unless anyone objects, I propose to do this. Speak now or forever hold your peace. ;-)

--- Comment #16 by adonovan ---
Well y'all are a quiet bunch, I must say. ;-)

@dmitshur helpfully directed my attention to this line:

> gopherbot locked and limited conversation to collaborators on Jan 7

Please comment on https://go.dev/cl/657297 if you have anything to add.


