=== Fetching Proposal: MDU6SXNzdWU4OTcxNTg2MDA= ===
Issue URL: https://github.com/golang/go/issues/46293

==== [Issue Title] ====
reflect: add MapIter.Reset

==== [Issue Body] ====
Currently, iterating over a map requires two allocations: A reflect.MapIter and a runtime.hiter. By embedding a runtime.hiter (or rather, a type with the same shape and size) in a reflect.MapIter, it is possible to eliminate the second allocation. If we could re-use a reflect.MapIter to iterate over multiple maps, then we could eliminate the first allocation as well.

I propose that we add:

```go
// Reset changes iter to iterate over v.
// It panics if v's Kind is not Map and v is not the zero Value.
func (iter *MapIter) Reset(v Value)
```

Allowing v to be the zero Value enables the caller to avoid pinning whatever map iter was previously iterating over.

Note that these two would be equivalent:

```go
iter := new(reflect.MapIter)
iter.Reset(mapVal)
```

```go
iter := mapVal.MapRange()
```

cc @bradfitz @randall77 


==== [Comments] ====

--- Comment #1 by dsnet ---
> Currently, allocating over a map requires two allocations:

Did you mean to say "iterating" over a map instead?

--- Comment #2 by josharian ---
@dsnet I did. Thanks, fixed.

--- Comment #3 by gopherbot ---
Change https://golang.org/cl/321891 mentions this issue: `reflect: add MapIter.Reset`

--- Comment #4 by gopherbot ---
Change https://golang.org/cl/321890 mentions this issue: `reflect: improve panic when MapIter has no associated map Value`

--- Comment #5 by gopherbot ---
Change https://golang.org/cl/321889 mentions this issue: `reflect: allocate hiter as part of MapIter`

--- Comment #6 by rsc ---

This proposal has been added to the [active column](https://golang.org/s/proposal-status#active) of the proposals project
and will now be reviewed at the weekly proposal review meetings.
â€” rsc for the proposal review group


--- Comment #7 by rsc ---
Does anyone object to this proposal?


--- Comment #8 by randall77 ---
Seems ok to me.

I think there is a small issue with calling `Reset` for a map of different type. It constrains somewhat how we represent an `hiter` inside the compiler. We don't do any such thing currently, but we could for example embed the key by value instead of by pointer. Then on a reset with a different type we'd need to reallocate the `hiter` which is what you're trying to avoid. But this is all hypothetical and even in the worst case means reflect map iteration would at most become slow/allocatey again.


--- Comment #9 by rsc ---

Based on the discussion above, this proposal seems like a **[likely accept](https://golang.org/s/proposal-status#likely-accept)**.
â€” rsc for the proposal review group


--- Comment #10 by rsc ---

No change in consensus, so **[accepted](https://golang.org/s/proposal-status#accepted)**. ðŸŽ‰
This issue now tracks the work of implementing the proposal.
â€” rsc for the proposal review group


--- Comment #11 by gopherbot ---
Change https://go.dev/cl/400675 mentions this issue: `reflect: make Value.MapRange inlineable`
