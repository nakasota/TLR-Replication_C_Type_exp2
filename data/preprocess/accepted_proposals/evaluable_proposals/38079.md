=== Fetching Proposal: MDU6SXNzdWU1ODgwMDY0MzA= ===
Issue URL: https://github.com/golang/go/issues/38079

==== [Issue Title] ====
net/http/httputil: do not add to empty X-Forwarded-For header in ReverseProxy

==== [Issue Body] ====
### What version of Go are you using (`go version`)?

<pre>
$ go version
go version go1.13.8 linux/386
</pre>

### Does this issue reproduce with the latest release?

Yes

### What operating system and processor architecture are you using (`go env`)?

<details><summary><code>go env</code> Output</summary><br><pre>
$ go env
GO111MODULE="on"
GOARCH="386"
GOBIN="~/go/bin/"
GOCACHE="~/.cache/go-build"
GOENV="~/.config/go/env"
GOEXE=""
GOFLAGS=" -mod=vendor"
GOHOSTARCH="386"
GOHOSTOS="linux"
GONOPROXY=""
GONOSUMDB=""
GOOS="linux"
GOPATH="~/go"
GOPRIVATE=""
GOPROXY="direct"
GOROOT="/usr/local/go1.13"
GOSUMDB="sum.golang.org"
GOTMPDIR=""
GOTOOLDIR="/usr/local/go1.13/pkg/tool/linux_386"
GCCGO="gccgo"
GO386="sse2"
AR="ar"
CC="gcc"
CXX="g++"
CGO_ENABLED="1"
GOMOD="~/git/go.mod"
CGO_CFLAGS="-g -O2"
CGO_CPPFLAGS=""
CGO_CXXFLAGS="-g -O2"
CGO_FFLAGS="-g -O2"
CGO_LDFLAGS="-g -O2"
PKG_CONFIG="pkg-config"
GOGCCFLAGS="-fPIC -m32 -pthread -fmessage-length=0 -fdebug-prefix-map=/tmp/go-build275301714=/tmp/go-build -gno-record-gcc-switches"
</pre></details>

### What did you do?

I'm simply using the `ReverseProxy` (https://github.com/golang/go/blob/master/src/net/http/httputil/reverseproxy.go) to implement an HTTP proxy. By default, and as documented, `ReverseProxy automatically sets the client IP as the value of the X-Forwarded-For header. If an X-Forwarded-For header already exists, the client IP is appended to the existing values.`. In our situation, the proxy should be transparent and invisible to the servers, so we'd like the proxy not to add any headers to the HTTP requests he forwards. Unfortunately, there is no option to disable the addition of the `X-Forwarded-For` header. Unless I'm mistaken, there is also no way to remove this header manually before messages are forwarded (like through a hook or something that is called at some point). 

### What did you expect to see?

An option in the `ReverseProxy` struct to disable the `X-Forwarded-For` header. For example, something like `disableForwardedForHeader bool`, which would be `false` per default, that means that the behavior stays like now. If `true`, the proxy wouldn't set the `X-Forwarded-For` header, through, e.g., `if !p.disableForwardedForHeader` at line 246 of https://github.com/golang/go/blob/master/src/net/http/httputil/reverseproxy.go. 

Another option would be to add a hook that can modify the request just before the proxy sends/forwards it. That would actually be a more elegant and general solution. That could be the current `Director` hook, but then it should be called later in the `ServeHTTP` function, i.e., just before `transport.RoundTrip(outreq)`. Not sure if that would have any other bad impact. In any case, another hook is possible.

### What did you see instead?

No option and the proxy always sets the `X-Forwarded-For` header. 

==== [Comments] ====

--- Comment #1 by rsc ---
Discussed with @bradfitz. Looks like if Header["X-Forwarded-For"] is a present nil (that is, not missing from the map entirely, but empty) today, you'd end up with "X-Forwarded-For: , 1.2.3.4" (with an empty string before the comma). We could redefine a present nil to mean don't add anything to the header. We do that elsewhere in net/http already, so it is what a user might try even without docs. Maybe that's the way forward?


--- Comment #2 by AmoVanB ---
I think that could make sense. Especially as the current situation of having a "X-Forwarded-For: , 1.2.3.4" header does not really make sense.

--- Comment #3 by rsc ---
It sounds like the proposal two comments up (don't add to an already-empty X-Forwarded-For) would fix the problem and that people are at least not objecting. I've retitled.

Does anyone object to doing this?


--- Comment #4 by rsc ---
Based on the discussion, this seems like a **likely accept**.


--- Comment #5 by gopherbot ---
Change https://golang.org/cl/230937 mentions this issue: `net/http/httputil: don't append to X-Forwarded-For in ReverseProxy when nil`

--- Comment #6 by gopherbot ---
Change https://golang.org/cl/230937 mentions this issue: `net/http/httputil: don't append to X-Forwarded-For in ReverseProxy when nil`

--- Comment #7 by rsc ---
No change in consensus, so accepted. (CL committed already.)

