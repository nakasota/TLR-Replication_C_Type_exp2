net/http/httputil: add x-forwarded-proto x-forwarded-host default
go' http `reverseproxy` basic forward header support, support incomplet even dangerous:
* `x-forwarded-for` set automatically, request alreadi contain `x-forwarded-for` header, client ip ad exist header valu (the ip previou proxi chain). behavior undocumented, alreadi led ip spoof vulnerabilities. document behavior vulner project creat document ad probabl exist wild.
* `x-forwarded-for` automat set, `x-forwarded-proto` `x-forwarded-host` not, weird.
* disabl `x-forwarded-for` support obvious, look hackish: manual delet potenti exist header forward request. edit: use `nil` prevent header set:
* legaci non-standard `x-forwarded-for` supported, standard `forwarded` header (rfc 7239) isn't.
propos add two new public field `reverseproxy` struct control behavior regard forward headers:
```go
type ForwardedHeaderBehavior uint8
const (
	// Overwrite existing forwarded HTTP headers,
	// depending on the value of ReverseProxy.ForwardedHeaderFormat,
	// with values extracted from the current connection with the client.
	// Headers explicitly set to nil are never modified.
	ForwardedHeaderOverwrite ForwardedHeaderBehavior = iota
	// Adds values to the existing forwarded HTTP headers,
	// depending on the value of ReverseProxy.ForwardedHeaderFormat,
	// with values extracted from the current connection with the client.
	// If ForwardedHeaderLegacy is used, client IP is added to X-Forwarded-For
	// and the values of X-Forwarded-Proto and X-Forwarded-Host are preserved.
	// Headers explicitly set to nil are never modified.
	// Ensure that the previous proxies in the chain are trusted when using this value, or it will lead to security issues.
	ForwardedHeaderAdd
	// Preserve all existing forwarded HTTP headers.
	// Ensure that the previous proxies in the chain are trusted before using this value, or it will lead to security issues.
	ForwardedHeaderPreserve
)
type ForwardedHeaderFormat uint8
const (
	// Set the X-Forwarded-For, X-Forwarded-Proto and X-Forwarded-Host headers (Forwarded will be left as-is)
	ForwardedHeaderLegacy ForwardedHeaderFormat = iota
	// Set the Forwarded HTTP header (X-Forwarded-For, X-Forwarded-Proto, and X-Forwarded-Host will be left as-is)
	ForwardedHeaderRFC7234
)
type ReverseProxy struct {
	ForwardedHeaderBehavior ForwardedHeaderBehavior
	ForwardedHeaderFormat ForwardedHeaderFormat
}
```
technic bc break, default behavior overwrit exist `x-forwarded-*` headers, wherea current client ip **added** (usual unexpectedly) exist valu `x-forwarded-for`. opinion, worth harden api prevent secur issues. bc break unacceptable, revers order `forwardedheaderoverwrite` `forwardedheaderadd` (but default insecur behavior persist).
support legaci xff header necessari current ecosystem support these. standard version wide adopt far.
ad support standard header requir work probabl requir write custom parser. suggest implement support `forwardedheaderbehavior` first fix current behavior, ad support `forwardedheaderformat` later.
alreadi draft patch implement first part:
cc @neild @bradfitz
want add special-purpos api general-purpos one suffice. also want add knob enabl right behavior; default behavior `reverseproxy` wrong, fix it.
think make sens add `x-forwarded-proto` `x-forwarded-host` automatically. header de facto standard useful. sinc add `x-forwarded-for` default, may well add too. user abl disabl fashion `x-forwarded-for`, set appropri entri `request.header` map `nil`.
might make sens add rfc 7239 `forwaded` header automatically. good sens much use header see wild vs. `x-forwarded-proto` `x-forwaded-host`. inclin leav now.
probabl append exist `x-forwarded-for` header rather replac wrong default. (usually) want append header forward request anoth trust proxy, replac forward request untrust source. `reverseproxy` document recommend delet incom `x-forwarded-for` untrust sourc reason. perhap chang default.
file #50580 address unrel issue, propos replac `director` function `modifyrequest` function accept inbound outbound requests. add `modifyrequest`, perhap chang default handl `x-forwarded-for` use function leav `director` unchanged.
summarize:
* think add `x-forwarded-proto` `x-forwarded-host` default.
* think add `forwarded` default. (but could convinc otherwise.)
* think add `forwardedheaderbehavior` `forwardedheaderformat` knob `reverseproxy`. user want chang header sent proxy, within `director` function (or `modifyrequest`, added).
* perhap chang default behavior append `x-forwarded-for` rather overwrit it.
> good sens much use header see wild vs. `x-forwarded-proto` `x-forwaded-host`.
experience, almost tool support xff headers, support `forwarded`. agre support `forwarded` time. however, may interest move ecosystem forward adopt standard. future, perhap could provid `director`/`modifyrequest` function (which would call default) switch `forwarded` instead use xff?
> reverseproxi document recommend delet incom `x-forwarded-for` untrust sourc reason. perhap chang default.
author documentation. behavior documented, was/i probabl secur vulnerability.
total favor chang default behavior. use new function good idea, prevent potenti break change. drawback see old code written author awar behavior (code written ad documentation) continu insecure.
work you, updat patch keep addit `x-forwarded-proto` `x-forwarded-host`. remov everyth els let chang default behavior `x-forwarded-for` implement #50580 (which good move, way).
/cc @neild
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
> perhap chang default behavior append x-forwarded-for rather overwrit it.
> use new function good idea
`reverseproxy` internet-facing, new `modifyrequest` used, use deeper layer, `director` must use order preserv xff header ad first instance? seem eleg first glanc (and seem error-pron hard explain). semant differ `director` `modifyrequest` make make sense?
> (usually) want append header forward request anoth trust proxy, replac forward request untrust source.
idea come around automat append overwrit depend sourc trust not, need configur avail indic what' "trusted". (for setup "ip.isprivate() => trusted". other use cloudflar like need list ip ranges.)
(i'm big fan overwrit xff list, legitim non-secur use leftmost-ish xff ip. complet take option away user seem unfortunate. hand use leftmost security-rel purpos big, widespread problem. mayb take option away user suffici overal improv loss flexibl justified.)
eta: overwrit xff, nine ten time set single-ip header like x-real-ip instead.
seem clear reverseproxi right certain contexts, know right path forward it.
perhap right next step put hold (or declin it) suggest peopl fork reverseproxi experi copies?
seem like declin clearer idea path forward (or new package).
actually, jan 12, @neild wrote
> think add x-forwarded-proto x-forwarded-host default.
make separ proposal? make propos that?
make propos that, easili adapt patch this.
retitled. anyon object ad x-forwarded-proto x-forwarded-host default?
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
chang consensus, **accepted**. ðŸŽ‰
