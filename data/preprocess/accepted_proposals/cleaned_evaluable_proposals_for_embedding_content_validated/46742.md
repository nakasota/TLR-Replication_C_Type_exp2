unsafe: double-check specifi semant slice((*t)(nil), 0) go 1.17
#19367, ultim specifi `slice(ptr, len)` mean `(*[len]t)(unsafe.pointer(ptr))[:]`. consequ `slice((*t)(nil), 0)` panics, `(*[0]t)(nil)[:]` panics. however, user would probabl prefer instead evalu `[]t(nil)`, chang semant suggest #19367.
prior discuss issue, point `ptr == nil && len > 0` failur case consider, perhap impli expect behavior would `slice((*t)(nil), 0)` evalu `[]t(nil)`. see specif mention "nil" discussions.
option see:
1. leav current semantics, match `(*[0]t)(nil)[:]`. chang futur requir condit `-lang` (e.g., function appear sourc packag compil `-lang=go1.17` would panic, would return `nil` compil `-lang=go1.18`; think allow use `-lang`, would first backward incompat chang tie `-lang`).
2. leav current semantics, tweak word say `ptr` must non-nil, sidestep issu go 1.17 let us decid semant future. probabl continu panicking, make `-d=checkptr` throw instead emphas realli specified.
3. chang semant go 1.17 return `[]t(nil)`, intent diverg `(*[0]t)(nil)[:]` special case.
file releas block issu make sure agre option go 1.17.
ğŸ‘/ğŸ‘: option 1: keep current semant go 1.17 (i.e., `slice((*t)(nil), 0)` panics, like `(*[0]t)(nil)[:]`).
ğŸ‘/ğŸ‘: option 2: chang semant unspecifi go 1.17 (i.e., `slice((*t)(nil), 0)` may panic, throw, return nil go 1.17; decid what' best go 1.18).
ğŸ‘/ğŸ‘: option 3: chang `slice((*t)(nil), 0)` return `[]t(nil)` go 1.17 (i.e., intent diverg `(*[0]t)(nil)[:]`).
option 4 placeholder.
option 5 placeholder.
`[]int((*[0]int)(nil))` panic `[]int((*[1]int)(nil))` panics. think agre that' fine, least one complain decad way.
defin unsafe.slic term convers nice shorthand. right rule "you can't use nil". question whether rule "you can't use nil, except zero can". seem like old convers new one consist least. seem littl late chang old one though, although could mayb consid go 1.18 peopl felt strongly.
hand weird unsafe.slic incap creat slice == nil. seem like that' signific hole.
discuss @griesem @iant okay allow unsafe.slice((*t)(nil), 0) == []t(nil) go 1.17.
anyon object this?
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
quiet week hold propos review juli 12.
given discuss fact one respond object comment june 16, overwhelmingli like outcom move like accept juli 12 accept juli 19.
given
(1) much like go accepted,
(2) would like releas candid match final go 1.17 behavior,
go make except usual procedur approv commit chang ahead approval. unforeseen reason declin proposal, easi roll back. like case accept it, make chang make releas candid match final release.
@mdempsky, pleas go ahead make change. run gotcha considered, pleas let us know. thanks!
chang mention issue: `spec: chang unsafe.slice((*t)(nil), 0) return []t(nil)`
chang mention issue: `cmd/compile,runtime: chang unsafe.slice((*t)(nil), 0) return []t(nil)`
code chang now. assum technic still releas blocker ratifi chang made, hinder releas release-candidate. /cc @toothrot
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
chang consensus, **accepted**. ğŸ‰
