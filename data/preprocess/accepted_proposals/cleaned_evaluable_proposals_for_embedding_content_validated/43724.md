os/exec: return error path lookup would use current directori
recent publish new packag golang.org/x/sys/execabs, forward wrapper around os/exec make three changes:
- execabs.lookpath chang result exec.lookpath case path search return execut current directori (dot). case, execabs.lookpath return error instead. error text ‚Äúprog resolv execut current directori (./prog)‚Äù
- execabs.command chang result exec.command case. arrang subsequ cmd.run cmd.start return error.
- execabs.commandcontext same.
yet anoth possibl answer ‚Äúwhat path lookup windows‚Äù saga, perhap chang os/exec thing default. file propos help us discuss decid whether take path. (for background, see blog post
propos summar ‚Äúreplac os/exec golang.org/x/sys/execabs‚Äù.
recap got here, fundament problem lot go program thing like `exec.command("prog")` expect prog come system directori list path. surpris case secur problem window prog taken dot instead prog.ex (or prog.bat, prog.com, ...) exists. true unix user explicit dot empty-str element path.
alreadi three issu possibl approach solv problem. are:
- #38736, remov implicit dot lookup lookpath window
- #42420, add lookpathab return rel results.
- #42950, make exec.command use lookpathab default (assum added)
problem #38736 silent chang behavior program windows. `exec.command("prog")` previous found ran `.\prog.exe`, would either silent switch `prog.exe` path (surprise!) return error `prog` could found (even though use be; confusion!). true `exec.lookpath`.
#42420 avoid problem chang exist behavior introduc new function `exec.lookpathabs` never look dot. clearli doesn‚Äôt surpris confus anyone. also doesn‚Äôt fix secur problems.
#42950 extend #42420 chang `exec.command` use `exec.lookpathabs` default. bring back surpris confus #38736, `exec.command` `exec.lookpath`. compar #38736, #42420+#42950 ad complex ad new api (`lookpathabs`).
none great.
propos issue, adopt execab semant os/exec semantics, fix problems. execab doesn‚Äôt _remove_ dot path lookup. instead report use dot error. avoid surpris run differ program. report error clear happened. instead gener ‚Äúprogram found‚Äù give error avoid confusion:
prog resolv execut current directori (./prog)
cours program current directori executed, fix secur problem too.
specif chang issu propos os/exec are:
- add new `var errdot = errors.new("execut current directory")`
- chang `lookpath`: would chosen `return path, nil` path execut current directori found path lookup, `return path, err` `err` satisfi `errors.is(err, errdot)`.
- chang `cmd`: add new field `err error` return `start` `run` set. field replac current unexport field `lookpatherr`.
consid client code:
path, err := exec.lookpath("prog")
err != nil {
log.fatal(err)
}
use(path)
cmd := exec.command("prog")
err := cmd.run(); err != nil {
log.fatal(err)
}
propos changes, code would longer find run `./prog` unix (when dot path), `.\prog.exe` window (regardless path), address secur issue.
program want requir current directori use (ignor path) chang `"prog"` `"./prog"` (that work unix window systems). chang (`"prog"` `"./prog"`) compat older version `os/exec`.
program want allow use current directori conjunct path add new line code, mark `<<<`:
path, err := exec.lookpath("prog")
errors.is(err, exec.errdot) { // <<<
err = nil // <<<
} // <<<
err != nil {
log.fatal(err)
}
use(path)
cmd := exec.command("prog")
errors.is(cmd.err, exec.errdot) { // <<<
cmd.err = nil // <<<
} // <<<
err := cmd.run(); err != nil {
log.fatal(err)
}
give program flexibl opt back old behavior necessary.
course, chang (ad `errors.is` checks) compat older version `os/exec`, expect need rare. expect program intent run program current directori updat `./prog` form.
window users, would propos break programs?
check today replac
import "os/exec"

import exec "golang.org/x/sys/execabs"
sourc code. chang need get effect. (of course, golang.org/x/sys/execab provid `errdot`, `errors.is` stanza cannot written simul proposal.)
thoughts? comments? concerns? thank much.
part time window user, think expect `exec.command("prog")` work way expect launch stuff `cmd.exe`. `cmd.exe` behavior surprising, alreadi set stone sever decad ago.
understand `cmd.err` field necessary. workaround program instead written
```go
	const short = "prog"
	actual := short
	if abs, err := exec.LookPath(short); errors.Is(err, exec.ErrDot) {
		actual = abs
	}
	cmd := exec.Command(actual)
	cmd.Args[0] = short
```
?
thank detail description, @rsc!
propos would adopted, write follow code would safe run insid untrust directory?
```go
c := exec.Command("git", "status")
s, err := c.Output()
```
proposal, current directori `.\git.exe` `.\git.bat` (or similar file match pathexts), run command would result failure. sinc might legitim reason current directori could contain `git.bat`, would option instead execut git found system path instead current directory?
understand propos meant prevent silent failur program reli window behavior. wondering, propos get accepted, option run command untrust directori (i.e. content current directori entir ignored)? might propos ship tandem
addit context, recent updat go 1.15.7 (which includ secur patch issue) broke build-tim script run mac and/or linux systems. build process intent `go install` build tool `<project-dir>/bin` (in order avoid instal local tool "global" directori happen appear `$path`) prepend `<project-dir>/bin` `$path`. `//go:gener custom-tool ....` direct .go sourc file within project, obviou expect find `custom-tool` binari "installed" `<project-dir>/bin`.
unfortun me, run `go gener ./...` project root fail error says:
```
custom-tool resolves to executable in current directory (./bin/custom-tool)
```
suggest workaround prepend `./` (or `./bin/` case) would work make `go:generate` direct sensit directori `go generate` run from, i.e. `go:generate` direct sub-packag would work `go generate` run project root fail command run sub-packag directory.
fulli understand secur concern here, take issu premis **all** situat involv execut binari resid within current directori invalid. chang go, approxim 800 `go:generate` direct need investig see whether broken.
@dylan-bourqu use absolut path bin directori proper fix situation?
```sh
# assuming this is set from tooling in the root of the project
export PATH=$(pwd)/bin:$PATH
```
@seankhliao assumpt correct. `export path=$(pwd)/bin:$path` project-level `makefile` expect `go gener ./...` find variou tool location.
issu inject absolut path `//go:generate` direct absolut path everi machine.
said, seem like updat direct use `//go:gener ../../custom-tool .....` would technic work introduc $pwd sensit mentioned.
@dylan-bourque, `go:generate` direct sensit `$pwd`. per `go:generate` design doc, emphasi added:
> _command_ gener (such `yacc`) run, correspond execut file run locally; must either shell path (`gofmt`) fulli qualifi (`/usr/you/bin/mytool`) **and run packag directory**.
(and note current use exactli approach go standard library: see
mine sensit `$pwd` before. command run alway locat via shell path, went way ensur would correct commands.
longer case go 1.15.7, though. `//go:gener custom-tool ....` command work yesterday fail today.
> run packag directori
see confus now.
test, ad `//go:gener echo pwd $pwd` sub-packag ran `go gener ./...` project root. output project root directory, sub-package. howev `//go:gener ls -l` show content sub-packag folder.
even new information, though, still hundr `go:generate` direct work perfectli need check potenti updat includ rel path command binary. ‚òπÔ∏è
think point stand everi invoc command within current directori treat malicious, though.
@rsc propos help case want catch case local execut file. help case want `lookpath` ignor local execut look %path%: propos provid `lookpathignoredot` still forc use altern version whole `os/exec` package.
concret example: `goeval` project want run `go run` compil go sourc file. `golang.org/x/sys/execabs` catch secur issu `go.bat` current directory, that' help users. need instead `exec.command` lookup `go` _only_ `%path%`. want unix behavior (which window user opt-in non-go program `needcurrentdirectoryforexepathw`).
_update_: look like option vendor _both_ `os/exec` `golang.org/x/sys/execabs` project (with patch version `lookpath` want) get behavior need.
_updat 2_:
```
$ GOOS=windows GOARCH=amd64 go list -deps . | grep exec
internal/syscall/execenv
os/exec
golang.org/x/sys/execabs
internal/execabs
```
also vendor `internal/execabs`?
@dolmen, yes, "do non-standard path lookup". "do standard path lookup refus insecur result". note above, problem "do non-standard path lookup" silent differ standard system behavior, caus mysteri confusion.
> golang.org/x/sys/execab catch secur issu go.bat current directory, that' help users.
user realli probabl delet go.bat. goeval trip it, someth els will.
think would fine, independ change, respect presenc nodefaultcurrentdirectoryinexepath environ variable. variabl found environment, lookpath would never look dot secur check would never trigger.
@bcmills, cmd.err strictli necessari - user call lookpath - error-pron assum result lookpath valid input exec.command. gener that' true, sinc lookpath return clean path, `go` `./go`. is, `abs` code snippet alway absolut path. far easier less error-pron appli check exec.command lookup instead keep two lookup sync.
also, two packag (execab safeexec) function exec.command-workalik hamper abl set err themselves. safeexec use not-as-nic api execab use ugli reflection. better expos err let futur wrapper need do. field (lookpatherr) setup field exec.command that' exported.
@dylan-bourqu sound like somehow
//go:gener path=./bin:$path foo ...
instead write
//go:gener ./bin/foo ...
?
@rsc bunch `//go:gener foo ...` (no `./` prefix). `foo` explicitli instal project-level `bin/` folder `makefile` that' invok `go gener ./...` pre-pend `$pwd/bin` `$path` direct find "right" `foo` path search.
concret example, one tool `protoc-gen-go`, gener code coupl librari code correspond version gener used. lot project feasibl guarante everi one alway use exact version `google.golang.org/protobuf`. go modul actual address issu us, mean can't instal `protoc-gen-go` binari `$gopath/bin` differ project bound differ versions. order solv that, build process configur instal `protoc-gen-go` `<projectdir>/bin` `export path=$pwd/bin:$path` project' `makefile` one invok exact version bound via `go.mod`.
secur fix go 1.14.4 1.15.7, look updat signific number `//go:generate` direct includ explicit rel path prefix (`./bin/`, `../bin/`, `../../bin/`, etc.) tool(s) invoked.
point intent place execut within current directori explicitli configur environ binari invok (just like anyon would shell script, etc.). propos chang treat **any** binari within $pwd malici will, opinion least, break valid use cases.
> makefil that' invok go gener ./... pre-pend $pwd/bin $path direct find "right" foo path search.
\$pwd absolut path due mistak `go generate`, fix that.
@rsc (make `$pwd` correct `go generate`) issu @bcmill submit above. fulli cover scenario, though. invok custom gener tool explicit path (rel absolute) expect resolv via `os.lookpath`. sinc intent instal tool `$pwd/bin` (for reason mention before), chang 1.14.4/1.15.7 introduc new failur case resolv path tool end `$pwd/bin/foo`
@dylan-borque, $pwd absolut resolv $pwd/bin/foo fine, right?
except discuss around go generate, reaction seem overwhelmingli favor, kind chang land earli cycle. sound like consensu accept proposal.
right?
outstand concern would inabl ignor current directori path search, mention previou comments. primari secur issu address avoid potenti malici execut current directory, possibl transform less sever denial-of-service. rather caus execut malici code, hypothet attacker' rogu file prevent go-impl servic perform function. however, propos separ respect nodefaultcurrentdirectoryinexepath environ variabl would overcom that.
might conveni avoid new error dot explicitli present path, though one could certainli achiev via addit applic code conjunct errors.is(err, exec.errdot). think forese use case work, new scenario normal discouraged/"bad" practic take addit effort enable.
> @dylan-borque, $pwd absolut resolv $pwd/bin/foo fine, right?
@rsc yes, caveat exist direct form `//go:gener foo ....` need explicitli updat `//go:gener $pwd/bin/foo ...` instead.
object premis **any** binari happen `$pwd` treat malicious. exampl go gener specif scenario intent set environ want precis behavior (find binari `$pwd` `$path` lookup) treat malicious..
move forward this, would suggest that, minimum, potenti break chang call promin releas notes.
`//go:gener $pwd/bin/foo ... ` work windows.
follow question: new error occur when/if result path absolut still within `$pwd`. ask one `//go:generate` direct fail updat `makefile` `export path=$pwd/bin:$path` instead `export path=./bin:$path` "fixed" it. still find binari place, error occur pre-pend absolut path rather rel one `$path`.
@dylan-borque, yes, error happen rel path entries. sorri clear. absolut path entri alway respected, even describ current directory. yes, expect updat makefil use $pwd/bin:$path instead ./bin:$path (the latter stop usabl cd differ directory).
base discuss above, propos seem like **like accept**.
‚Äî rsc propos review group
chang consensus, **accepted**. üéâ
