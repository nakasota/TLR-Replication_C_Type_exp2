cmd/go: 'go run' run execut modul mode outsid modul
#40276 implement `go instal path@version` instal go binari outsid module. propos support ad `go run`, equival behavior. is,
```
$ go run gioui.org/cmd/gogio@d5bdf0756a5a
```
build run `gioui.org/cmd/gogio` program version `d5bdf0756a5a`
`go install` enough uses? consid readm describ build use auxiliari go program:
> build xyz android app need use `gogio` tool:
>
> $ export path=$path:$gopath/bin
> $ go instal gioui.org/cmd/gogio@d5bdf0756a5a
> $ gogio -target android example.com/cmd/xyz
readm sever issues:
1. `go install`' binari reproducible, run isn't. example, user may old `gogio` path already, fail run instruct `go install`. may remember, later instal differ version `gogio`.
2. `go install` polut user' gopath/bin, path includ gopath/bin.
3. gopath set, readm contain hardcod path (~/go/bin).
contrast, `go run path@version` support, readm reduc just:
>to build xyz android app need use `gogio` tool:
>
>$ go run gioui.org/cmd/gogio@d5bdf0756a5a -target android example.com/cmd/xyz
cc @bcmill @jayconrod @ianthehat given previou discuss
consid alternative:
```
example.com$ GOBIN=$(pwd) go install gioui.org/cmd/gogio@d5bdf0756a5a
example.com$ ./gogio
gogio: specify a package
```
problem (namely, `$(pwd)` portable), make clear subsequ invoc user re-invok compil binari rather re-resolv recompil upstream.
allow `go build` accept `@version` syntax, could made portable:
```
$ go build -o ./gogio.exe gioui.org/cmd/gogio@d5bdf0756a5a
$ ./gogio.exe
```
`go install` thing portable, vari execut filename, think ad support `go build` would mistake, think would rather see us add `-o` `go install` going.
one use case find interest talk write reproduc gener line
```
  //go:generate go run golang.org/x/tools/cmd/stringer@v1.2.3 -type=Pill
```
> `go install` thing portable, vari execut filename, think ad support `go build` would mistake, think would rather see us add `-o` `go install` going.
> one use case find interest talk write reproduc gener line
>
> ```
> //go:gener go run golang.org/x/tools/cmd/stringer@v1.2.3 -type=pil
> ```
sever invoc tool, duplic `@version` modifier?
omit go:gener use-cas propos think better depend record go.mod file use idiom `_`-import tool `tools.go` file.
would duplic `@version` modifi problem?
_ import bad caus tool modifi version select main application, also pull thing depend graph binari actual depend on. also caus tool affect other, rather run version author test with. gener accept hack better answer, long term accept solut opinion.
cc @matloob well.
person favor `go run` support semant restrict #40276. came time discuss #40276. let' set asid `go build`.
technic barrier need cach link binari differ evict polici compil packages. currently, cach link binari all.
that, question cli design impact ecosystem.
> would duplic `@version` modifi problem?
>
refer updat version want newer version tool. mayb that' bad.
> _ import bad caus tool modifi version select main application, also pull thing depend graph binari actual depend on. also caus tool affect other, rather run version author test with. gener accept hack better answer, long term accept solut opinion.
good points. ideal world, go:gener depend record go.mod, downsid point seem outweigh advantages.
think reason common pattern `//go:gener go run package@vers args...` could easili write tool maintain line separ turn needed.
> gener accept hack better answer, long term accept solut opinion.
argument depend vari version test author might equal appli third parti librari using, sway argument me. fact that, scheme, would multipl site maintain tool version real problem however. use tool mean limit `go:generate` directives, e.g. scripts.
signific differ librari want includ code share depend librari graph, binari want run exactli author intend run. modul stori focus former (for good reason) exist approach left peopl happi result latter, one reason talk kind changes.
mostli uninterest script makefil think alreadi tool need, path instal hack good enough cases, might beauti need extra lines, find big deal.
> argument depend vari version test author might equal appli third parti librari using, sway argument me. fact that, scheme, would multipl site maintain tool version real problem however. use tool mean limit `go:generate` directives, e.g. scripts.
also see signific differ depend librari instal releas version binary.
depend librari mean take ownership librari fit dep graph suffici test code confid potenti uniqu dep graph.
never want modifi releas binary' dep base independ local code developing. need modifi dep releas binari either process fork contribut upsteam project directly. want control dep code current author only. build main packag outsid current project want univers reproduc artifact much possible.
may duplic
upsid use _ import tool extra dependabot notif time updat linter code gener tools.
afraid `//go:gener go run package@vers â€¦` open door extra inconsist much flexibl - realli like idea use multipl version tool singl project/modul and/or get extra headach keep version sync. so, run tool version defin go.mod default probabl better way go.
also, whole stori gobin, go instal go run tool one big downside: tool written go, better gener (non-go-specific) way express tool depend run requir tool version. probabl offtop here.
discuss bit golang-tool session week.
personally, favor proposal, sound like other call well. main point `go run pkg@version` build binari `go instal pkg@version` would build. differ would `go run` execut binari instead write `gobin`. would differ semant use resolv version restrict `replace` directives.
move forward though, think two thing need resolved:
1. need firm agreement done `replace` `go instal pkg@version` `go run pkg@version`. discuss length #40276. 1.16, `go install` report error `replace` direct present `go.mod` file modul provid name packages. elimin ambiguity, leav door open behaviors. experi 1.16 inform later on: keep new behavior, ignor `replace` directives, appli `replace` direct others.
2. need chang build cach evict algorithm. binari link `go run` cach littl repeat `go run` command need re-link.
> experi 1.16 inform later on: keep new behavior, ignor `replace` directives, appli `replace` direct others.
agre pretti much everyth said, also say `go run pkg@version` current "no replaces" semant would still use lot modules. even can't figur advanc replac directives, still think worth teach `go run` new behavior 1.17.
date resist cach execut _specifically_ avoid turn go run kind binari manag system. littl unfortun trend way.
jay ask elabor previou comment person, thought would too.
gener speaking, wall garden less power open platforms. plan 9 wall garden - run mani unix program need variou system calls. inferno wall garden - even run non-limbo programs. even wsl wall garden sorts: linux program run insid can't easili invok window program outsid it. run vmware, vm bit wall garden, way. cases, there' good reason wall - thing simpler insid way - cost isol loss interoperability.
go aim interoper well surround oper system, explicitli _not_ make wall garden. why, example, ad io/fs, explicit fs interfac use access virtual files. obviou extens would let say thing like mount(zipfile, "/myzip") os.open("/myzip/file") open file insid zip file. that' well good insid go process memory, happen tri run exec.command("grep", "thing", "/myzip/file")? grep can't find file. work os.open?! there' wall there, grep outsid wall. oper system alreadi provid file system. go replac concept "the file system defin os" "the file system extend go" make wall. true anyth "file system".
oper system alreadi also concept program instal run. there' $home/bin, $path, apt-get, on. "go install" play nice world write go execut $home/bin, run program, go programs.
consid special-cas "go generate" list go program thing run:
//go:gener golang.org/x/tools/cmd/string ...
(thi propos past.) made work, would look like unix command line actual "the command line extend go". that, can't do:
//go:gener time golang.org/x/tools/cmd/string ...
replac time strace, whatev else. anoth wall. declin propos past: oper system charg provid program avail run, go use definit directly, extend it.
- - -
context, go run program@vers seem creep close line creat wall. quit cross line, essenti replac standard oper system mechan $path $home/bin, apt-get, homebrew, on, altern command distribut mechanism. mechan work go programs. can't put rust program there. (in sense, actual cross line.)
counter-argu least "go run program@version" real unix command, `//go:gener go run stringer@version` break "execut command" rule. cours go program make easier run go program (say) rust programs?
- - -
run execut like make go start supplant apt-get, homebrew, etc. course, counter-argu "go install" alreadi little, "go run" "go instal + exec" alreadi burn bridges.
- - -
say pretti borderlin decision. inclin refus strong consensu it, want us go eye open implications.
also understand whether intend appli go run p@v, go accept go test p@v, go build -o myex p@v, on.
oppos arguments, time think `go:generate` problem need solut go toolchain itself. otherwis chicken-and-egg situation.
> "go run" "go instal + exec" alreadi burn bridges.
thought way, agree. `go install` alreadi compet system' way instal programs. and, personally, think that' fine. quit often use `go install` want instal different/new version what' avail system, example, think there' anyth wrong that.
> go accept go test p@v, go build -o myex p@v,
person opinion "no", could alway reconsid futur someon compel use case.
> context, go run program@vers seem creep close line creat wall. quit cross line, essenti replac standard oper system mechan
think miss particular distinct here. `program` coarse, specifi version. caus problam `go:generate`, example. `package-manag instal -version=... program && program` never go portable. `go run program@vers args...` limit go software, thank modul build philosophy, quit powerful.
> ... limit go software, thank modul build philosophy, quit powerful.
absolutely, want us go know put bit wall around power.
> oper system alreadi also concept program instal run. there' $home/bin, $path, apt-get, on. "go install" play nice world write go execut $home/bin, run program, go programs.
> run execut like make go start supplant apt-get, homebrew, etc. course, counter-argu "go install" alreadi little, "go run" "go instal + exec" alreadi burn bridges.
"go run p@v" "go instal + exec p@v": "go run" tamper user' global configur write $home/go/bin. that' exactli want: "run program reproduc version, without instal it". love oper system provid functionality, doesn't, let alon portabl across os'es.
also, apt-get, homebrew etc. can't run programs, instal them. "go instal p@v" replac softwar installers, propos "go run p@v".
suppos understand argument, perhap appli proposal. want argu replac os softwar installers, blame seem entir caus "go instal p@v", "go run p@v". mayb even "go get" command itself?
ok, let tri restat proposal. idea run
go run path@vers
fetch path@version, builds, run it. cours that' cach second time links+run mayb even runs.
happen insid module? go.mod get consulted? form alway bypass go.mod?
guess go instal path@version?
occur know answer either.
/cc @bcmill @jayconrod @matloob
> happen insid module? go.mod get consulted? form alway bypass go.mod?
guess go instal path@version?
form would alway bypass (and never update) current module' `go.mod` `go.sum`, `go instal path@version`.
> happen insid module? go.mod get consulted? form alway bypass go.mod?
guess go instal path@version?
right, semant `go instal path@version` #40276. would run modul mode, ignor `go.mod` `go.sum` current directori present. would main module, would error modul provid packag name `path` `go.mod` direct would caus treat differ main modul (e.g., `replace`).
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
chang consensus, **accepted**. ðŸŽ‰
