flag: exit 0 default -h/-help option
`-help` `-h` flag undefin invoked, `flag` packag handl situat special case print nice help default help text, exit process exit code 2. propos propos exit code 0 default configur specif case.
emphasis: propos __doe not__ propose/incur chang program `-h` `-help` defined.
---
concret example, use `gofmt`, use `flag` packag `-help` `-h` defined, behavior today is:
```
$ gofmt -help
usage: gofmt [flags] [path ...]
  -cpuprofile string
        write cpu profile to this file
<...abbreviated...>
$ echo $?
2
```
propos behavior is:
```
$ gofmt -help
usage: gofmt [flags] [path ...]
  -cpuprofile string
        write cpu profile to this file
<...abbreviated...>
$ echo $?
0
```
chang mention issue: `flag: exit 0 -h -help invok undefined`
program run undefin flag, that' error, invok incorrectly. unless report non-zero error status, error never detected.
hand, explicitli _ask_ help, use _defined_ `-help` `-h` flag, flag, that' fine. that' zero exit statu situation, invok program valid flag asked. explicitli say propos exclud situation.
@bitfield , read second paragraph, think misunderstanding. mean flag `-h` `-help` defined, `flag` package' treatment flag chang exist behavior.
`flag` packag alreadi handl `-h` `-help`, undefined, special case print help message, help gener use case. propos suggest case case only, alreadi handl special case `flag.go`, exit 0 instead 2.
mayb run `gofmt -help`, use `flag`, check exit code see.
no, understand one anoth correctly, think. agre program defin flag `-h`, call program error.
however, program defin `-h`, current behaviour `flag` error. suggest chang this. say current behaviour correct. call program undefin command-lin flag call program incorrectly.
/cc @robpik
problem although recogn -h -help flag, avoid print "unrecogn flag: -help". call f.usage, user-defined. essenti usag function exist os.exit(2). guess would keep exit 2. main flag.pars loop would see errhelp suppos could treat case, provid error handl set exitonerror, os.exit(0) instead os.exit(2).
bit corner case. getopt/argparse/etc agre exit 0 -help, variation?
think good idea specif behavior `-h` `-help`. instanc `-h` mean `-help` command line tools, chang possibl modifi behavior script use command line tool built go.
ignor point above, merit, usefulness, homogen return 0 `-h` present? valu add tool build automation?
@a , propos __doe not__ propos chang go program `-h` `-help` flag defined. further, propos __doe not__ propos homogen return 0 -h present. sorri clear propos description. ad note descript emphas point.
propos use programs, `-h` `-help` flag defined, want/ne default usag print behavior zero exit code flag provided. propos make much easier program (easier, basic get free default), yet without chang anyth program `-h` `-help` flag defined.
@rsc, yes, alreadi corner case proposal. flag.go special handl `h` `help`.
look argpars python3 getopt gnu c, exit 0 program explicitli defin help flag.
<details><summary>gnu c argp </summary>
<p>
```c
#include <stdlib.h>
#include <argp.h>
const char *argp_program_version =
  "argp-ex2 1.0";
const char *argp_program_bug_address =
  "<bug-gnu-utils@gnu.org>";
static char doc[] =
  "Argp example #2 -- a pretty minimal program using argp";
static struct argp argp = { 0, 0, 0, doc };
int
main (int argc, char **argv)
{
  argp_parse (&argp, argc, argv, 0, 0, 0);
  exit (0);
}
```
---
produces:
```bash
$ ./a.out --help
Usage: a.out [OPTION...]
Argp example #2 -- a pretty minimal program using argp
  -?, --help                 Give this help list
      --usage                Give a short usage message
  -V, --version              Print program version
Report bugs to <bug-gnu-utils@gnu.org>.
$ echo $?
0
```
</p>
</details>
<details><summary>python3 argpars </summary>
<p>
```python
import argparse
parser = argparse.ArgumentParser(description='Process some integers.')
parser.add_argument('integers', metavar='N', type=int, nargs='+',
                    help='an integer for the accumulator')
parser.add_argument('--sum', dest='accumulate', action='store_const',
                    const=sum, default=max,
                    help='sum the integers (default: find the max)')
args = parser.parse_args()
print(args.accumulate(args.integers))
```
---
produces:
```bash
$ ./flag.py -h
usage: flag.py [-h] [--sum] N [N ...]
Process some integers.
positional arguments:
  N           an integer for the accumulator
optional arguments:
  -h, --help  show this help message and exit
  --sum       sum the integers (default: find the max)
$ echo $?
0
```
</p>
</details>
exit code usag depend whether "help" "-h" defin application.
```
$ go --help 2> /dev/null
$ echo $?
2
$ go -help 2> /dev/null
$ echo $?
2
$ go -h 2> /dev/null
$ echo $?
2
$ go help > /dev/null
$ echo $?
0
```
argp argpars provid "-h" "--help" automatically. want get exit code 0 -help, defin "-h" self, think.
@sding3, thank check gnu c argp python argparse. @ianlancetaylor say gnu getopt also exit 0 help. one want check that' left bsd getopt, realli concept -h --help all. guess bsd getopt-us program treat -h unrecogn option. example, mac:
```
$ ls --help
ls: illegal option -- -
usage: ls [-@ABCFGHLOPRSTUWabcdefghiklmnopqrstuwx1%] [file ...]
$ echo $?
1
$
```
guess go go troubl implement -h --help special case, would make sens match others.
anyon see argument _not_ chang exit statu match languag checked? thanks.
base discuss lack object rais sinc last comment, seem like **like accept**.
chang consensus, accepted.
chang mention issue: `flag: skip testexitcod plan 9`
@ret394 drop handl `-h` `-help` flag packag would differ proposal. welcom make one. best place discuss it.
said, note think option impos anyth anyone. program defin `-h` and/or `-help` itself.
bad see now, trip read go 1.15 releas notes.
seem chang command-lin api **all** go program use flag packag default set command-lin flag subtl way (given `-h` `-help` undefined). example, use program shell script **any** undefin flag (includ undefin `-h` `-help`) produc exit code 2. suddenli undefin flag produc exit code 0.
recreat old behavior one would switch custom flag-set `continueonerror` handl `flag.errhelp` before.
break go 1 compat expectations. secur issue, unspecifi behavior, specif error, bug. clearli specifi behavior standard librari chang subtl way for, opinion, good reason. one want new behavior alway possibl mean `flag` package.
one biggest advantag go chang time break thing use work before. introduc subtl chang even wors break things, hard detect.
like said, chang cli api lot go program wild. would even go far say flag bug revert go 1.15.1.
@frankbraun show exampl new behavior caus problem?
flag packag never realli defin behavior `-h` `-help` (and still doesn't). option alreadi act like undefin options. undefin option `-h` `-help` flag packag default print "flag provid defined", `-h` `-help` print that.
default behavior `exitonerror`:
```
var CommandLine = NewFlagSet(os.Args[0], ExitOnError)
```
and:
errhelp error return -help -h flag invok flag defined.
```
var ErrHelp = errors.New("flag: help requested")
```
chang behavior
```
       ExitOnError // Call os.Exit(2).
```
it's:
```
       ExitOnError // Call os.Exit(2) or for -h/-help Exit(0).
```
never mind what' print stderr (and specified). talk exit code part api cli program.
let' say cli program (call `example-tool`) two option `-foo` `-bar`:
```
package main
import (
	"flag"
	"fmt"
)
func main() {
	foo := flag.Bool("foo", false, "Foo option")
	bar := flag.Bool("bar", false, "Bar option")
	flag.Parse()
	// do something with foo and bar options
	if *foo {
		fmt.Println("foo")
	} else if *bar {
		fmt.Println("bar")
	} else {
		fmt.Println("default")
	}
}
```
shell script `example.sh` call it:
```
#!/bin/sh
if [ $# -ne 1 ]
then
  echo "Usage: $0 switch" >&2
  exit 1
fi
example-tool -$1 2> /dev/null
if [ $? -ne 0 ]
then
  echo "undefined flag"
  exit 1
else
  echo "success"
fi
```
go 1.14 call `example.sh h` lead to:
```
$ ./example.sh h          
undefined flag
```
go 1.15 call `example.sh h` lead to:
```
$ ./example.sh
success
```
suddenli `example-tool` give error code anymor option never defined. mayb script depend that. want process valid flags.
chang break go 1.0 compat expect (bi chang specifi behaviour), also silent chang cli api (in term error codes, never mind undefin stderr output) *a lot* go programs.
@ianlancetaylor clarifi it?
sorry, clear.
show exampl exist program script new behavior caus problem?
no, seen anyth wild yet, go 1.15 released.
get point though break exist cli api violat go 1.0 compat expectations?
imho @rsc put "consensu discussion", api chang that' cool given compat promise. know bit nit-picki here, realli tick off. decommiss third parti go option parser exactli reason keep chang keep break subtl way (apart fact amount depend parser pull crazy). would realli like unnecessari stdlib chang suddenli chang behavior programs.
get point chang cli behavior.
obviou violat said above, behavior `-h` `-help` never realli specified, still realli specified. disregard fact standard error output differ `-h` `-help`, see why. exit statu relev standard error output? program behaviors.
agre grey area. point can't chang anyth exist libraries. break exist programs. area like seem grey, think relev ask exampl program break.
sorri tick off.
> obviou violat said above, behavior `-h` `-help` never realli specified, still realli specified. disregard fact standard error output differ `-h` `-help`, see why. exit statu relev standard error output? program behaviors.
chang exit code affect makefil docker builds, coupl trivial examples, wherea output standard error won't.
> obviou violat said above, behavior `-h` `-help` never realli specified, still realli specified. disregard fact standard error output differ `-h` `-help`, see why. exit statu relev standard error output? program behaviors.
wrote second messag clearli specifi document `flag` use undefin `-h` return `errhelp` `exitonerror` lead `os.exit(2)`.
gray area there, clearli specifi did.
stderr output differ `-h` `-help` compar option specifi affect error codes. much less like anyon depend that. still chang it, rather document it.
> agre grey area. point can't chang anyth exist libraries. break exist programs. area like seem grey, think relev ask exampl program break.
know break exist programs, might deepli buri shell script calls.
recompil binari suddenli behav differently.
opinion set danger precedent. also correct behavior first place: call binari non exist flag get error code.
> would suggest upgrad go 1.15 unless required.
whole point upgrad thing gener get better. behavior changes.
> revert chang would real wast time. trade-off worth long run. oss tool could agre good conventions, that' realli great. eventu tool standard things.
>
> nice improv gener direction. far tell, behavior overridden need go apps, it?
total wast time comb releas note check subtl librari behavior chang chang exist code stick old behavior. **massive** advantag go thing keep work gener get better faster. *modern* program languag take code written 8 year ago compil run success latest compiler.
two small points.
1. make chang bug fixes, lead behavior changes. bug explicitli call fixable. bug differ implement languages.
2. caus signific problem real case (i'v seen hypothet above), examin case decid whether new behavior wors old. see case like that, pleas file new bug report it.
thanks!
thank reply. rest case hard evidence. hope open bug report ;)
sinc seek hard evidence, note caus test failur cli tool maintain. test question expect exit statu 2 pass `-h` flag. consid chang behavior problem, though. took much time read thread updat test expectation.
