proposal: runtime: gc pacer redesign
# gc pacer redesign
author: michael knyszek (with lot input austin clements, david chase, jeremi faller)
## abstract
go' trace garbag collector run concurr application, thu requir algorithm determin start new cycle. runtime, algorithm refer pacer. now, garbag collector frame process optim problem, util proport control achiev desir stopping-point (that is, cycl complet heap reach certain size) well desir cpu utilization. approach serv go well long time, design accru mani corner case due resolv issues, well backlog unresolv issues.
propos redesign garbag collector' pacer ground captur thing well elimin problem discovered.
specifically, propose:
1. includ non-heap sourc gc work (stacks, globals) pace decisions.
1. refram pace problem search problem, "solved" proportional-integr controller,
1. extend hard heap goal worst-cas heap goal next gc,
(1) resolv long-stand issu small heap sizes, allow go garbag collector scale *down* act predict general.
(2) elimin offset error present current design, allow turn mark-assist almost entir outsid except cases, improv alloc latency, enabl clearer design set memori limit go applications.
(3) enabl smooth consist respons larg chang live heap size larg gogc values.
## full design
found here.
chang mention issue: `design: add gc pacer redesign`
way: design feel solid me, gone round feedback yet. interest transparency, hope get feedback work github go forward.
so, given that, would surpris error document. pleas take look chance!
cc @randall77 @jeremyfal @dr2chase @aclement
@mknyszek
understand correctli forcegcperiod requir current pacer consid non-heap sourc gc work? necessari call gc period applic effect zero heap alloc rate collect stacks, etc.? understood propos correctly, seem like possibl remov period call gc, applic creat new goroutin alloc anyth heap never trigger garbag collections, good benefit itself.
@storozhukbm `forcegcperiod` pretti much complet separ proposal. account non-heap sourc work directli affect minimum heap size whether gc reach goals. relat though partli motiv ill effect `forcegcperiod` trigger.
believ `forcegcperiod` exist day help final run long-run mostly-idl programs. example, extern resourc tie finalizer, want clean _eventually_ (and sooner, probably). go api need ever run. but, could turn forc gc there' activ final something, convinc that' reason. shrink stack period also might reason, seem less critical.
anyway, look quot me. memori hazy. :) dig reason next week (i see document anywhere).
chang mention issue: `design: add user-configur memori target`
chang mention issue: `design: regener graph gc pacer redesign`
chang mention issue: `design: add initi condit section gc pacer redesign`
chang mention issue: `runtime: make gceffectivegrowthratio method gccontrollerstate`
chang mention issue: `runtime: move next_gc last_next_gc gccontrollerstate`
chang mention issue: `runtime: make gcsettriggerratio method gccontrollerstate`
chang mention issue: `runtime: move gcpercent heapminimum gccontrollerstate`
chang mention issue: `runtime: break gc pacer file`
chang mention issue: `runtime: renam gcpercent, readgogc, heapminimum match go style`
chang mention issue: `runtime: creat setgcperc method gccontrollerstate`
chang mention issue: `runtime: pass work.userforc gccontroller.endcycl explicitly`
chang mention issue: `runtime: creat initi gccontrollerstate`
chang mention issue: `runtime: move intern gc statist memstat gccontroller`
chang mention issue: `runtime: formal fix gcpercent synchronization`
chang mention issue: `runtime: move pacer time updat state reset methods`
chang mention issue: `runtime: detangl sweeper pace gc pacing`
chang mention issue: `runtime: move heapliv heapscan updat method`
chang mention issue: `runtime: track scannabl global space`
chang mention issue: `runtime: track amount alloc stack gc pacer`
chang mention issue: `runtime: implement gc pacer redesign`
unfortun everyth alreadi go release, need push back.
chang mention issue: `design: updat gc-pacer-redesign remov inaccuracies`
chang mention issue: `runtime: pass nanotim gomaxproc endcycl explicitly`
chang mention issue: `runtime: add test framework basic test gc pacer`
chang mention issue: `runtime: switch back 4 mib min heap goexperiment=pacerredesign`
chang mention issue: `runtime: updat descript godebug=gctrace=1`
