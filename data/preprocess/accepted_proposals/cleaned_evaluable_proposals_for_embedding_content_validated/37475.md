cmd/go: stamp git/vc current head hash/commit hash/dirti bit binari
(relat differ #35667)
cmd/go current emb modul dep inform binari readabl e.g. includ inform top-level module' version.
propos cmd/go look {git,svn,etc} state includ binary:
* head commit time
* head hash
* dirti bit (if uncommit changes)
current mani project hand `build-program.sh` stamp manual `--ldflags=-x foo=bar`, mean program built normal go way lack information, peopl end non-port (shell, often) build scripts.
hit enough time project activ frustrat me. wors program client want report version number server (which might want analytics, build horizon enforcement, protocol version negotiation, etc) can't. altern way that, tedious.
mostli concern peopl bespoke, often non-port build scripts.
**note**, juli 15, 2021: propos accept yet implemented. per discuss #37693, get implemented, need includ flag turn behavior off. - rsc
may duplic #29814.
figur exactli want record.
modul version pseudo-versions.
one too?
find quickli enough reason run everi 'go build'?
(we skip 'go test' like skip dwarf.)
go command alreadi code turn commit hash version; probabl use code add +modifi work directori modified.
would help time much overhead would 'go build'.
@bcmills, number much time would add?
btw agre duplic #29814 keep use one mark propos alreadi appear minutes.
> would help time much overhead would 'go build'.
`git statu --porcelain=v2` `go` repositori around 50m me, `git log -n 1` around 25ms.
`go instal cmd/go` 1.6 dirty, 140m clean. assum run vc command parallel build non-`main` packages, latenc hit negligible.
cc @jayconrod @matloob
hmm, realiz account check tag calculations. still, expect cost order-of-magnitud similar `git` command.
like point (mayb small) problem approach: chang version sourc code, code caus binari change.
let explain use-cas broken change:
- number binari built monorepo, binari packag docker, helm chart gener everi binary. chart includ docker imag id, tag.
- helm chart instal kubernet
helm chart content _and_ binari change, upgrad perform kubernetes.
version checkout stamp everi go binary, scheme crumbl and:
- either version need purg everi binari packag docker image,
- crazi scheme invented: remov version binary, take checksum, check docker imag version label publish registry, publish imag label it, use label helm charts.
@dottedmag, made condit import new package, say `runtime/version`, contain accessor func get info? use it, chang behavior.
would work use case?
practic ident case @dottedmag.
inevitably, somewher monorepo (perhap unintentionally) bring depend depend magic packag break determinist builds.
think common cases, propos enabl default would preferable. use case, would satisfi document way opt it. alreadi use `-ldflags=-buildid=` forc consist build id part determinist binaries, anoth esoter flag opt record vc state would complet acceptable.
> @dottedmag, made condit import new package, say `runtime/version`, contain accessor func get info? use it, chang behavior.
agre @mark-rushakoff: reli import brittl unless import consid `main` packages.
author recurs includ library, builder final binari posit decid whether put version inform binari not.
@dottedmag, note mani functionally-equival build _already_ produc slightli differ binari due version-stamp `runtime/debug.readbuildinfo`. version stamp chang chang correspond _module_ versions, even content specif import _packages_ same.
propos would case sort version churn, fundament churn.
suggest may want provid option disabl version stamp _in general_. imo, separ proposal.
true. practice, problem chang version depend nearli alway chang code depend — nobodi updat version depend endlessli reason, usually, get updat get new featur bugfix.
file #37693.
discuss reproduc build sound like would satisfi version embed default also opt-out command-lin flag; special packag needed.
right, @dottedmag @mark-rushakoff?
yes, think flag opt embed version detail would suffic reproduc builds.
would nice singl flag like `-reproducible` omit version detail set fix build id, probabl fine remain separ concerns.
care reproduc build command line build someth use; care reproduc build write build script run part ci/cd pipeline, big deal need look whole collect set make build reproducible.
@rsc correct.
ok, sound like everyon agre default, flag turn off.
unclear exactli fast ask git/etc need know, oper overlap entir build, includ link. right build helloworld get:
```
/Users/rsc/go/pkg/tool/darwin_amd64/link -o $WORK/b001/exe/a.out -importcfg $WORK/b001/importcfg.link -buildmode=exe -buildid=SqhXBrEZODPkt1gG-6fj/H70nrokRrHQB9NgKyehx/mN9hM1-9avNnPeQfRwgY/SqhXBrEZODPkt1gG-6fj -extld=clang $WORK/b001/_pkg_.a
/Users/rsc/go/pkg/tool/darwin_amd64/buildid -w $WORK/b001/exe/a.out # internal
```
buildid step could instal git version info too. confid git faster link.
base discussion, then, seem like **like accept**, although may abl implement next releas (go 1.16).
includ commit hash also (any?) version tag
version tag introduc mani sharp edges, least git… sinc git repo clone without fetch tags, differ local tags, add tag sha point time, use nearest tag (e.g. `git describe` equivalent) would mean build sha could result differ embed version differ peopl (or person differ times). further, closest tag commit multipl tag associ it, version could ambigu (`git describe` particularli unpredict behavior case).
@liggitt, note problem occur one direction. (it fine gener n name one commit. import properti resolv one commit given name.)
`go` command alreadi algorithm infer canon name given repo state, implement part #27171. (specifically, infer either highest tag semant version appropri modul path, pseudo-vers deriv highest-tag ancestor.)
realiz algorithm make thing awkward `k8s.io` repo particular unusu tag histori (in `v1.5.1` ancestor `v0.18.0`), observ sort nonlinear histori outlier.
> import properti resolv one commit given name.
sinc tag local, prefer tag sha would mean two user could ident local tag associ differ shas. suggest map sha tag would determin consult local vcs, remot canon vcs?
seem like reason motiv includ commit hash _and_ semant version, rather one other.
chang consensus, accepted. may still need work exactli include, everyon seem agre worth (bar discoveri expens think).
tent mark 1.16. tri get in, lot planned, can't promis get done. someon interest work this, sketch need done. complic though, probabl good first issue.
* vc code fetch modul `cmd/go/internal/modfetch/codehost`. fairli specif modul intend work local repositories. sure whether would better gener packag add support new package. start former see complic gets.
* case, someth rest `cmd/go` call return vc information.
* support `git`, `hg`, `svn`, `bzr`, `fossil`.
* inform save `cmd/go/internal/load.packageinternal.buildinfo`. use field store modul inform that' stamp `main` packages. sinc would longer module-specific, would need generalized.
* someth `cmd/go/internal/load` popul field `main` packages, combin inform `modload.packagebuildinfo`. current done `package.load`. note differ `main` packag build may belong differ repositories.
* `buildinfo` alreadi part packag cach key, changed, would alreadi caus cach `main` packag becom stale. make sure test though.
* code stamp `cmd/go/internal/work.builder.build` module-specif would need adjustment.
* `runtime/debug.buildinfo` need new fields, `runtime/debug.readbuildinfo` need popul them.
* `cmd/go/internal/version` also need abl read report new information. clear print default behind flag (similar modul inform behind `-m`). probabl latter.
* #39301, move code extract build inform `x/mod`. would need support well.
ad top comment:
> **note**, juli 15, 2021: propos accept yet implemented. per discuss #37693, get implemented, need includ flag turn behavior off. - rsc
chang mention issue: `cmd/go: stamp vc revis uncommit statu binaries`
chang mention issue: `encoding/binary: convert intern test external`
chang mention issue: `cmd/go: move modul build info format runtime/debug`
chang mention issue: `runtime/debug: add readbuildinfofrom readbuildinfofromfile`
chang mention issue: `cmd/go: migrat 'go version' use debug.readbuildinfofromfile`
chang mention issue: `runtime/debug: add govers buildinfo`
chang mention issue: `cmd/go: stamp tag flag build info`
