runtime: api unstabl metric
# proposal: api unstabl runtim metric
## background & motiv
today runtim metric expos two ways.
first way via struct-bas sampl api `runtime.readmemstats` `runtime/debug.gcstats`. function accept pointer struct popul struct data runtime.
problem type api are:
* removing/renam old metric struct impossible.
* example, `memstats.bysize` hard-cod 61 size class current 83. cannot ever chang `bysize`.
* ad implementation-specif metric struct discouraged, pollut api inevit deprecated.
* `runtime.readmemstats` global effect applic forc stw. direct effect latency. abl teas apart metric actual need give user control performance.
good thing type api are:
* protect go 1 compat promise.
* easi applic ingest, use purposes, push metric collect servic log.
second via `godebug` flag emit string contain metric standard error (e.g. `gctrace`, `gcpacertrace`, `scavtrace`).
problem type api are:
* difficult applic ingest must parsed.
* format output protect go 1 backward compat promise.
good thing type api are:
* freeli chang add implementation-specif metrics.
* never live bad decisions.
would like propos new api take best approaches.
## requir
* api easili extend new metrics.
* api easili retractable, deprec old metrics.
* remov metric break go applic per go 1 compat promise.
* api discoverable, obtain list current relev metrics.
* api rich, allow varieti metric (e.g. distributions).
* api implement minim cpu/memori usage, appreci
affect metric measured.
* api includ use exist metric alreadi expos runtime.
## goal
given requirements, suggest priorit follow concern design api follow order.
1. extensibility.
* metric “unstable” therefor alway compat add remov metrics.
* sinc metric tend implementation-specific, featur critical.
1. discoverability.
* metric “unstable,” must way application, human write application, discov set usabl metric abl someth use inform (e.g. log metric).
* api enabl collect subset metric programmatically. example, one might want “collect memory-rel metrics” “collect metric effici collect”.
1. performance.
* must minim effect metric return steady-state.
* scale 100 metrics, amount human might consid “a lot.”
* note pick right type expos limit amount metric need expose. example, distribut type would significantli reduc number metrics.
1. ergonomics.
* api easi use be, given above.
## design
see full design document
highlights:
* expos new sampling-bas api new package, `runtime/metrics` package.
* use string key metric includ unit metric easily-pars format.
* expos discoveri api provid metadata metric runtime, whether requir stw whether cumul (counter oppos gauge).
* add histogram interfac packag repres distribution.
* support event-bas metric discuss left open, consid outsid scope proposal.
## backward compat
note although set metric runtim expos stabl across go versions, api discov access metric be.
therefore, propos strictli increas api surfac go standard librari without chang exist function therefor go 1 compatible.
chang mention issue: `design/37112-unstable-runtime-metrics.md: add proposal`
@mknyszek, what' statu this? doc readi review discuss (if pleas check in)?
doc readi review discussion, +2 review land yet. tri ping peopl look cl.
coupl high-level comments:
1. `histogram` interfac seem abstract. user need know space possibl concret type anyway, abl use given `histogram` without know concret element type. instead, would inclin provid concret `float64histogram` `timehistogram` type — need worri whether add method interfac future.
2. `metric` type includ type inform metric values? would allow user skip read metric abl interpret anyway.
actually, perhap `metric` includ alloc function..? would make alloc strategi bit less implicit, might reduc risk alias bug user code.
> coupl high-level comments:
>
> 1. `histogram` interfac seem abstract. user need know space possibl concret type anyway, abl use given `histogram` without know concret element type. instead, would inclin provid concret `float64histogram` `timehistogram` type — need worri whether add method interfac future.
given probabl need copi data runtim anyway, think right make sens concret types.
> 2. `metric` type includ type inform metric values? would allow user skip read metric abl interpret anyway.
>
> actually, perhap `metric` includ alloc function..? would make alloc strategi bit less implicit, might reduc risk alias bug user code.
consid includ type inform metric order let user filter metric understand, certainli opposed. alloc function also neat idea. one less potenti footgun, work user set up.
may also worthwhil `read` report explicit error request metric exist.
(i could imagin someon might tri call `read` hard-cod list metrics, user code may produc obscur panic tri read unpopul value.)
know minor detail still work out, like whether read return error cases. those, seem like peopl gener favor proposal.
read wrong? anyon object accept proposal?
ok, base discuss seem like **like accept**.
chang consensus, accepted.
chang mention issue: `runtime,runtime/metrics: add memori metrics`
chang mention issue: `runtime/metrics: add packag interface`
chang mention issue: `runtime,runtime/metrics: add object size distribut metrics`
chang mention issue: `runtime,runtime/metrics: export goroutin count metric`
chang mention issue: `runtime,runtime/metrics: add metric distribut gc pauses`
chang mention issue: `runtime: add timehistogram type`
chang mention issue: `runtime,runtime/metrics: add heap object count metric`
chang mention issue: `runtime,runtime/metrics: add heap goal gc cycl metrics`
> may also worthwhil `read` report explicit error request metric exist.
>
> (i could imagin someon might tri call `read` hard-cod list metrics, user code may produc obscur panic tri read unpopul value.)
oops, total forgot this. luckily, case worri came interven months, way address make result `value` `kind` `kindbad` metric exist. explicit `error` valu return `read`, signal issu (and seem right set anyway, even decid return explicit `error` value, too). wdyt? @bcmill
`kindbad` seem reason me.
would possibl updat propos document describ relationship `expvar` `runtime/metrics`?
`expvar` alreadi expos `runtime.memstats` predefin format. _some_ project use `expvar` vendor-neutr layer expos metrics. third-parti tooling, pull data `expvar` differ metric collectors.
feel confus std two way expos intern stats.
@narqo yeah, happi updat propos documentation. make sure happen release.
short answer relationship two `runtime/metrics` low-level, intend replac `readmemstats`. `readmemstats` problem us term expos statist use us debug evolv runtime. futur evolut `runtime/metrics` could also involv "push" metric ("time seri data") instead "pull" metric ("sampl data") quit fit `expvar`' model, think separate, underli packag still make sense.
anoth point despit use string keys, `runtime/metrics` actual much lower-level api put lot focu effici price usability. afaict, realli case `expvar` (despit perform improv see made year ago).
file anoth issu tri figur `runtime/metrics` export `expvar` (#43555) honestli 100% sure. think person slightli lean toward re-export `runtime/metrics` `expvar` one big blob, concern that.
thank input here, pleas feel free start/continu discuss #43555.
