net/http/httputil: replac director rewrit
propos seek address #50580. quick summari motiv reverseproxi request-rewrit hook need make clear distinct request receiv proxi forward request sent proxy. exist director hook make distinction, result unsaf behavior. see #50580 details.
propos ad `rewrite` hook `httputil.reverseproxy`, supersed exist `director` hook. `rewrite` take `*httputil.rewriter` parameter. `rewriter` provid inbound outbound requests, well conveni method modifi outbound request.
`reverseproxy` `rewrite` function default make minim modif outbound request. particular, add `x-forwarded-*` header default. method `rewriter` provid easi way add header desired: `rewriter.setxforwarded` add header (replac sent client) `rewriter.appendxforwarded` (append one sent client, current default behavior). impos small addit requir user `reverseproxy`, make proxi behavior explicit easier chang future.
propos api additions:
```
type ReverseProxy struct {
        // Rewrite is be a function which modifies  
        // the request into a new request to be sent
        // using Transport. Its response is then copied
        // back to the original client unmodified.
        // Rewrite must not access the provided Rewriter
        // or its contents after returning.
        //
        // The X-Forwarded-For header is not automatically set when
        // Rewrite is used. Use the Rewriter.SetXForwarded method
        // to set it.
        //
        // At most one of Rewrite or Director may be set.
        Rewrite func(*Rewriter)
}
// A Rewriter contains a request to be rewritten by a ReverseProxy.
type Rewriter struct {                                  
        // InReq is the request received by the proxy.
        // The Rewrite function must not modify InReq.
        InReq *http.Request                                        
        // OutReq is the request which will be sent by the proxy.
        // The Rewrite function may modify this request.       
        // Hop-by-hop headers are removed from this request   
        // before Rewrite is called.   
        OutReq *http.Request                                     
}            
// SetURL routes the outbound request to the scheme, host, and base path
// provided in target. If the target's path is "/base" and the incoming
// request was for "/dir", the target request will be for "/base/dir".
// SetURL does not rewrite the Host header.                           
func (r *Rewriter) SetURL(target *url.URL) {}
// SetXForwarded sets the X-Forwarded-For, X-Forwarded-Host, and     
// X-Forwarded-Proto headers of the outbound request.        
//
//   - The X-Forwarded-For header is set to the client IP address.
//   - The X-Forwarded-Host header is set to the host name requested
//     by the client.
//   - The X-Forwarded-Proto header is set to "http" or "https", depending
//     on whether the inbound request was made on a TLS-enabled connection.
func (r *Rewriter) SetXForwarded() {}
// SetXForwarded sets the X-Forwarded-For, X-Forwarded-Host, and
// X-Forwarded-Proto headers of the outbound request. It behaves
// like SetXForwarded, but appends the client IP address to the
// X-Forwarded-For header in the inbound request (if present).
func (r *Rewriter) AppendXForwarded() {}
```
exampl usage:
```
// This is the equivalent of httputil.NewSingleHostReverseProxy(someURL).
proxy := httputil.ReverseProxy{
        Rewrite: func(r *httputil.Rewriter) {
                r.SetXForwarded()
                r.SetURL(someURL)
        }
}
```
draft implement
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
bike shedding, `httputil.rewriter` look like interface.
see discuss #50580, ask here: benefit `func(*struct{})` (void?) methods, `httputil.reverseproxy.rewrite` struct field configured? seem complex, think bit doubl edg sword, seen pattern elsewher stdlib. altern would look like example:
```go
// This is the equivalent of httputil.NewSingleHostReverseProxy(someURL).
proxy := httputil.ReverseProxy{
        Rewrite: httputil.Rewrite{
                SetXForwarded: true,
                SetURL: someURL
        }
}
```
`rewriter` definit interface. there' one implement it, want abl add method future.
propos `rewrite` hook, like `director` hook would supersede, user-provid function perform amount modif proxi request forwarded. can't replac fix list operations.
> `rewriter` definit interface. there' one implement it, want abl add method future.
clear: `pkg.doer`, me, look like interfac end -er. may want consid differ name.
> propos `rewrite` hook, like `director` hook would supersede, user-provid function perform amount modif proxi request forwarded. can't replac fix list operations.
yep, sorri exampl pigenhol thinking; make sense.
said, would make `rewrite: func(*http.request) *http.request`? method seturl forward header util function could use outsid usecase.
could also two input void desirable: `func(in, *http.request)`. could also worth make `http.request`, pointer, suggest/enforc immut requirement.
`func(*http.request) *http.request` address #50580. input request contain hop-by-hop headers, can't tell header output ad rewriter; input contain hop-by-hop headers, rewrit way look one may interest in. need pass inbound outbound request user hook.
wrap request `rewriter` type give us good place hang addit function `seturl`. one propos could also stand-alon functions, make method type pass `rewrite` good discoverability, especi given overly-broad api surfac `httputil`. also give us option ad method futur custom proxi behavior ways.
> `func(*http.request) *http.request` address #50580. input request contain hop-by-hop headers, can't tell header output ad rewriter; input contain hop-by-hop headers, rewrit way look one may interest in. need pass inbound outbound request user hook.
make sense, alreadi preprocess done creat popul `rewriter.outreq`, thu would need two paramet form:
```go
// This is the equivalent of httputil.NewSingleHostReverseProxy(someURL).
proxy := httputil.ReverseProxy{
        Rewrite: func(in, out *http.Request) { ...}
}
```
> wrap request `rewriter` type give us good place hang addit function `seturl`. one propos could also stand-alon functions, make method type pass `rewrite` good discoverability, especi given overly-broad api surfac `httputil`. also give us option ad method futur custom proxi behavior ways.
yeah, see clear need add new struct field method includ magic [rect intern apis], see useful; feel like novel design pattern akin grpc input structs, feel decidedli non go-like. prefer obviou natur explicit format.
resolv object rewriter?
tent tri land earli go 1.20?
open issu would abl close add rewriter?
perhap there' better name `rewriter`, absenc concret idea someth think fine. (`rewritestate`? `rewritecontext`?)
land earli 1.20 would nice.
look issu mention `reverseproxy`:
primari motiv propos (and suffici justifi it, believe, sinc secur concern):
* #50580
issu relat forward header (`x-forwarded-for`, etc.). make addit `x-forwarded` header explicit make easier adjust behavior backwards-compat fashion.
* #50465
* #31095
* #30963
issu relat `newsinglehostreverseproxy` preserv inbound request' `host` header. could make `rewriter.seturl` method clear inbound `host`. even preserv current behavior preserv host, `rewrite` make much simpler user custom proxi behavior, sinc requir wrap `director` function creat `newsinglehostreverseproxy`.
* #28168
* #33861
possibl better name `rewriter`: `proxyrequest`.
chang mention issue: `net/http/httputil: add reverseproxy.rewrite`
cl 407214 contain implement proposal, chang origin post:
* renam `rewriter` `proxyrequest`.
* use `rewrite` func,
* default behavior send `x-forwarded-*` header (strip one inbound request).
* `proxyrequest.setxforwarded` set `x-forwarded-*`.
* append client' `x-forwarded-for` header, copi inbound header outbound request call `proxyrequest.setxforwarded`.
* `proxyrequest.seturl` set outbound request' `host` header.
`x-forwarded-*` chang prefer secur behavior (not trust client' headers).
`seturl` chang address #28168, leav simpl get current behavior `newsinglehostreverseproxy` back desired.
clear `x-forwarded-*`, `forwarded` also preemptiv cleared?
yes, actual alreadi clear `forwarded` cl neglect mention specifically.
fwiw said "object rewriter" meant propos generally, name. use whatev name think clearest; rewrit fine so.
anyon object tri go 1.20?
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
chang consensus, **accepted**. ðŸŽ‰
