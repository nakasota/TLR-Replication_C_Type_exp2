cmd/compile: replac `//go:notinheap` runtime/internal/sys.notinheap
`//go:notinheap` current type pragma, impos lot complex special case compil tools. e.g., captur within go/typ types2 type models, user want analyz code use lot effort reconstruct information. reflect api updat reject chanof mapof notinheap types. even exist compil typecheck extend nativ support `//go:notinheap` fail handl tricki situations:
`//go:notinheap` effect languag change, bypass review usual languag spec review start runtime-onli hack. extend use cmd/cgo access user packag (a necess cmd/cgo' design), skip languag review.
alreadi effect type pragma form "nocompare" (where embed non-comparable, zero-s type make enclos struct non-compar too) "nocopy" (where cmd/vet detect valu copi type directli contain element type "nocopy"). however, work much robustli interoper exist tool better reli struct field embedding, rather introduc actual type pragmas. think `//go:notinheap` modifi work similarly.
propos following:
1. add new `notinheap` type runtime/internal/sys. initi definit would be:
   ```
   type NotInHeap struct { _ nih }
   //go:notinheap
   type nih struct{}
   ```
2. disallow use `//go:notinheap`, mayb eventu get rid altogeth turn `sys.notinheap` compil intrins type like `unsafe.pointer`.
3. chang exist runtim type use `//go:notinheap` add `sys.notinheap`-typ field instead. hand defin type mark `//go:notinheap` alreadi struct type (i.e., debuglogbuf, checkmarksmap, gcbits) would need adjust use struct wrapper.
3. add new `runtime/cgo.incomplete` type definition: `type incomplet struct { _ sys.notinheap }`. chang cmd/cgo emit `type _ctype_struct_foo cgo.incomplete` instead use `struct{}` `//go:notinheap` directive.
4. disallow reintroduct type pragmas, even runtim use, without propos review. (i object runtime-intern *intrinsic* type though.)
incidentally, also approach took implement proof concept #19057 (ad intrins type allow adjust field alignment) use within runtime. think work cleanly, avoid requir introduct new type pragmas. instead, ad `runtime/internal/align.elemt` intrins type known compil special align semantics.
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
undocumented, probabl ok remove.
replac internal-onli thing one abl see it.
think need export cgo.incomplet - whatev need let cgo see thing other can't.
(mayb internal/cgo?)
one question see discussed: might use support notinheap data structur runtime. manag mmape data data sysv share memori come mind. user current way deepli pointer heavi code detect got right. solv beauti via notinheap runtim purpos might time support bit wider scope.
> think need export cgo.incomplet - whatev need let cgo see thing other can't.
> (mayb internal/cgo?)
ok me. fit cleanli cmd/go' model intern packag user packag can't directli import, cgo-rewritten code access?
> one question see discussed: might use support notinheap data structur runtime.
think orthogon concern. concern type direct difficult implement correctly, evidenc mani corner case still mishandl cmd/compile.
secondari concern accident expos featur end users. decid intent export notinheap type user though, think that' fine. probabl separ proposal.
> fit cleanli cmd/go' model intern packag user packag can't directli import, cgo-rewritten code access?
think does. think would end weird state packag `import "c"` mysteri also `import "internal/cgo"` without diagnos error. seem appreci better export `runtime/cgo.incomplete` marker type.
think would straightforward cmd/go pass special option compil compil go file gener cgo. could use special builtin `notinheap` (or `unsafe.notiheap`) avail flag passed. alreadi compil runtim special compil flags, could make avail well. downsid peopl pass compil flag well.
alternatively, put type runtime/cgo consid @nightlyon 's suggest pick name ad document permit anybodi use new type desire. think fairli special use case ordinari argu favor support use case, need anyhow cgo perhap littl harm let peopl use well.
cgo support all, seem trivial way everyon els use cgo enabl too:
```go
package clever
/*
typedef struct Incomplete incomplete;
*/
import "C"
type NotInHeap {
	_ C.incomplete
}
```
sure worth go lot effort prevent extern user make not-in-go-heap types.
good point.
there' still distinct *semantics* exporting. semant `go:notinheap` chang times, sinc intern problem shape need changed. likewise, @bcmill right there' noth stop user use incomplet type c achiev effect, semant use incomplet c type. happen overlap current implementation, intent different.
convinc particular argument export type.
fwiw, reason suggest `runtime/cgo.incomplete` initi name specif semant incomplet c types. immediately, would term notinheap, implement today; think longer term probabl distinguish incomplet c type allow context depend size (e.g., `unsafe.sizeof`, struct field types, array element types).
discuss runtime/compil meet today (sorri @mdempski !) everyone' fine gener idea replac type pragma embed type. like see current non-struct notinheap type wind look like, that' minor concern (@mknyszek think probabl better struct type anyway).
realiz pretti unclear exactli mmap-us user code would want someth like notinheap. use runtim type must write barriers, (perform aside) there' restrict user code.
(fwiw, histori go:notinheap: part runtime, like scheduler, need manipul pointer-bas data structur cannot write barrier write barrier depend resourc exist core part runtime. use unsaf cast shenanigan care avoid write barrier code, felt get annoy unmaintainable, ad go:notinheap expedi solut small number core type runtime. kind messi incomplete, still improv statu quo, sinc intern use 100% complete. sort grew, especi keith realiz almost exact semant need solv problem cgo. bunch awkward contort happi someon rethink it. :) )
record "discuss ongoing", also sound like prototyp need make decision. take also move proposal-hold prototyp ready.
least minor concern, need see whole prototype, want confirm problem convert non-struct type struct type (which would probabl take minutes).
think expos user-vis type time. mayb future, think that' outsid scope proposal.
`cgo.incomplete`, would nice could find way export that, least ian fine make export type `runtime/cgo`.
@mdempski want tri prototyp see whether work practice?
chang mention issue: `cmd/cgo: add use runtime/cgo.incomplet instead //go:notinheap`
chang mention issue: `runtime: add use runtime/internal/sys.notinheap instead //go:notinheap`
chang mention issue: `cmd/compile: restrict //go:notinheap runtime/internal/sys`
> @mdempski want tri prototyp see whether work practice?
done.
cgo cl, use runtime/cgo.incomplet initi propos above. necessari test convert `*c.struct_s` across packages, refer common standard librari type otherwis `_ notinheap` field make struct type differ (becaus `_` exported). use "runtime/cgo.incomplete" easiest way this, open use differ name suppress use end users. (but discuss above, sure there' benefit hide user either; get basic time use cgo normally.)
compil cl, quick hack lock visibility. fail coupl compil unit tests, sure fix somehow.
> refer common standard librari type otherwis `_ notinheap` field make struct type differ (becaus `_` exported)
see previous #21967.
follow interest might use outsid runtime, sourcegraph queri survey.
case stuck out:
- gccgoimport appear use it, least tests.
- kernel written go appear use fairli extens (
- `inet.af/wf` use type ( iirc part tailscal stack.
case seem misuses, person know enough say.
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
chang consensus, **accepted**. ðŸŽ‰
