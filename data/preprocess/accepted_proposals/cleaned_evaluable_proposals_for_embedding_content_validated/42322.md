io/fs: add func sub(fsi fs, dir string) fs
_origin post @zikaeroh
tri now; one wart `go:embed` direct emb `build/*`, filenam still prefix `build/`. want serv directori via `http.fs`, there' easi way _add_ prefix that' requir access need (without write wrapper, hit problem need list everi potenti method fs may have...).
e.g.:
```go
//go:embed build/*
var buildDir embed.FS
// Serve some SPA build dir as the app; oops, needs to be build/index.html
http.Handle("/", http.FileServer(http.FS(buildDir)))
// or
//go:embed static/*
var staticDir embed.FS
// Oops; needs to have a static prefix.
http.Handle("/static/*, http.StripPrefix("/static", http.FileServer(http.FS(staticDir))))
// Could be this, but only because the prefix happens to match:
http.Handle("/static/*, http.FileServer(http.FS(staticDir)))
```
know intent one could write `go:emb foo/* bar/* baz.ext` get files, think go common simpli emb directori serv static asset via http package. expect gotcha peopl switch thing like `http.dir("static")` `pkger.dir("/internal/web/static")` prefix alreadi handled, new `embed.fs`.
realli sure file this, sort interplay `embed`, `io/fs`, `net/http`.
- - - -
comment @zikaeroh' comment:
think best way resolv ad gener purpos fs.withprefix helper creat new fs restrict given subdirectori prefix. exampl would become:
```go
//go:embed build/*
var buildDir embed.FS
http.Handle("/", http.FileServer(http.FS(fs.WithPrefix("build", buildDir))))
```
think fs implement option interfac invented. think gener applic thing like creat zipfil fs restrict subdirectori whatnot.
main issu approach whole option method thing; moment use helper addit fs method lost. "correctly", end httpsnoop deal option interfac problem `responsewriter`, `errnotsupported` valu becom standard, make `io/fs` somehow implement everi possibl method (becaus emb result new `fs.withprefix` add without lose extra method entirely). brought design `io/fs` reddit issu thread.
`net/http`, matter, sinc `http.fs` use `open`, gener use `io/fs`, might matter more. mention followup comment could achiev thing `addprefix` counterpart `stripprefix` `net/http` ( might work better, solv overal problem "i can't subtre `fs`".
still certain "problem" static serv work `net/http` (the awkward set need prefix stripper modifi `request`), gener problem design `io/fs` lend subtre want retain efficiency. mayb later 100% true, though, sinc know given fs would realli want handl prefixes.
comment io/f proposal, understood it, consensu "right" way deal option interfac implement return `errnotsupported` underli fs method question.
forgiv me, meant `errunsupported` (#41198), `errnotsupported` (which differ thing...). note `errunsupported` accepted, implement use `io/fs`.
@zikaeroh gener recommend option method add fall-back appropri helper `io/fs` can't implement specifically. helper correct thing (i.e. `type-assert fallback-implement return errunsupported`). necessari use `errunsupported` (or equivalent) `io/fs` far reason used.
option interfac approach work, detail would use (probabl separ bug) would point seriou design issu discuss go 1.16 released. know instanc yet, mean exist. particular, see problem interact option interfac know hypothet `stripprefixfs`.
think propos good idea would much like see happen. me, fundament primit compos file system would like see `io/fs` - like `io` contain multireader, teeread fundament compos primit i/o-streams.
/cc @rsc
initi instinct would use could add safeti tri "sandbox" part filesystem. rememb `io/fs` draft design `..` forbidden already. theori seem like pretti easi implement propos (string concaten stuff need handl option methods, right?) subtl reason standard lib?
(apolog poorli format example; written directli browser.)
```golang
type WPFS struct {
   inner  FS
   prefix string
}
func (fs WPFS) Open(p string) (File, error) {
   return fs.inner.Open(inner.prefix + "/" + p)
}
// same thing but for ReadFile, Stat, ReadDir, Glob, and maybe Rename, OpenFile?
func WithPrefix(f FS, p string) WPFS {
   return WPFS{f, p}
}
```
> subtl reason standard lib?
no, *subtle* reason. non-subtl reason mention above: fundament primit composition, make avail akin top-level function `io` package, example.
altern name could chroot
talk ad propos discuss reddit, think could call fs.sub, sub-tree. chroot bit obscur (but accurate!), withprefix mayb much mechan (and mayb inaccurate! argument open _without_ prefix).
think could put next releas get experi io/fs, agre critic piec use embedding.
anyon object ad `func sub(fsi fs, dir string) fs` io/f also correspond subf interface?
subf interfac look like? `sub(string) (fs, error)`? work implement error (i forget name that)? sgtm long return error.
agre interfac return error, if, example, `dir` exist, make sens report sooner rather later. method return error, `fs.sub` itself.
however, think method would ever need return `errnotimplemented` (or somesuch) alway safe fall back `fs.sub`.
lot awkward call sub compar http.stripprefix return error.
easi check want error: call stat(".") result.
lean toward leav error off.
@carlmjohnson, "not implemented". implement want provid sub know how, call fs.sub.
base discussion, seem like **like accept**, go 1.16 part initi fs api.
> implement want provid sub know how, call fs.sub.
`fs.fs` implement `subfs` use `fs.sub`, lead infinit recursion?
@rsc think `io/fs` use `openat` similar syscalls. simplest implement would use singl `uintptr` dirfd. `sub` would `open` directori return result file-descriptor. istm `sub` can't return error, need addit bookkeep inform extra check make sure dirfd actual valid still actual someth error return `open`. total dealbreaker, imo return error `sub` cleaner example.
@icholi no, pass wrap file-system `fs.sub`, yourself.
think propos useful, think document secur features, even read symlink file allow escap filesystem root (in fact, point might want add `fs.jail` futur secur implications, that' anoth proposal).
fs.jail thing, mayb matter less fs.sub error checking. fs.jail could complain permiss use directori first place, etc. separ would also mean fs.sub clean path `..` everi use, might nice performance.
fs.sub less secur fs.jail, would want encourag use http.fs?
http.dir caveat. think that' fine.
chang consensus, accepted.
went implement this, seem like need error result diagnos invalid argument properly.
that' cl has.
chang mention issue: `io/fs: add sub`
sorri reviv thread, went exact issu like @carlmjohnson.
solut right now?
follow folder structure:
```
❯ tree
.
├── app.go
├── app_test.go
├── go-angular
├── go.mod
├── go.sum
├── gorm.db
├── main.go
└── static
   ├── 3rdpartylicenses.txt
   ├── favicon.ico
   ├── index.html
   ├── main-es5.c3a229a8df5c7afb3b74.js
   ├── main-es2015.c3a229a8df5c7afb3b74.js
   ├── polyfills-es5.ce594f46feb1b2635563.js
   ├── polyfills-es2015.b8551d1724c24320d5c4.js
   ├── runtime-es5.edb2fcf2778e7bf1d426.js
   ├── runtime-es2015.edb2fcf2778e7bf1d426.js
   └── styles.8519e2aadcad2336f5cb.css
```
go:emb line look like this:
```go
//go:embed static/*
var static embed.FS
```
tri solv issu new `fs.sub` module:
```go
webapp, err := fs.Sub(static, "static")
	if err != nil {
		fmt.Println(err)
	}
a.r.Handle("/", http.FileServer(http.FS(webapp)))
```
look debugg see file there:
!
open browser get 404. why?!
!
@shibumi think might want open thread golang-nuts, instead comment close issue, question like that. particular, would help get full, reproduc code. example, notic call `a.r.handle` - what' `a.r`?
use code
```go
package main
import (
	"embed"
	"io/fs"
	"log"
	"net/http"
)
//go:embed static/*
var static embed.FS
func main() {
	webapp, err := fs.Sub(static, "static")
	if err != nil {
		log.Fatal(err)
	}
	http.Handle("/", http.FileServer(http.FS(webapp)))
	http.ListenAndServe("localhost:1234", nil)
}
```
`static/foo.js` file, `curl fine, return content file.
assum code show tell entir stori - assum use sort router extra bits. screenshot develop tool also show entir path file requesting.
again, suggest open thread golang-nut :) issu right place get support.
@meroviu thank answer. mean 'go-nuts'? irc? tri already. full code here:

funni part is: js 404, index.html works. weird, might move discuss somewher else, agree. sorri disturb everybodi :)
edit: never mind. one person go-nut irc told talk go-nut mail list. fix issu now. look like someth gorilla mux angular specific. instead `http.handle("/", http.fileserver(http.fs(webapp))` start use gorilla mux' pathprefix function it, worked: `a.r.pathprefix("/").handler(http.fileserver(http.fs(webapp)))`
