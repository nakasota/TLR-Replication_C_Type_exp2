cmd/go: deprec major modul version
# proposal: mechan deprec modul
authors: @peterbourgon, @adg
propos replac part #38762. part replac #40323.
## problem
currently, standard way packag author signal consum major version packag deprec longer supported. packag consum easili inadvert select unmaintain major version (see #40323) miss import new featur bug fixes.
## propos
propos ad `deprecated:` comment modul recogn go tool flag modul version deprecated. parallel `deprecated:` comment use flag packag identifi deprecated.
select deprec modul version, go tool print note user alert deprecation, print deprec text provid modul author. author use notif direct packag consum recent major versions, entir new modul replac deprec one.
package-level deprec comments, modul deprec comment span multipl lines.
## exampl
author modul `github.com/peterbourgon/ff` releas new major version `v2` (current version `v2.0.1`), want deprec old major version tree `v1` (latest version `v1.7.4`).
`v1` branch, add modul declar `go.mod` file, modul declaration:
```
// Deprecated: The latest supported version is github.com/peterbourgon/ff/v2.
module github.com/peterbourgon/ff
```
commit chang tag new patch releas `v1.7.5`.
sever way deprec messag display packag consumers.
consum fetch modul major version `v1` first time, command succe deprec warn print part go get' output:
```
$ go get gthub.com/peterbourgon/ff
go: deprecated: github.com/peterbourgon/ff v1.7.5 ðŸ‘ˆ
go: deprecated: The latest supported version is github.com/peterbourgon/ff/v2. ðŸ‘ˆ
```
consum current use modul version e.g. `v1.7.4`, warn print modul version fetched. however, consum tri upgrad dependency, see deprec warning. notably, upgrad still succeed.
```
$ go get -u github.com/peterbourgon/ff
go: github.com/peterbourgon/ff upgrade => v1.7.5
go: deprecated: github.com/peterbourgon/ff v1.7.5 ðŸ‘ˆ
go: deprecated: The latest supported version is github.com/peterbourgon/ff/v2. ðŸ‘ˆ
```
consum current use modul major version 1 (e.g. `v1.7.4`), run command list latest version avail major version tree (i.e. `v1.7.5`), warn printed.
```
$ go list -m -u all
example.com/my-module
github.com/BurntSushi/toml v0.3.1
github.com/mitchellh/go-wordwrap v1.0.0
github.com/peterbourgon/ff v1.7.4 [v1.7.5]
go: deprecated: github.com/peterbourgon/ff v1.7.5 ðŸ‘ˆ
go: deprecated: The latest supported version is github.com/peterbourgon/ff/v2. ðŸ‘ˆ
```
## integr
### pkg.go.dev
modul deprec warn promin display pkg.go.dev. worth explor linkif modul path display modul deprec notices.
### editor integr
editor upgrad dependencies, deprec notic surfac user appropriate.
#40323 propos accepted:
* correct propos alert set operations?
* modul version deprec there' newer major modul version available, propos print warnings?
> correct propos alert set operations?
best knowledge, yes: modul consum first add version modul project meet respect criteria.
> modul version deprec there' newer major modul version available, propos print warnings?
yes.
me, issu propos #40323: one-tim warn depend ad easi miss.
modul deprec seem like good thing surfac `gorelease`, `gopls`, `pkg.go.dev`. `go get` `go mod tidy` seem far late develop cycle, ephemer anyway.
cc @jayconrod @matloob
> me, issu propos #40323: one-tim warn depend ad easi miss . . . `go get` `go mod tidy` seem far late develop cycle, ephemer anyway.
realli understand points. add new modul depend project, run whichev `go` command caus fetch â€” either directli terminal, indirectli editor integr â€” alway watch see result fetch. you? moment, project first gain knowledg new dependency, _precisely_ moment want alert inform like this?
mayb differ workflows, that' possible. love understand yours.
> add new modul depend project, run whichev go command caus fetch â€” either directli terminal, indirectli editor integr â€” alway watch see result fetch. you?
make chang file run `go test` packag contain file, gener watch result test â€” chang modul version happen preced actual test run. (to examin result chang modul requirements, use `git diff` code actual working.)
> make chang file
talk make change, talk first time add new depend project, much less routine.
> gener watch result test â€” chang modul version happen preced actual test run.
ok, think clear chang propos like miss workflow. convinc (a) workflow typical, (b) case impact proposal.
> ok, think clear chang propos like miss workflow. convinc (a) workflow typical, (b) case impact proposal.
fwiw workflow similar. make chang project might use new dependencies, test and/or build output verbos fear warn would lost noise. warn repeat aiui, convinc featur use could be.
usual, warn often ignored. think prefer featur made error add new direct depend that' deprec (either opt-in, default behaviour way opt it).
> alway watch see result fetch. you?
@peterbourgon provid detail workflow?
ask perspect experi use `gopls`, major peopl end ad requir `go.mod` indirectli via `gopls` (larg via `goimports`-esqu workflow). gut feel major peopl (base assumpt major go develop today use `gopls`) use `go get` directli come adding/upgrad dependency.
that' say support notif invok `go get`. howev share @bcmills' @rogpeppe' concern would, cases, notif miss virtu get buri output `cmd/go` end tool used.
> modul deprec seem like good thing surfac `gorelease`, `gopls`, `pkg.go.dev`. `go get` `go mod tidy` seem far late develop cycle, ephemer anyway.
agreed. said, get ux `gopls` "right" annoy tricki (although something).
cc @stamblerr `gopls`
> ask perspect experi use `gopls`, major peopl end ad requir `go.mod` indirectli via `gopls` (larg via `goimports`-esqu workflow). gut feel major peopl (base assumpt major go develop today use `gopls`) use `go get` directli come adding/upgrad dependency.
quit liter type out! :slightly_smiling_face:
workflow come new lib copi `pkg.go.dev` browser' url bar directli editor, `gopls` eventu make chang `go.mod` file virtu tool manag updat it. then, go back termin time later `go mod tidy` clean thing up. much less often termin run `go get` unless explicitli upgrad someth someth need `go mod edit` `gohack` something.
also bring think user (at least gopl vs code) may run test editor, run handi "run test coverage" command code len run specif test, case may never see `go test`' output unless fails. (i fall category, except look coverag debug test; usual run test separ terminal.)
> @peterbourgon provid detail workflow?
>
> ask perspect experi use gopls, major peopl end ad requir go.mod indirectli via gopl (larg via goimports-esqu workflow). gut feel major peopl (base assumpt major go develop today use gopls) use go get directli come adding/upgrad dependency.
time workflow like this, too. say 30% time manual `go get` new modul terminal. neither case ignor partial read output next go tool command end actual perform version resolut fetch.
broader point, editor integr important, would inde hope/expect warn messag pars surfac visibl way editor gopls. sure that' littl warn dialog, like need recompil tools; promin messag postfix output pane; what, exactly. seem like over-reach propos dictat work. messag output, tool surfac howev make sense.
zoom bit, think happi amend proposal(s) describ addit place way emit warning. mechan list simpli obviou us time.
agre editor integr pkg.go.dev important. sure `gorelease` â€” presum meant `goreleaser` â€” want notifi _before_ start write code, after. mayb understand idea there.
thanks.
> neither case ignor partial read output next go tool command end actual perform version resolut fetch.
suspect rather dilig therefor most, included! command succeeds, care much output unless command' princip job show output (e.g. `ls`). henc think @rogpepp point comment specif suggest second paragraph.
`gopls` perform addit (e.g. accept suggest add requir `go.mod`) review output?
> messag output, tool surfac howev make sense.
would surpris `gopls` implement involv pars output `cmd/go` command (not least anoth `cmd/go` invocation, trigger `gopls`, might one see "edge" henc user would miss editor). rather, @bcmill allud repli above, current set warn show user would determin current state `go.mod`. tricki part refer track user action notif instead dismiss "i care".
> sure `gorelease`
suspect @bcmill inde mean `gorelease`. i.e. releas new version modul would final warn modul (indirectly) depend deprec module. think refer depend author' workflow.
> suspect @bcmill inde mean gorelease.
interesting, never heard tool before. seem like kind releas linter? agre make sens surfac there.
> current set warn show user would determin current state go.mod . . .
get @bcmill comments, point clarified, seem reason me, too. intuit dialog gener deprec modul first ad file would best, gopl edge-trigg condition. and/or squiggly-underlin deprec modul requir block go.mod warn (yellow) level?
thought: ad `// deprecated` comment `go.mod`, analog `// indirect`? orthogon question output warning. `go.mod` would pop review even occasion check set depend look reason me.
(in question "when show warning", kinda agre everyon here, feel initi ad would semant correct point time, also would almost certainli miss place. realli opinion, long warn expos `go.mod` care either way)
> interesting, never heard tool
@jayconrod announc time ago. discuss number time golang-tool call variou contexts.
> quiggly-underlin deprec modul requir block go.mod warn (yellow) level?
exactli refer to. challeng come store state dismiss warning. also dismiss author packag (c.f. @merovius' comment) someth personal?
appreci detail one might consid beyond scope propos stands, mind instanc need work backward ui/ux variou tool detail surfac deriv scheme chang `go.mod` wherev make sense.
> challeng come store state dismiss warning. also dismiss author packag (c.f. @merovius' comment) someth personal?
mind, dialog first add natur dismiss-able, squiggli perpetual.
> thought: ad // deprec comment go.mod?
interesting. would logic live? guess go tool?
> interesting. would logic live? guess go tool?
assum - understand is, best way programmat edit `go.mod` call go tool. quit sure *which* go tool invoc would add it, probabl `go mod tidy` least `go get` like adding/upd modul line. personally, fine basic subset that' deem reasonable.
seem like deprec notic shown situat retract notic #24031, name `go list -m -u` `go get` relev module. seem like differ propos suggest show deprec notic once, first time `go.mod` contain deprec notic download cache, retract notic would shown everi time.
advoc show notic situations: user check upgrades, user perform upgrade, regardless what' cache.
(`gorelease`, `pkg.go.dev`, `gopls` show notic well, think ux work later.)
@meroviu
> quit sure _which_ go tool invoc would add it, probabl `go mod tidy` least `go get` like adding/upd modul line. personally, fine basic subset that' deem reasonable.
perhap also plain `go {build, install}` manual add requirement, that' first go tool invoc caus depend fetched?
@peterbourgon sure. reason conserv suggest know controversi `go build` may hit network edit `go.mod`. know reason deprec notic there, far concerned, command edit `go.mod` info probabl add it, :)
thank everyon feedback far. definit help better understand variou way peopl manag modul dependencies.
@rogpepp wrote:
> usual, warn often ignored. think prefer featur made error add new direct depend that' deprec (either opt-in, default behaviour way opt it).
possibl make error, packag maintain want be. break build (or perhap retracting?) packag version deprecated. think desir leav judgmentâ€”of whether worth break new usersâ€”to upstream packag maintainer.
note propos *preclude* gopl someth use here. propos ad deprec mechan modul gopl may (and like will) someth use with. assum want modul deprecations, imo first step incorpor new featur put go tool, broaden scope gopl tool confid taken first step.
@meroviu wrote:
> thought: ad // deprec comment go.mod, analog // indirect? orthogon question output warning. go.mod would pop review even occasion check set depend look reason me.
quit like idea. workflow alway scrutin chang `go.mod` commit new chang repository. hope other same. saw `// deprecated` modul requirement, would certainli give caus investig further.
case, perhap need mechan look deprec messag given module. right straightforward examin `go.mod` arbitrari go modul version, least go tool alone.
@jayconrod wrote:
> seem like deprec notic shown situat retract notic #24031
> [...]
> advoc show notic situations: user check upgrades, user perform upgrade, regardless what' cache.
seem reason me, implement pov may eleg approach (check retract deprec time). mostli agre 1) retract surfac 2) deprec featur want provide, board surfac user way.
@bcmill @jayconrod @matloob, opinion whether move forward this? can't quit tell discuss above.
favor `// deprecated:` comment convention.
also favor @merovius' suggest `go` command surfac deprec depend ad `// deprecated` comment `require` line consumer' `go.mod` file (such `go mod tidy` `go get -u`).
ambival print warn console. certainli think _only_ mean surfac deprecation, seem unobjection accompani someth durabl (such aforement consumer-sid `// deprecated` comments).
think move forward this.
`// deprecated:` comment convent seem like reason way express this. clear, would deprec entir module, individu version modul (i mean sens major version technic differ modules).
comment would extract `@latest` version module. deprec could chang remov releas new version.
`go list -m -u` `go get` surfac warning, togeth retract warnings.
command updat `go.mod` add `// deprecated` comment requir `go.mod` awar deprecations. note #40728 implemented, command updat `go.mod` default, even did, command go resolv `@latest` version. includ `go mod tidy` unless new depend added. practice, `go get` would command would exist dependencies.
entir favor `// deprecated` comment way, feel strongly. seem like annot dependency, module: edg graph rather vertex. said, highli visibl without way.
base discuss above, sound like **like accept**.
chang consensus, accepted.
> clear, would deprec entir module, individu version modul
issu cover particular use case, open anoth one?
someon publish broken version module, seem moment there' current way mark broken deprecated. packag manag work (nuget, npm pypi) current support
@jaxxstorm modul version retract (#24031) cover use case. ship go 1.16.
chang mention issue: `modfile: pars deprec notic modul comments`
chang mention issue: `cmd/go: refactor modload.listmodul accept bit flags`
