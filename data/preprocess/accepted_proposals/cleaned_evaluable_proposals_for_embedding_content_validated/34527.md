cmd/go: add gomodcach
### summari
add `gomodcache` control modul download cach lives. default continu `gopath[0]/pkg/mod`, variabl would similar consist `gocache`.
### descript
modul download cach live `gopath[0]/pkg/mod/` sinc first appeared. understand live `gocache`, build cach located; build gener fast reliabl one source, download modul internet nearli reliable.
also understand put `gopath`; recently, persist directori go made use of. chang last release, addit `os.userconfigdir()+"/go/env"` `go env -w`.
however, there' way configur modul download cach located. example, use ci environ place build modul download cach somewher that' persist builds.
way store download cach elsewher move `gopath` entirely. sever disadvantages:
1) `gopath` contain much more. mani users, still contain code. almost everyone, also contain instal binaries, unless set `gobin`. big knob chang locat modul download cache.
2) mani environ explicitli set `gopath`, `golang:1.13` image, mean can't simpli `go env -w gopath=/custom/path` like could `gocache`. make modul download cach harder deal build cache, appar reason.
3) `gopath`' futur uncertain; might contain future, might go away entirely. reli set modul download cach locat good long-term plan.
idea first came close author. left comment ago, thought would better open new proposal.
one unfortun side propos `gocache` seem mean "directori hold go cach data", `gomodcache` would separate. time machine, argu `gocache` call `gobuildcache` instead.
altern idea eventu re-defin `gopath` directori store persist data belong short-liv `gocache` `<config>/go/env`. would solv point 1 3, 2.
altern partial solut point 2 stop explicitli declar `gopath` offici docker images. might break user switch `$(go env gopath)` handl default properly, hope eventu env var remov anyway.
thank make proposal. briefli recal convers past might want move modul cach $gopath/pkg eventually, help someth action open.
would like see modul cach gopath future. viable, think better outcom without ad configuration. may viable.
think multipl option move modul download cach option. example:
* put `gocache`, sinc cach - expens one rebuild. one could end directori structur like `gocache/build` `gocache/mod`, separ cheap build cache.
* put alongsid `go-build` `os.usercachedir`, exampl `<go-mod>`. though consistency, probabl still requir `gomodcache`.
option put expens cheap cach place default, though. want properli separ moduel cach build cache, here' anoth idea:
* put `os.userdatadir`, ideal world would suitabl portabl place put non-config, non-temporari data.
cc @jayconrod
ad `gomodcache` variabl control cach locat make total sens me.
move default locat modul cach seem disruptive. logic check `$gopath[0]/pkg/mod` exists, not, directori `os.usercachedir()`?
think happi ad env var, worri move default locat right now. repli point show thought might help long term, want move point.
found want `gomodcache` variabl recent anoth use case:
exampl local machin run ide talk remot server sourc tree live mount nfs, go modul go caus bad time due use `flock`, nf support.
```
go: failed to lock file at /Volumes/nfs/go/pkg/mod/cache/lock
```
cours workaround creat dummi `gopath` tree local machin configur ide prepend gopath ahead real one, cach modul locally. that' rather counter-intuit thing though, direct environ variabl control `mod` directori would nice feature.
pleas move default locat download cach gocache.
quot
understand would seem surpris first, cach compil resuilt cach download sourc code bit different.
build cach ($gocache, default $home/.cache/go-build) store recent compil results, need exact compil again, reus file. build cach hold entri like "if run exact compil exact inputs. output get." answer cache, build use littl cpu run compil nstead reus output. guarante abl run compil instead, sinc exact input compil binari (or els even look answer cache).
modul cach ($gopath/src/mod, default $home/go/src/mod) store download sourc code, everi build redownload code requir network origin code available. modul cach hold entri like "if need download mymodule@v1.2.3, file get." answer cache, go network. mayb network right now. mayb code deleted. anywher near guarante redownload sourc also get result. hope can, absolut certainti like build cache. (the go.sum file detect get differ answer re-download, know got wrong bit help make progress actual build code. also path end file-lin inform binaries, show stack traces, like feed tool like text editor debugg necessarili know trigger right cach refresh.)
expect cron job tool clean $home/.cach periodically. part build cach got deleted, would big deal, fine store build cach there. download sourc code got delet unasked, think would potenti quit surpris problemat variou ways. that' store sourc code $gopath/src/mod, keep away expend data.
ad gomodcach seem fine me, @jayconrod said too. @bcmills?
echo @rsc earlier comment: ad `gomodcache` seem fine. let' chang default locat though.
agreed: `gomodcache` variabl seem use enough.
non-parallel name `gocache` unfortunate, probabl unfortun enough warrant anyth drastic renam `gocache` reloc default `gomodcache`.
quick drive-bi thought, want fix inconsist `gocache`, could deprec favor someth like `gobuildcache`, keep accept `gocache` fallback. still perfect though, build cache, also test cache. agre worth effort, `gocache` good enough is.
valu `gomodcache` chang per project. exampl keep differ cach volatil project one persist project.
`gomodcache=./cache` could even replac `./vendor` !
call `gomodpath` avoid unfortun non-parallel naming? (it cach like build cach test cache, sourc code path like $gopath/src). @mvdan
@h12w everywher doc call `modul cache` `modul download cache`. think "cache" okay name, cost chang high - confus larg portion go developers.
modul cach directory/path modul directory/path. word `cache` could omit "non-cache" directori modules. look `go env`, also `gotmpdir` `gotooldir`, imho, `gomoddir` `gomodpath` okay name too. @mvdan
sinc can't use `gocache`, think `gomodcache` best option. alreadi thing use `modcache`, `go clean -modcache`. think `dir` weird (at least never used) one `gopath` enough, pleas bring `path`s. ðŸ˜‚
@aofei said. `go mod clean -modpath` `go mod clean -modcachepath`.
chang mention issue: `cmd/go: allow configur modul cach directori gomodcache`
base @jayconrod @bcmills' comment codereview, (and offlin discuss them) look like two unresolv issu need figur move forward. let correct misunderstanding:
first, propos creat `gomodcache` set `$gopath/pkg/mod` default. leav open question w sumdb directori goes. currently, live `$gopath/pkg/sumdb`. think want put `sumdb` directori `$gomodcache/../sumdb`: would surpris behavior creat new directori side-by-sid user suppli directori name. two altern would (a) start put sumdb `$gomodcache/sumdb`, migrat old sumdb `$gopath/pkg/mod` new location. altern set `gomodcache` `$gopath/pkg` default, put put modul cach `$gomodcache/mod` sumdb `$gomodcache/sumdb`. prefer first option second option bit clunky.
second issu directli address proposal, discussion, seem worth bring up. want specifi relationship `gomodcache` variable, could set `goproxy` proxi modul cache? accord propos have, would `goproxy=file://$gomodcache/cache/download`.
> prefer first option second option bit clunky.
agre - long migrat old sumdb dir smooth.
> want specifi relationship `gomodcache` variable, could set `goproxy` proxi modul cache?
seem like could decid separ issue, long close door proposal.
okay, @bcmill @jayconrod, y'all think?
bit digging, look like relev directori currently:
* `gopath/pkg/mod` contain extract modules.
* `gopath/pkg/mod/cache` contain `download` directori one lock file. seem like kind wast level directory...
* `gopath/pkg/mod/cache/download` contains, essentially, â€œlocal modul proxyâ€œ: cach `.zip`, `.mod`, `.info` files.
* `gopath/pkg/mod/cache/download/sumdb/sum.golang.org` contain cach tile lookup inform checksum database.
* `gopath/pkg/sumdb/sum.golang.org/latest` contain latest sign tree head checksum server.
last entry, think would pretti clearli want slot `gomodcache` `gopath/pkg/mod`, worri much remain nesting. however, seem pretti unfortun leav sign tree head behind.
path come here:

mention part checksum databas design doc:

unfortunately, design doc explain _why_ file is, think need follow @filosottil @rsc figur whether safe relocated.
suspect reason store within `gopath/pkg/mod` sign tree head remov `go clean -modcache`: way, sign tree head never regresses. however, know import properti overal design.
> suspect reason store within `gopath/pkg/mod` sign tree head remov `go clean -modcache`: way, sign tree head never regresses. however, know import properti overal design.
that' correct. import guarante log inde append-only, let us worri less `go.sum` outsid module, example. everi time that' delet window tree get forked.
prefer end cach directory. clear `pkg/`, mayb `userconfigdir`?
> prefer end cach directory. clear `pkg/`, mayb `userconfigdir`?
`userconfigdir` seem like fine choice. signed-tree-head file small, alreadi store `go/env` file there.
however, note `userconfigdir` may fail (for example) neither `home` `xdg_config_home` set non-empti value. (we ran troubl start requir build cache: see #29267.)
think make sens move sth `gopath`. avoid requir `gopath` directori modul mode. sinc sth need somewhat durable, part cach (`gomodcache`, `gocache`, `usercachedir`). `userconfigdir` place make sense.
open question though:
* `$gopath/pkg/mod/sumdb` alreadi exists, keep actual move it? also exist `userconfigdir`, example, 1.14 1.15 use system?
* `userconfigdir` (`home` environ variabl set), `gopath` set (for example, docker container)? error, continu use `$gopath/pkg/mod/sumdb`?
* neither `gopath` `home` set? think current error right there' nowher put modul cache.
imo, move `$gopath/pkg/mod/sumdb` somewher `userconfigdir` directori defined, continu use `$gopath/pkg/mod/sumdb` `userconfigdir` defined.
alpin linux think cach sourc archives.
build server reason setup goproxy, maintain dev machin not.
download archiv go $gopath/pkg/mod/cache/download current way alter location, except alter gopath, suboptim because:
1. contain instal binaries, sumdb unpack sources.
2. file pkg/mod creat unwrit great normal go development, apkbuild want set -modcacherw (avail go1.14) avoid chmod-clean
3. chang unpack sourc undetected, unless run "go mod verify"
4. apkbuild run stuff like "go clean -modcache" wipe everyth pkg/mod.
obviou way us make archiv cach outsid gopath outsid propos gomodcache, mayb yet anoth envvar.
reasonable?
>gopath/pkg/mod/cach contain download directori one lock file. seem like kind wast level directory...
also cache/vcs, creat goproxy=direct
@kaey mean sourc archives? like zip file current `$gopath/pkg/mod/cache/download`? could say use these? example, need stay modul cache, move distribut somewher else? mention archiv cache. intend use modul proxi `file://` url?
>what mean sourc archives? like zip file current $gopath/pkg/mod/cache/download?
yeah ones.
>could say use these?
build packag linux distro want avoid redownload sourc everi rebuild. method actual server (builder ci) set goproxi seem optim me. current alter gopath share locat usabl (but see previou message), usual set insid temporari build dir, clean build done.
>are move distribut somewher els
goproxi seem optim usecase, no, local share space reus across differ build `go build` directli via goproxy=file://... way
>i intend use modul proxi file:// url
really, possibility. way run someth like `go mod download` `fetch()` phase would put zip specifi directori without unpack them, abl set goproxy=file:// `build()` `test()` phases.
