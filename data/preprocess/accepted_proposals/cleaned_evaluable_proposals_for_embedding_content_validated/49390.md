cmd/compile: clarifi whether "-l" "-n" compil flag actual support
**updat dec 15 2021** answer appear be:
> think build -l -n fulli supported. think run standard librari test build -l -n fulli supported.
-@rsc
- - -
seen number chang late test failur `linux-amd64-noopt` builder work around skip test base presenc `-noopt` `go_builder_name` environ variable:

look git history, appear environment-bas skip ad within past year. (a far tell, recent shift, long-stand practice.)
test packag within `std`, thu may run part `go test all` within user' module. user expect set `go_builder_name`, may reason set _supported_ compil flag `goflags` environ variable. `go test all` reason thing user do, pass reliabl support build configuration.
lead central question issue: **are `-l` `-n` flag still support way go user build programs?**
me, exist `linux-amd64-noopt` builder suggest are. however, _are_ supported, test `std` also pass support configur run users, today systemat not.
----
propos take one follow cours action. strong prefer one.
1. declar `-l` `-n` flag _fulli supported_. remov test skip base `go_builder_name` contain `-noopt`, fix test throughout project pass default `-l` and/or `-n` flag set. (perhap convert test benchmarks, and/or skip `go_builder_name` _not_ set.)
2. declar `-l` `-n` flag _fulli supported_, also defin document build tag (such `noopt`) user set (and check for) explicitli disabl test assum optim builds. switch test use build constraint instead `go_builder_name`. (the `noopt` build tag would conceptu similar `purego` tag discuss #23172.)
3. declar `-l` `-n` flag _deprecated_ remain avail one-off debugging, document `cmd/compile` document releas note. continu run builder, allow builder-bas skip go forward.
(cc @filosottile, @bradfitz, @josharian, @cuonglm, @cherrymui)
think question "supported" means. would say "supported" mean "the flag specifi doc, continu so". flag' specifi behavior could print extra debug information, alter compiler' behavior, make compil slower (or faster), includ even gener broken programs. mean gener program expect behavior (like, test expect pass).
said, think action 2 reason approach.
also said, said tool chang (although unlik intent break it). think want declar anyth stronger (so "fulli supported" actual means?).
action 1 non-starter, would prevent us write test protect perform characterist low level code (like proxim caus bug, whether udp send/recv allocates).
action 2 seem perfectli reason me. deal similar problem, name alloc test fail race detector. note build tag annoyingli verbos use skip tests. relat multipl ways: (for purposes, helper intern package.)
@cherrymui
> think question "supported" means.
agre that' heart question. me, â€œsupportedâ€ means:
* semant flag set match go languag spec, caus behavior packag `std` deviat documentation. (thi contrast with, say, `-b` flag, intent violat languag semantics.)
* user file bug (i.e. violat above, compil packag `std`) occur one flag set, treat real bug (and not, say, close invalid infeasible).
* treat flag render binari unsuit product use (a might with, say, certain `goexperiment` settings).
@josharian, cours (1) would prevent us write test protect perform characteristics. would prevent us run test _bi default_ part package' test. option would remain avail include:
* leav test package, skip default. (for example, run test particular flag set, default flag true `go_builder_name` non-empty.)
* move test outsid `std` (for example, `../misc`), still run part `all.bash`.
* convert test benchmark, check benchmark (period code review) regressions.
fwiw, think flag- environment-guard test like less annoy write one guard build constraint, although like slip trybot run code review.
@bcmill option make run test difficult rare. want explain develop packag net need export envvar pretend builder run packag net test insufficient.
track record use benchmark prevent regress terrible. way make terribl tooling. toolingâ€”it' alloc-per-run.
run -n unusu case. let' support it, let' tail wag dog.
@josharian
> want explain develop packag net need export envvar pretend builder run packag net test insufficient.
that' suggest flag. need export variabl pretend builder; pass flag `go test`:
```
$ go test net -checkallocs
```
failur messag trybot default skip messag even tell exactli flag set run it.
agre track record use benchmark prevent regress good, also think unreason expect develop consid allocations, run benchmarks, check regress make chang performance-sensit code. trybot failur remind run benchmark seem unreason me.
@bcmill thanks. would think (non-default) flag support level, least theory. -n -l support -b (again theoretically).
still test ensur do, name -n disabl optimization, -l disabl inlin (same -b disabl bound checks), noth (e.g. none crash compil gener binari run).
"deprecated" (in action 3) sound want, though. (i interpret "deprecated" "you use it; may remov future".)
understand `dlv debug` rebuild binari `-l -n` make easier debug. would impli want keep work documented.
see problem write test work code optimized, especi test compil itself, think question test detect fact. think build tag quit right, easi use can't think anyth els simple, ok it.
use build tag api chang go propos process. drop coupl file internal/testenv use standard library. packag make choices, packag less like write test affect also less like actual run test `-l -n`.
> use build tag api chang go propos process.
think address problem: build tag intern standard library, either test exclud default (a situat @josharian want avoid), fail `-l` and/or `-n` unless go user know set build tag. seem use tag, tag becom part documented, user-fac surfac standard library.
> see problem write test work code optimized, especi test compil itself, think question test detect fact.
test compil â€” test packag like `net`, `runtime`, `crypto/ed25519`.
obpedantic: effect test compiler, express test packages: test compil behav packag expects.
suggest build tag intern standard library. build tag build tag. suggest internal/testenv check "noopt" build tag provid function standard librari call see whether run non-optim build. builder use `-l -n` use build tag.
seem complet address problem standard library. help peopl run test outsid standard library. suggest peopl want test code `-l -n`, use build tag mechanism. "noopt" someth else. realli matter.
reason would need defin offici build tag would non-test code need change. far know, not.
> seem complet address problem standard library. help peopl run test outsid standard library.
state origin post, test packag `std` may run user part `go test all` â€” modul mode expect `go test all` reason thing user do. use undocu build tag help users.
specif case concern is:
1. user write program use `net` `runtime` package. (i'm sure even avoided!)
2. user observ problem program.
3. part debug said problem, user set `goflags=-gcflags=all=-n`, `goflags=-gcflags=all=-l`.
4. part debug said problem, user run `go test all` within module, compil run test packag transit import modul (includ `net` `runtime`).
step (4), user â€” cours diagnos problem program â€” end run test packag `std`, verifi packag actual work platform. `-l` `-n` flag actual supported, test pass like without flags, today not.
is: either user need know someth els step (3), test need someth els step (4), need document explain user â€œwrongâ€ caus test fail.
thanks. guess hard time care much case.
think build `-l -n` fulli supported. think run standard librari test build `-l -n` fulli supported.
suggest use standard-library-specif build tag internal/testenv function suggested, make internal/testenv function
t.log("note: test may fail build -l and/or -n")
testenv function sound good would let us patch boringcrypto alway skip, central workaround boringcrypto-introduc allocations.
/cc @rolandshoemak
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
@ianlancetaylor wrote:
> think build -l -n fulli supported. think run standard librari test build -l -n fulli supported.
answer? anyon object answer?
sound like that' answer.
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
chang consensus, **accepted**. ðŸŽ‰
