net/netip: add new ip address package, use net
propos fix #18804 (net: reconsid represent ip) import `inet.af/netaddr` standard library, probabl `net/netaddr`, `ip` type `netaddr.ip` (the `net` packag alreadi ip type). need import it, least right away, think nice did... packag type work togeth well.
blog post explain advantag `netaddr.ip` `net.ip`:

notably, small, comparable, allocate.
code everybodi go cla file ( licens compatible.
allocation-fre ip address standard librari mean abl fix #45886 ("net: add api receiv multipl udp packet (potenti one system call)") end ("we may want wait anyth figur ip addresses, still allocate."). generally, would improv go' udp performance, never gotten much attention. thing like quic wireguard (both udp-based), go' alloc-heavi udp handl start get way.
yes, two ip type standard library.
part this, add:
* convers func net go (`net` would depend `netaddr`, vice-versa)
* `net` packag intern would switch `netaddr.ip` performance/allocs, convert `net.ip` `ipaddr` edg only.
* coupl new method would ad (notabl `udpconn`) send/rec udp packet use `netaddr.ip` alloc-fre (we'd ~5 way send/recv udp packet instead ~4)
/cc @danderson, @josharian, @mdlayher, @crawshaw, @tklauser (co-authors), @neild (co-author #45886)
cc @marten-seemann quic-go
there' way could address json marshal cidr address format time, would conveni -- rather reli make custom encod etc.
realis backward compat guarante mean that' unlik fix standard librari version "net", could address propos new package, would certainli make life network engin much simpler!
example:
> there' way could address json marshal cidr address format time, would conveni -- rather reli make custom encod etc.

```
fmt:	 192.0.2.0/24
json:	 "192.0.2.0/24"
```
someon invent ip datatyp ( reasons, realli glad see progress topic. look forward see decent ip datatyp golang.
thanks!
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
would worth consid ad runtim primit sort help avoid "workarounds" intern package? think would need done time, user stdlib might make compelling.
@kylelemon propos relat that, notabl probabl #43615. interim, workaround much less problemat stdlib, anyth chang implement would prevent working, chang alongsid it.
@kylelemons, @meroviu said. clear (to anybodi research intern packag horrified), definit propos expos intern packag api. much intern implement detail.
donâ€™t want start bikeshedding, think propos type name look littl bit cluttered, sinc share `ip` prefix:
```
net/netaddr.IP
net/netaddr.IPPort
net/netaddr.IPPrefix
net/netaddr.IPRange
net/netaddr.IPSet
net/netaddr.IPSetBuilder
```
couldnâ€™t ip-part move packag name instead:
```
net/ip.Addr
net/ip.Port
net/ip.Prefix
net/ip.Range
net/ip.Set
net/ip.SetBuilder
```
mayb someth like `net/netip` packag name, `net/ip` short?
otherwise: thank you, @bradfitz, great propos highli enjoy blog post!
nitpick packag name `ip` guess singl commonli use variabl name variabl type `net.ip`, there' high likelihood chang signific section code avoid shadow import `net/ip` code retrofit new packag apis.
@mdlayher still think `ip` nicest option theory, certainli valid practic concern. mayb someth `net/ipa` (for â€ºinternet protocol addressÂ«), avoid shadow jet someth short sensible?
might also make ip2 introduc go "2". use `netip` packag forget belong `net` second.
open discuss
chang mention issue: `net/netaddr: add new ip address package`
#47323, peopl seem gener ok packag net/netip contain
```
type Addr
type AddrPort
type Prefix
type Range
```
comment visibility. pleas comment #47323 opinions. thanks.
given seem consensu four types, seem like full api would be:
```
package net
func (r *Resolver) LookupNetAddr(ctx context.Context, network, host string) ([]netip.Addr, error)
func TCPAddrPort(addr netip.AddrPort) *TCPAddr
func (a *TCPAddr) AddrPort() netip.AddrPort
func UDPAddrPort(addr netip.AddrPort) *UDPAddr
func (a *UDPAddr) AddrPort() netip.AddrPort
func (c *UDPConn) ReadMsgUDPAddrPort(b, oob []byte) (n, oobn, flags int, addr netip.AddrPort, err error)
func (c *UDPConn) WriteToUDPAddrPort(b []byte, addr netip.AddrPort) (int, error)
func (c *UDPConn) WriteMsgUDPAddrPort(b, oob []byte, addr netip.AddrPort) (n, oobn int, err error)
package netip
type Addr struct { ... unexported ... }
func From4(a,b,c,d byte) Addr
func From16(addr [16]byte) Addr  // "raw", no unmapping
func FromSlice(std []byte) (ip Addr, ok bool)  // "raw", no unmapping
func IPv6LinkLocalAllNodes() Addr
func IPv6Unspecified() Addr
func MustParseAddr(s string) Addr
func ParseAddr(s string) (Addr, error)
func (ip Addr) AppendTo(b []byte) []byte
func (ip Addr) As16() [16]byte
func (ip Addr) As4() [4]byte
func (ip Addr) BitLen() uint8
func (ip Addr) Compare(ip2 Addr) int
func (ip Addr) Is4() bool
func (ip Addr) Is4in6() bool
func (ip Addr) Is6() bool
func (ip Addr) IsGlobalUnicast() bool
func (ip Addr) IsInterfaceLocalMulticast() bool
func (ip Addr) IsLinkLocalMulticast() bool
func (ip Addr) IsLinkLocalUnicast() bool
func (ip Addr) IsLoopback() bool
func (ip Addr) IsMulticast() bool
func (ip Addr) IsPrivate() bool
func (ip Addr) IsUnspecified() bool
func (ip Addr) IsValid() bool
func (ip Addr) IsZero() bool
func (ip Addr) Less(ip2 Addr) bool
func (ip Addr) MarshalBinary() ([]byte, error)
func (ip Addr) MarshalText() ([]byte, error)
func (ip Addr) Next() Addr
func (ip Addr) Prefix(bits uint8) (Prefix, error)
func (ip Addr) Prev() Addr
func (ip Addr) String() string
func (ip Addr) StringExpanded() string
func (ip Addr) Unmap() Addr
func (ip *IP) UnmarshalBinary(b []byte) error
func (ip *IP) UnmarshalText(text []byte) error
func (ip Addr) WithZone(zone string) Addr
func (ip Addr) Zone() string
type AddrPort struct { ... unexported ... }
func AddrPortFrom(ip Addr, port uint16) AddrPort
func ParseAddrPort(s string) (AddrPort, error)
func MustParseAddrPort(s string) AddrPort
func (p AddrPort) AppendTo(b []byte) []byte
func (p AddrPort) Addr() Addr
func (p AddrPort) IsValid() bool
func (p AddrPort) IsZero() bool
func (p AddrPort) MarshalText() ([]byte, error)
func (p AddrPort) Port() uint16
func (p AddrPort) String() string
func (p *AddrPort) UnmarshalText(text []byte) error
func (p AddrPort) WithIP(ip Addr) AddrPort
func (p AddrPort) WithPort(port uint16) AddrPort
type Prefix struct { ... unexported ... }
func PrefixFrom(ip Addr, bits int) Prefix
func MustParsePrefix(s string) Prefix
func ParsePrefix(s string) (Prefix, error)
func (p Prefix) AppendTo(b []byte) []byte
func (p Prefix) Bits() int
func (p Prefix) Contains(ip Addr) bool
func (p Prefix) Addr() Addr
func (p Prefix) IsSingleIP() bool
func (p Prefix) IsValid() bool
func (p Prefix) IsZero() bool
func (p Prefix) MarshalText() ([]byte, error)
func (p Prefix) Overlaps(o Prefix) bool
func (p Prefix) String() string
func (p *Prefix) UnmarshalText(text []byte) error
```
also updat discussion' top comment api. pleas comment opinions. thanks.
minor updat
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
@rsc, assum comment miss `range` api, comment includ one four types?
chang consensus, **accepted**. ðŸŽ‰
