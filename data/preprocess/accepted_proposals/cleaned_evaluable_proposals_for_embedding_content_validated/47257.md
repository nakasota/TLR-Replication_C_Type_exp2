cmd/dist: remov precompil .a file binari distribut [freez exception]
download archiv current contain precompil .a file packag standard library. archiv set .a file one platform, plu anoth set `-race` builds.
file take quit bit space, fast rebuild demand. consid remov binari go distributions.
example, 1.17rc1 darwin/amd64, whole distribut uncompress 435m. `pkg/darwin_amd64` directori 97m (22%), `pkg/darwin_amd64_race` directori 109m (25%). compress zip file default settings, archiv 135m. without .a files, 86m (63%).
#40042 fixed, c compil version includ cach key packag use cgo. mean c compil instal system, differ c compil version instal (veri common), `go build` command rebuild packag depend cgo instead use version instal `$goroot/pkg`. 1.17rc1, 27 packag `std` use cgo directli indirectly, prominently, `net`. precompil file packag almost never use unless instal c compil exactli match version use build go distribution.
note fix #40042 caus build fail system without c compil instal (#47215), may partial complet roll back 1.17. implement proposal, problem, may want think chang default valu `cgo_enabled` (#47251).
cc @rsc @bcmill @matloob
anoth reason internet speed vari wildly. people, download extra 50mib split second, mani other stare screen extra minute. eta ftth reach build uk, exampl :)
cpu speed compil time also vary, think lower bound much less worri - even five-year-old thin laptop, one abl build standard librari 10-20s.
think pretti import go binari instal work system c compil installed. least past maco go program would work use cgo version net package. think least need provid .a file standard librari packag use cgo, think current net os/user.
> think pretti import go binari instal work system c compil installed. least past maco go program would work use cgo version net package.
impli maco alreadi possibl build work go program depend `net` `cgo_enabled=0`?
so, would impli without work c compil also possibl build program depend `net` third-parti packag whose sourc file vari base `cgo` build constraint: `cgo` constraint met `cgo_enabled=1` even c compil present. would forc user choos two options:
1. build `cgo_enabled=1` get build error due attempt compil third-parti `//go:build cgo` file without work c compiler.
2. build `cgo_enabled=0`, get appropri sourc file third-parti packag non-work `net` package.
think could resolv one three ways:
1. chang `net` packag requir c compil macos.
2. <strike>chang `cmd/go` build `net` packag maco use c compil even `cgo_enabled=0`.</strike>
3. declar c compil requir order build go program depend `net` macos.
consideration, think option (2) viable. mani way invalid cach entries, set (or setting) `-trimpath`, also caus precompil librari used.
believ builder _already_ invalid cach librari bundl maco release, build use non-default valu `cgo_cflags` (see #33598, #46347, #46292).
@ianlancetaylor
> think pretti import go binari instal work system c compil installed.
would agre priori, understand current state world, introduct build cach broke case mani releas back, complaint (or least enough tri fix it). .a file ship actual right cach key embed insid use essenti out-of-the-box instal go. instead, get recomput (in cach only, instal location) first time build something.
assum right (i done experi myself), think ok drop .a file entir worri "cgo without c compiler" case anymore.
> would agre priori, understand current state world, introduct build cach broke case mani releas back, complaint (or least enough tri fix it). .a file ship actual right cach key embed insid use essenti out-of-the-box instal go. instead, get recomput (in cach only, instal location) first time build something.
@rsc impress look #47215 last week. c compil version becam part cach key #40042. true 1.17rc1, 1.16 lower. neither cc cgo_cflag explicitli set, go command happili use precompil `runtime/cgo.a`, even c compil installed. look narrow rollback cl 335409.
(@bcmill point case cach key match macos, match linux, that' platform worri about, sinc lot folk build docker without instal c compiler).
> 1. chang net packag requir c compil macos.
wonder viabl is?
know littl gut `net` package. read look like go cgo implement name resolution. cgo available, compil select dynam (`godebug=netdns=go` `godebug=netdns=cgo` pick one run-time). macos, cgo version seem preferred.
cgo version actual need written cgo? maco least, link dynam `/usr/lib/libsystem.b.dylib` even `cgo_enabled=0`, need extern linker. cl 227037 lead believ possibl call c code go assembl trampolines. (thi mostli thought experiment; want re-impl `net` awaken cthulhu).
@jayconrod think correct current implement could call maco librari directli without use cgo. true aix solaris, matter.
cgo_enabled=0 goos=darwin:
cgo_enabled=0 effect cross-compiled, headaches: netdns' go simpli inadequate, least use case dn queri rout base domain name differ resolv oper system. /etc/resolv.conf adequ describ os dn rout behavior; there' good way netdn ever correctly.
think plausibl check relev cgo-gener piec stdlib packag need cgo.
need special case "instal runtime/cgo.a .a files".
suggest would defin `go instal x` ever instal binaries, never .a files.
would chang cmd/dist go distribut cmd/go.
distribut would shrink side effect, mean `go install` would becom clearer.
agre `go install` longer instal `.a` files.
think main technic blocker abl build `net` current `netcgo` function without actual need cgo. seem like done either check pre-gener cgo code link c code directli `//go:cgo_import_dynamic`. sure exactli look like, seem plausibl probabl good chang make anyway.
broad `go install` change, bit worri `-buildmode=shared` `-linkshared`. sure work modul mode currently, would good plan deprec fix.
yes, buildmode=shar dead long time. anyon use must use modules.
could potenti special case buildmode=shar standard library, see make work (and even bit iffy).
/cc @mwhudson
propos ad activ column propos project
review weekli propos review meetings.
â€” rsc propos review group
@mwhudson, know exist use -buildmode=shar -linkshar anymore?
believ broken sinc modul introduc think remov them.
thanks!
awar use buildmod currently, no. never quit got point genuin use requir shift bit unfortunately.
base discuss above, propos seem like **like accept**.
â€” rsc propos review group
> suggest would defin `go instal x` ever instal binaries, never .a files.
> would chang cmd/dist go distribut cmd/go.
> distribut would shrink side effect, mean `go install` would becom clearer.
would remov leav *any* method instal .a file asid `build -o file.a`?
(context: reproduc build often use isol build environ build cach cannot persist builds. option reus build artifact current are, order ease:
1. use `install` `gopath`-mod save instal archiv build output;
2. build/instal module-awar mode use more-opaqu possibly-brittl method determin part build cach save build output;
3. use `build -o file.a` package, requir get build order cmd/go actionid portion buildid match.
concern chang would remov option 1, without ad facil make 2 3 less brittle.)
> would remov leav method instal .a file asid build -o file.a?
@iskarian probabl not. `go install` write .a file `goroot/pkg` `gopath/pkg`, there' reason check use .a file either.
think option 2 done safely, either run `go build std` empti cache, save entir cache, run `go list -json -export std` save file `target` field. someth like support bazel blaze, also use go' cach use go command build `std`.
go command realli meant use cach though. cach mandatori sinc go 1.12, part intent eventu remov `gopath/pkg`. point, think there' good reason design around cache.
@jayconrod reasonable. thank explanation.
> think option 2 done safely, either run `go build std` empti cache, save entir cache, run `go list -json -export std` save file `target` field. someth like support bazel blaze, also use go' cach use go command build `std`.
save cach (or cach deltas) wholesal less-than-desir easi see entri correspond (and verifi suppos saved, saved). right now, building, `go list -json -export mypackage` save cach entri `export` field seem work. stabl future? `export`' descript guarante file point contain export data, even though practic seem alway .a file.
chang consensus, **accepted**. ðŸŽ‰
