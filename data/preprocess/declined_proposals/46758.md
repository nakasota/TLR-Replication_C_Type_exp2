=== Fetching Proposal: Limited use cases ===
Issue URL: https://github.com/golang/go/issues/46758

==== [Issue Title] ====
proposal: bufio: add a new method "Handover" for Writer and Reader

==== [Issue Body] ====
<!--
Please answer these questions before submitting your issue. Thanks!
For questions please use one of our forums: https://github.com/golang/go/wiki/Questions
-->

### What version of Go are you using (`go version`)?

<pre>
$ go version
go version go1.16.5 linux/amd64
</pre>

### Does this issue reproduce with the latest release?

Yes.

### What operating system and processor architecture are you using (`go env`)?

<details><summary><code>go env</code> Output</summary><br><pre>
$ go env
GO111MODULE=""
GOARCH="amd64"
GOBIN="/data/go/bin"
GOCACHE="/root/.cache/go-build"
GOENV="/root/.config/go/env"
GOEXE=""
GOFLAGS=""
GOHOSTARCH="amd64"
GOHOSTOS="linux"
GOINSECURE=""
GOMODCACHE="/data/go/pkg/mod"
GONOPROXY=""
GONOSUMDB=""
GOOS="linux"
GOPATH="/data/go"
GOPRIVATE=""
GOPROXY="https://proxy.golang.org,direct"
GOROOT="/snap/go/7736"
GOSUMDB="sum.golang.org"
GOTMPDIR=""
GOTOOLDIR="/snap/go/7736/pkg/tool/linux_amd64"
GOVCS=""
GOVERSION="go1.16.5"
GCCGO="gccgo"
AR="ar"
CC="gcc"
CXX="g++"
CGO_ENABLED="1"
GOMOD="/dev/null"
CGO_CFLAGS="-g -O2"
CGO_CPPFLAGS=""
CGO_CXXFLAGS="-g -O2"
CGO_FFLAGS="-g -O2"
CGO_LDFLAGS="-g -O2"
PKG_CONFIG="pkg-config"
GOGCCFLAGS="-fPIC -m64 -pthread -fmessage-length=0 -fdebug-prefix-map=/tmp/go-build1082148225=/tmp/go-build -gno-record-gcc-switches"
</pre></details>

### What did you do?

<!--
If possible, provide a recipe for reproducing the error.
A complete runnable program is good.
A link on play.golang.org is best.
-->
bufio.Writer:
```go
type Writer struct {
	err error
	buf []byte
	n   int
	wr  io.Writer
}
```

I set up a `net.Conn` c as the underlying `io.Writer` wr of `bufio.Writer` bw and replaced bw.wr with a `bytes.Buffer` bb (by calling `bufio.Reset(bb)`) when the TCP socket disconnected caused by any network problem, so other goroutines can continue calling `bufio.Write()/Flush()` to write/flush data into the local buffer bb (bw.wr), not knowing the network problem, I will create a new `net.Conn` and replace bw.wr with it, then copy all data in bb to bw.buf once the TCP socket resumes.

Because the bw was shared by multiple goroutines (goroutine-safe along with mutex), some of goroutines might have called `bufio.Write()` writing data into the bw.buf before `bufio.Reset(bb)` was called, which means those data will be lost, when I reconnected to the remote server, I want to send all buffered data (including data was in bw.buf before `bufio.Reset(bb)` was called) to the remote server.


### What did you expect to see?

All buffered data was sent to the remote server after a reconnection.


### What did you see instead?

I lost some data by calling `bufio.Reset(bb)`.

So I propose to add a new method "Handover" for Writer and Reader, Handover is the same as Reset, except it retains all unflushed buffered data and migrates them to the new underlying `io.Writer`.

It would be something like this:
```go
func (b *Writer) Handover(w io.Writer) error {
	if err := b.err; err != nil || b.n == 0 {
		b.Reset(w)
		return err
	}
	b.wr = w
	b.err = b.Flush()
	return b.err
}

func (b *Reader) Handover(r io.Reader) error {
	n := b.Buffered()
	if err := b.err; err != nil || n == 0 {
		b.Reset(r)
		return err
	}
	b.rd = r
	b.err = nil
	return nil
}
```
I can call `bw.Handover(bb)` to retain all unflushed buffered data and flush it to `bytes.Buffer` bb instead of calling `bw.Reset(bb)` to discard all unflushed buffered data in bw.buf.


==== [Comments] ====

--- Comment #1 by davecheney ---
What you are asking for is not race safe. 

--- Comment #2 by davecheney ---
If you want to implement this logic, insert your own type between bufio and net Conn. Then you have the hooks to reopen network connections as you desire. 

--- Comment #3 by panjf2000 ---
> If you want to implement this logic, insert your own type between bufio and net Conn. Then you have the hooks to reopen network connections as you desire.

That results in one extra data copy which I'm trying to avoid.

--- Comment #4 by davecheney ---
Btw, I don’t think this will be reliable because data may be lost between the sender and receiver in such a way that you cannot correctly determine the number of bytes received so you can correctly rewind the writer. This problem of distributed coordination is considered non trivial. 

--- Comment #5 by davecheney ---
> > If you want to implement this logic, insert your own type between bufio and net Conn. Then you have the hooks to reopen network connections as you desire.
> 
> That results in one extra data copy which I'm trying to avoid.

I don’t believe this is correct. io.Writer does not require intermediaries to buffer data. 

--- Comment #6 by panjf2000 ---
> > > If you want to implement this logic, insert your own type between bufio and net Conn. Then you have the hooks to reopen network connections as you desire.
> > 
> > 
> > That results in one extra data copy which I'm trying to avoid.
> 
> I don’t believe this is correct. io.Writer does not require intermediaries to buffer data.

The thing is, there is already some unflushed buffered data in bw.buf, how can I migrate it to a new `io.Writer` like `bytes.Writer`?

--- Comment #7 by davecheney ---
I don’t think think you need to module bufio to do what you’re asking. I also think what you are asking is unsound because tcp will lie to you. I think you can prove this to yourself, or prove me wrong, with an straight net.Conn. If you can build a wrapper type that can handle the underlying net.Conn going away and being reconnected, then wrapping a bufio Writer around that whole thing for convenience can be done afterwards. 

--- Comment #8 by panjf2000 ---
Let's just put the TCP aside, I still think that `bufio.Writer` outght to allow users to retain buffered data when switching the underlying `io.Writer`, for some scenarios.

Discarding all buffered data is also unsound to me from where I stand.

--- Comment #9 by davecheney ---
Maybe, but why should the ability to switch underlying writers be restricted to just bufio? That feels like the domain of a different type which itself implements io.writer

--- Comment #10 by panjf2000 ---
In case you didn't notice, actually `bufio.Writer` itself is already a wrapper of `io.Writer`, thus it's rational to ask it to evolve more abilities.

--- Comment #11 by panjf2000 ---
It just really bothers me that bufio allows users to switch the underlying `io.Writer` of `bufio.Writer` (by `bufio.Reset(w)`) and yet forbids them to do so while retaining unflushed buffered data.

--- Comment #12 by ianlancetaylor ---
I agree with @davecheney : write your own type that does what you need.  There is nothing particularly special about `bufio.Writer`.  What you are looking for seems very special purpose.

--- Comment #13 by panjf2000 ---
My case might be specific, but it should be all-purpose for a new method that is like Reset() but retains buffered data. I only brought my case out for illustrating the requirement and I believe there are more scenarios.

--- Comment #14 by gopherbot ---
Change https://golang.org/cl/329569 mentions this issue: `bufio: add a new method "Handover" for Writer and Reader`

--- Comment #15 by rsc ---
As others have noted, the easy way to do this is to make your own Reader/Writer implementation that you pass to bufio.

```
type SwappableWriter struct {
	io.Writer
}

sw := &SwappableWriter{c}
b := bufio.NewWriter(sw)
b.Write(whatever)
sw.Writer = newC // "Handover"
```

There is literally no code required, just a `type` declaration.
This is incredibly specialized and does not seem worth complicating the bufio API for.

--- Comment #16 by panjf2000 ---
Thank you @rsc for the solution which is actually similar to my current implementation, I just come here to ask for opinions from the Go team about adding this ability to `bufio`, still, the case I've given above might be specific, but it should be all-purpose for a new method that is like `Reset()` but retains buffered data since `bufio.Writer` is already a wrapper for `io.Writer`.

Thanks again for your advices and time.

--- Comment #17 by rsc ---

This proposal has been added to the [active column](https://golang.org/s/proposal-status#active) of the proposals project
and will now be reviewed at the weekly proposal review meetings.
— rsc for the proposal review group


--- Comment #18 by rsc ---

Based on the discussion above, this proposal seems like a **[likely decline](https://golang.org/s/proposal-status#likely-decline)**.
— rsc for the proposal review group


--- Comment #19 by rsc ---

No change in consensus, so **[declined](https://golang.org/s/proposal-status#declined)**.
— rsc for the proposal review group

