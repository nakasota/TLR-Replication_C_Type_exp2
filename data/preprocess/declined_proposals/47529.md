=== Fetching Proposal: Existing alternatives ===
Issue URL: https://github.com/golang/go/issues/47529

==== [Issue Title] ====
proposal: cmd/compile: no bound check compiler directive

==== [Issue Body] ====
Hi,
I am proposing the following directive to disable bound checking (what `-B` compiler option does) per function (including closures), like:
```
//go:noboundcheck
func someFunc() int {
  ..
}

func otherFunc(x int) int {
  ..
  //go:noboundcheck
  cl := func() {
    // do something with x
  }
  ..
}
```
- The directive will greatly help carefully written, low level, performance critical functions like a [lesswap](https://pkg.go.dev/github.com/jfcg/sorty#Sort) closure where the compiler has no way to prove/disprove bounds safety.
- There would be many other regular functions and closures where it would be very useful.
- It is much safer to use this directive at certain places than to use `-B` on a package or an entire project.
- It will affect only the function following the directive (and not any closures inside that function, unless they are also tagged).

==== [Comments] ====

--- Comment #1 by robpike ---
I would very much prefer this not happen, as it breaks memory safety with no recourse. Decades of history with C have taught us that even skilled programmers enable overflows inadvertently, with dire consequences. What it does in the hands of less skilled programmers, or even skilled ones who import one inadvertently, is not to be countenanced.

Go has bound checks for a reason: Humans are not good enough at guaranteeing indexes stay in bounds. Putting one's hand up and saying, "yes I am" is insufficient.


--- Comment #2 by mvdan ---
If a human can prove a bounds check is unnecessary within a scope or func body, I would hope we can teach the compiler to do the same. That has been improving over the past half decade.

--- Comment #3 by jfcg ---
I agree with you all but in the lesswap case for example, the closure and the sorting library (user of the closure) live in different packages. They may even be compiled at different times and places. There is nothing to teach the compiler. There is just no way it can guess lesswap should not have bound checks. Using the closure with the right/wrong indices is the library's responsibility/fault.

--- Comment #4 by mvdan ---
If performance trumps safety for your library, perhaps consider using unsafe? Forcing the compiler to disable memory safety is practically the same, but worse since the user would not be aware that unsafe is involved.

--- Comment #5 by josharian ---
Related: https://github.com/golang/go/issues/30582

--- Comment #6 by rsc ---

This proposal has been added to the [active column](https://golang.org/s/proposal-status#active) of the proposals project
and will now be reviewed at the weekly proposal review meetings.
— rsc for the proposal review group


--- Comment #7 by beoran ---
Why is there even a -B flag? I'd rather propose to remove that as well in stead.

--- Comment #8 by bcmills ---
> in the lesswap case for example, the closure and the sorting library (user of the closure) live in different packages. They may even be compiled at different times and places. There is nothing to teach the compiler.

The compiler emits export data for packages, and — at least for unexported functions and function literals — it can, in theory, reason about those functions based on what they are passed to. In addition, even an exported function may be inlined or specialized at particular call sites, and techniques like [profile-guided optimization](https://en.wikipedia.org/wiki/Profile-guided_optimization) may allow that to be done even in a language like Go that aims to keep build times and binary sizes low.

So, at least in theory, the export data for the `sorty` package could include information about the ranges of values it will pass to the `Lesswap` function, and the compiler could eliminate the bounds checks there.

(Here I'm really just expounding on @mvdan's more fundamental observation in https://github.com/golang/go/issues/47529#issuecomment-892584611. Facts that are obvious to human maintainers should also be “obvious enough” to automated tools.)

--- Comment #9 by zephyrtronium ---
@beoran 
> Why is there even a -B flag? I'd rather propose to remove that as well in stead.

The -B flag helps to quantify the cost of bounds checks in a program, which allows developers to decide when it is worthwhile to optimize them out.

--- Comment #10 by rsc ---

Based on the discussion above, this proposal seems like a **[likely decline](https://golang.org/s/proposal-status#likely-decline)**.
— rsc for the proposal review group


--- Comment #11 by rsc ---

No change in consensus, so **[declined](https://golang.org/s/proposal-status#declined)**.
— rsc for the proposal review group

