=== Fetching Proposal: License problem ===
Issue URL: https://github.com/golang/go/issues/47049

==== [Issue Title] ====
proposal: syscall: add landlock support on Linux

==== [Issue Body] ====
Due to golang policy on fork/exec, I have to double-run myself, set landlock rules and exec into desired executable. This all looks like a dirty hack, especially in terms of library code where you can't simply re-exec yourself. I propose to add native landlock support.

Reference: https://landlock.io
POC implementation: https://github.com/gnoack/golandlock

Example:
```go
package main

import (
	"log"
	"os/exec"
	"syscall"

	"golang.org/x/sys/unix"
)

func main() {
	// /tmp and /var/tmp are readable, /home is not readable
	cmd := exec.Command("/bin/ls", "/tmp", "/var/tmp", "/home")
	cmd.SysProcAttr = &syscall.SysProcAttr{
		LandlockRules: []syscall.LandlockRule{
			{
				Flags: unix.LANDLOCK_ACCESS_FS_READ_DIR,
				Files: []string{
					"/tmp",
					"/var/tmp",
				},
			},
			// this could be done implicitly
			{
				Flags: unix.LANDLOCK_ACCESS_FS_EXECUTE,
				Files: []string{
					"/bin/ls",
				},
			},
		},
	}

	if err := cmd.Run(); err != nil {
		log.Fatal(err)
	}
}
```

==== [Comments] ====

--- Comment #1 by mvdan ---
Presumably this would be an addition to x/sys/unix, given that the syscall package is frozen:

> Deprecated: this package is locked down. Callers should use the corresponding package in the golang.org/x/sys repository instead. That is also where updates required by new systems or versions should be applied. See https://golang.org/s/go1.4-syscall for more information.

--- Comment #2 by mvdan ---
Ah, I see that os/exec references a syscall struct directly, so I assume you would need additions to both.

--- Comment #3 by ianlancetaylor ---
Can you propose a specific API to add to the syscall package?  As far as I can tell the golanglock package you mention can be implemented entirely outside of the standard library, and we could for example discuss adding it to x/sys/unix.  What do we need in syscall?  Thanks.

--- Comment #4 by rsc ---
Would it suffice to add to syscall.SysProcAttr the rulesetfd (as an *os.File I guess) and have the child call landlock_restrict_self on that fd?
Why does the whole rule language have to go into SysProcAttr?



--- Comment #5 by rsc ---

This proposal has been added to the [active column](https://golang.org/s/proposal-status#active) of the proposals project
and will now be reviewed at the weekly proposal review meetings.
— rsc for the proposal review group


--- Comment #6 by rsc ---
Ping @illiliti re API questions above.


--- Comment #7 by illiliti ---
> Would it suffice to add to syscall.SysProcAttr the rulesetfd (as an *os.File I guess) and have the child call landlock_restrict_self on that fd? Why does the whole rule language have to go into SysProcAttr?

Sounds good. All other functionality that creates and manages rulesetfd will go into `x/sys/unix`. It should be very simple to implement.

NIT: I suppose rulesetfd should be `int` because `File` usually represents regular files and rulesetfd is not a regular file.

--- Comment #8 by rsc ---
It sounds like all we need to do is add

    LandlockRuleSet int

to SysProcAttr? But what about the zero value? 0 is a valid fd and if you have nothing open it's what opening the landlock fd will return. So it sounds like maybe we need

    UseLandlock bool
    LandlockRuleSet int

?

How often does this arise?

--- Comment #9 by illiliti ---
> 0 is a valid fd

Right.

> How often does this arise?

bool is already used by `Foreground` and `Setctty` to control `Ctty` fd. I think it is valid to use bool here. Alternatively, we can choose slice and use its default value to avoid bool helper.

--- Comment #10 by rsc ---
Does anyone object to adding to SysProcAttr:

    UseLandlock bool
    LandlockRuleSet int // fd of rules

?


--- Comment #11 by illiliti ---
Closing this because https://github.com/golang/go/issues/49383 is WONTFIX. Very disappointed in Go. Feel free to reopen, but don't expect any contribution from me.

--- Comment #12 by rsc ---
Treating this as retracted, but it seems like we reached a reasonable API change. What we don't know is whether it is good enough in practice or whether anyone needs it. If someone does need it, please feel free to open a new proposal and we can continue this discussion. Thanks.

And apologies @illiliti for the requirement. 

--- Comment #13 by rsc ---

This proposal has been **[declined as retracted](https://golang.org/s/proposal-status#declined-as-retracted)**.
— rsc for the proposal review group

