=== Fetching Proposal: Poor feasibility ===
Issue URL: https://github.com/golang/go/issues/45108

==== [Issue Title] ====
proposal: cmd/vet: diagnose marshal of field of type error

==== [Issue Body] ====
This proposal is to add a new vet checker that warns when an exported `error` field of a struct is marshaled. Currently what will happen is that as error is an interface this will use the [marshaling](https://golang.org/pkg/encoding/json/#Marshal) of the underlying type. `error` values created by `errors.New()` and `fmt.Errorf()` are currently implemented by structs with unexported string fields. The result is that the marshaled value is "{}".

This behavior is well defined, but many users expect to see the "err.Error()" value. These would consider their code buggy. So this plausibly satisfies vet's correctness criteria.

Similar issues: #26946, #41241, #26889, #23549.

Example:
https://play.golang.org/p/XHoSKtGwAUN

```
package main

import (
	"encoding/json"
	"fmt"
)
type Response struct {
	Err error `json:"error"`
}
func main() {
	v := &Response{Err: fmt.Errorf("oops")}
	b, err := json.Marshal(v)
	if err != nil {
		panic(err)
	}
	fmt.Printf("Marshaled value: %s\n", b)
}
```

Output:
```
Marshaled value: {"error":{}}
```

The current focus is on `json.Marshal()`, but could be extended to similar standard library functions.

To avoid spurious reports the proposed conditions to warn would be when:
* there is a `json.Marshal(e)` expression,
* we can locally identify a non-interface type `T` for `e`, and
* marshaling `T` reaches an exported error field (follow pointers, struct sub-fields, map fields, etc.) without traversing an interface or a type with `MarshalJSON()` defined on it.

These reports can potentially be considered false positives when all of the underlying types of the error values stored in the field have an MarshalJSON function defined or have a well defined serialization: `type MyErr string; func (MyErr) Error() string {...}`.

This would not report flows through `interface{}` variables for functions wrapping `json.Marshall()`. Example of this pattern but not necessarily for error values [here](https://github.com/google/safehtml/blob/85ae69c35a0990a1f40f265f0788e0a75be771a1/script.go#L71).

==== [Comments] ====

--- Comment #1 by rsc ---
The hard part here is false positives. It is technically fine to json.Marshal a field of type error when it is nil or when it contains a JSON-able error. If you only trigger when you _know_ it's a non-JSON-able error, that would be a possibility. But that might have too many false negatives.



--- Comment #2 by rsc ---

This proposal has been added to the [active column](https://golang.org/s/proposal-status#active) of the proposals project
and will now be reviewed at the weekly proposal review meetings.
— rsc for the proposal review group


--- Comment #3 by rsc ---

Based on the discussion above, this proposal seems like a **[likely decline](https://golang.org/s/proposal-status#likely-decline)**.
— rsc for the proposal review group


--- Comment #4 by rsc ---

No change in consensus, so **[declined](https://golang.org/s/proposal-status#declined)**.
— rsc for the proposal review group

