=== Fetching Proposal: MDU6SXNzdWU3MTQ3NjE1MDY= ===
Issue URL: https://github.com/golang/go/issues/41790

==== [Issue Title] ====
database/sql: close driver.Connector if it implements an io.Closer

==== [Issue Body] ====
I propose adding a new `sql.DB.Close` behavior/side effect: closing `driver.Connector` if it implements an optional `io.Closer` interface.

See [CL 258360][0] /  #41710

We would like to be able to manage the resources in `driver.Connector`, e.g. to share the same underlying database handle between multiple connections. This is required for some embedded databases with in-memory backends like [SQLite][1] and [Genji][2] so that we don’t create a new in-memory store whenever `sql.DB` decides to ask for a new connection by calling `driver.Connector.Connect`.

For in-memory storage [go-sqlite3][3] driver docs currently advice manually setting `cache=shared` DSN parameter, and non-zero [max idle connection limit][4] and infinite [connection lifetime][5] on `sql.DB`. (see [FAQ: Why I'm getting no such table error?][6]).

It get worse with Genji since both on-disk BoltDB and BadgerDB engines lock the database. That is, connector can’t open the database until the existing handle is closed. With `database/sql` it means that either user must set connection limit to 1, or we have to share the handle between `driver.Conn` instances, which also allows us to support [concurrent transactions with BadgerDB][7] (see [genjidb/genji#210][8]).

That said, we need to release the resources held by `driver.Connector` (e.g. close file handle, unlock database or free unmanaged memory) when `sql.DB` is no longer needed.

[0]: https://golang.org/cl/258360
[1]: https://sqlite.org
[2]: https://genji.dev
[3]: https://github.com/mattn/go-sqlite3
[4]: https://golang.org/pkg/database/sql/#DB.SetMaxIdleConns
[5]: https://golang.org/pkg/database/sql/#DB.SetConnMaxLifetime
[6]: https://github.com/mattn/go-sqlite3#faq
[7]: https://dgraph.io/blog/post/badger-txn
[8]: https://github.com/genjidb/genji/issues/210


==== [Comments] ====

--- Comment #1 by ianlancetaylor ---
CC @kardianos 

--- Comment #2 by kardianos ---
The bar to expand or update the existing database/sql (v1) is fairly high

However, the change is simple and won't interact with anything else. There is one other situation that this would help. If a driver for a database without inline connection cancelation has a background goroutine/connection dedicated to closing connections, this would provide a way to prevent that connection from leaking.

I would say tentatively accept.

--- Comment #3 by rsc ---
@kardianos, we'll take care of updating the proposal project status. It needs to go through some discussion before moving to likely accept. Thanks.



--- Comment #4 by rsc ---
Adding to minutes.


--- Comment #5 by rsc ---
Does anyone object to adding this?


--- Comment #6 by rsc ---
Based on the discussion, this seems like a **likely accept**.



--- Content after FINAL acceptance decision removed ---