=== Fetching Proposal: MDU6SXNzdWU5MDgzMzkwNDE= ===
Issue URL: https://github.com/golang/go/issues/46485

==== [Issue Title] ====
go/parser: add a SkipObjectResolution mode flag

==== [Issue Body] ====
In #45104, `go/parser` was refactored to make parsing and object resolution separate passes within `ParseFile`. As a side effect of this change it is trivial to add a mode that skips object resolution entirely. This issue proposes adding such a mode flag: `SkipObjectResolution`. (note that this mode was initially added as part of #45104, but that is going to be backed-out pending the discussion here).

### Background

Object resolution is a feature of `go/parser` that attempts to resolve identifiers to their declaration, setting `ast.Ident.Obj`, for use in tools or basic analyzers that need such information. Notably this information is incomplete and in some cases inaccurate: object resolution does not properly handle selectors or fields in composite literals, and often lacks information about declarations in other files or packages. It is also redundant with the information produced by `go/types`. For this reason object resolution has limited utility, particularly for tools that either deal only with syntax, or which use the output of `go/types` for identifier information (`go/types` itself does not need object resolution in order to function).

### Pros and Cons

In my testing, skipping object resolution saves 18-20% of the parsing time, which made `gofmt` around 10% faster (when not rewriting or simplifying, which make use of object resolution). It also avoids unnecessary allocation.  It's a small but meaningful optimization for tools that know they won't need `ast.Ident.Obj`. See #45104 for some further discussion.

For completeness, it's worth considering the downside of adding such a mode. For one, it adds a new mode that must be supported. However, I think this is a negligible cost: it's unlikely that in the future we revert the refactoring of #45104, but even so, skipping object resolution can still be achieved by adding guards in the functions that record or resolve identifiers. It's also worth noting that this mode is not entirely orthogonal to existing modes: `ReportDeclarationErrors` only works if object resolution is not skipped.

I think the _strongest_ argument against adding this new mode is that it's simply not necessary. However, my current expectation is that it would add a small benefit for some users at a relatively smaller cost.

CC @griesemer @mvdan 

==== [Comments] ====

--- Comment #1 by gopherbot ---
Change https://golang.org/cl/323909 mentions this issue: `go/parser: un-export the SkipObjectResolution mode pending discussion`

--- Comment #2 by griesemer ---
The object resolution mode is not useful for tools that run a resulting AST through the type checker or which only care about an unadorned syntax tree, e.g. for formatting. This feature is present for historical reasons (the `go/parser` is one of the first larger go/package that was ever written and still in use).

The fact that not doing object resolution can save up to 20% parse time is significant. Arguably, not doing object resolution should be the default but that would be a non-backward compatible change of behavior. Note also that this mode was implemented and operational well before the Go1.17 freeze.

In short, the suggested new SkipObjectResolution mode provides an easy way to increase performance for many tools simply by setting the flag.

I don't see any good reason for not doing this.

--- Comment #3 by mvdan ---
I fully agree with what Robert said. I don't see a reason why this change must be in 1.17, but the code and API have been there for a while, so it's not like we missed the freeze deadline. So I also don't see a reason to push it back to 1.18.

We did not follow the proposal process properly, which perhaps meant some potential objections weren't raised. We can see here if anyone brings any in the next week or two, though I personally doubt it :)

--- Comment #4 by dominikh ---
This also benefits `go list -test`, which fully parses test files to extract test functions. 

For `go list -test -json std`, we go from 0.61s to 0.53s. 

This speedup would automatically trickle down to users of `go/packages`, without them having to change their code in any way.

--- Comment #5 by rsc ---

This proposal has been added to the [active column](https://golang.org/s/proposal-status#active) of the proposals project
and will now be reviewed at the weekly proposal review meetings.
â€” rsc for the proposal review group


--- Comment #6 by rsc ---

Based on the discussion above, this proposal seems like a **[likely accept](https://golang.org/s/proposal-status#likely-accept)**.
â€” rsc for the proposal review group


--- Comment #7 by rsc ---

No change in consensus, so **[accepted](https://golang.org/s/proposal-status#accepted)**. ðŸŽ‰
This issue now tracks the work of implementing the proposal.
â€” rsc for the proposal review group

--- Content after FINAL acceptance decision removed ---