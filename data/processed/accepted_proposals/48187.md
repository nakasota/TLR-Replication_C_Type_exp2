=== Fetching Proposal: MDU6SXNzdWU5ODgyNjUzOTc= ===
Issue URL: https://github.com/golang/go/issues/48187

==== [Issue Title] ====
cmd/go: go version to support non-executable Go binaries

==== [Issue Body] ====
The `go version` command only supports executable files, restriction that is stated in its documentation:

`Go version reports the Go version used to build each of the named executable files.`

This restriction is implemented by checking for a `.exe` file extension on Windows and by checking if the file has  `0111` permissions.

https://github.com/golang/go/blob/4d66d77cd22812de4526e3973bc3314040a939a5/src/cmd/go/internal/version/version.go#L107-L112

I propose that `go version` should also support non-executable binaries, such as binaries compiled using `buildmode=c-shared` and `buildmode=c-archive`, as these binaries can also contain useful version data.

See #45234 for a detailed use-case.

@rsc 
 

==== [Comments] ====

--- Comment #1 by rsc ---
It sounds like maybe the version info is there, and we don't look for it?

/cc @jayconrod @bcmills 

--- Comment #2 by rsc ---

This proposal has been added to the [active column](https://golang.org/s/proposal-status#active) of the proposals project
and will now be reviewed at the weekly proposal review meetings.
‚Äî rsc for the proposal review group


--- Comment #3 by bcmills ---
If there is a straightforward fix to the `go version` subcommand, I think we should just fix it (with an accompanying regression test). I'm not sure that a formal proposal is really needed.

If the fix is not straightforward, then I think this will ultimately fall into a much-needed ‚Äú`buildmode` cleanup‚Äù bucket, which is probably long overdue but also difficult to prioritize.

--- Comment #4 by jayconrod ---
Build info is stamped into files built in `c-archive` and `c-shared` mode, but `go version` doesn't attempt to read it.

It might be very simple to extend `go version -m` to work with files built in `c-shared` mode. The only thing I'm not sure about is whether we need to apply relocations when reading information out of the binary. I don't think so since we're not actually loading the binary into memory.

`c-archive` is a little harder: `go version -m` would need to understand the archive format enough to find the executable within it.

--- Comment #5 by ianlancetaylor ---
Note that we have archive reading code in cmd/link/internal/ld/ar.go.

--- Comment #6 by josharian ---
If we can tolerate extremely rare false positives, it may also be cheaper and easier not to parse the file at all. See e.g. https://github.com/tailscale/tailscale/commit/a4e19f22339d9d618dcf459ca5709b2701aada56.

--- Comment #7 by rsc ---
We already don't really parse the file, except to find the start of the data segment. Sometimes the data segment is very far into the binary, so we use the parsing to skip to at least the right approximate place. I suppose we could just read the entire file but that's going to be slower.


--- Comment #8 by rsc ---
It sounds like this is probably pretty easy and that we should just do it.


--- Comment #9 by rsc ---

Based on the discussion above, this proposal seems like a **[likely accept](https://golang.org/s/proposal-status#likely-accept)**.
‚Äî rsc for the proposal review group


--- Comment #10 by gopherbot ---
Change https://golang.org/cl/357569 mentions this issue: `debug/buildinfo: add regression tests for different buildmodes`

--- Comment #11 by qmuntal ---
I've added some more `debug/buildinfo` tests in CL 357569 to ensure it can retrieve buildinfo from `exe`, `pie` and `c-shared` buildmodes.

I haven't added a test for `c-archive` because it fails on my computer (`windows/amd64`) with the error `unrecognized file format`.

--- Comment #12 by rsc ---

No change in consensus, so **[accepted](https://golang.org/s/proposal-status#accepted)**. üéâ
This issue now tracks the work of implementing the proposal.
‚Äî rsc for the proposal review group


--- Comment #13 by gopherbot ---
Change https://go.dev/cl/391855 mentions this issue: `cmd/go: go version to support shared libraries`

--- Comment #14 by gopherbot ---
Change https://go.dev/cl/442035 mentions this issue: `doc/go1.20: go version supports non-executable Go binaries`
