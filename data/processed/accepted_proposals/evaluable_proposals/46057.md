=== Fetching Proposal: MDU6SXNzdWU4ODExOTUyOTY= ===
Issue URL: https://github.com/golang/go/issues/46057

==== [Issue Title] ====
crypto/x509: add CertPool.Equal

==== [Issue Body] ====
### What version of Go are you using (`go version`)?

go 1.16.x

### What did you expect to see?

In response to #45891, `x509.CertPool` structs can no longer be compared with `reflect.DeepEqual`, and [there is no way to export the certificates](https://github.com/golang/go/issues/19606), so there is no longer any way to fully compare these structs.

`CertPool.Subjects` can be used for a shallow comparison, but https://github.com/golang/go/issues/45891#issuecomment-831522265 shows that this is not a complete comparison.

By adding an `Equal(other CertPool) bool` these types can be compared directly, and [go-cmp](https://github.com/google/go-cmp) will automatically use the method for comparison.

==== [Comments] ====

--- Comment #1 by bradfitz ---
In recent versions of Go, CertPool now internally represents a lazy set of certificates that might not be fully loaded yet.

What does "Equal" mean in this proposal? Would you want it to load them all from disk if they weren't yet?

Can you give some background on when you'd use this?


--- Comment #2 by dnephin ---
> In recent versions of Go, CertPool now internally represents a lazy set of certificates that might not be fully loaded yet.

Yes, I believe this change is what prevents `reflect.DeepEqual` from working as it did before (#45891).

#45891 has some context.  We have tests that used `reflect.DeepEqual` to compare two `x509.CertPool`, which worked fine in go1.15.x. In Go 1.16.x those tests no longer work because two effectively equivalent cert pools are no longer considered equal.

I would expect `Equal` to load all the content from disk and compare the content using `reflect.DeepEqual`, which I think should make it equivalent to using `reflect.DeepEqual` in go1.15.x.

--- Comment #3 by rsc ---

This proposal has been added to the [active column](https://golang.org/s/proposal-status#active) of the proposals project
and will now be reviewed at the weekly proposal review meetings.
â€” rsc for the proposal review group


--- Comment #4 by rsc ---
/cc @FiloSottile for whether this is a reasonable API addition


--- Comment #5 by rsc ---
Talked to Filippo and he said this was reasonable to do. We are planning to keep the cert pools opaque when they are derived from the system pool, but it is easy to tell if two different pools both include the system pool or not.

Does anyone object to this?


--- Comment #6 by tmthrgd ---
Does anyone actually have a non-test use for this? Or is this something that comes up at all commonly? It sounds like it could end up being an unexpectedly slow and heavy-weight function.

--- Comment #7 by rsc ---
@tmthrgd Filippo says it can be implemented efficiently. The definition of CertPool.Equal would be "same 'use system pool' setting and same additional certificates". So the system pool itself need not be consulted for implementing Equal.



--- Comment #8 by rsc ---

Based on the discussion above, this proposal seems like a **[likely accept](https://golang.org/s/proposal-status#likely-accept)**.
â€” rsc for the proposal review group


--- Comment #9 by tmthrgd ---
> @tmthrgd Filippo says it can be implemented efficiently. The definition of CertPool.Equal would be "same 'use system pool' setting and same additional certificates". So the system pool itself need not be consulted for implementing Equal.

More than happy to be wrong, but I was basing that off of this request/requirement above: â€œI would expect Equal to load all the content from disk and compare the content using reflect.DeepEqual[.]â€ That sounded deceptively expensive to me. Though if itâ€™s not expensive, there doesnâ€™t seem to be any real reason to oppose it.

--- Comment #10 by rsc ---
> I would expect Equal to load all the content from disk and compare the content using reflect.DeepEqual, which I think should make it equivalent to using reflect.DeepEqual in go1.15.x.

To be clear, it won't. It will just compare whether two CertPools both say "include what's on disk" or not. 


--- Comment #11 by rsc ---

No change in consensus, so **[accepted](https://golang.org/s/proposal-status#accepted)**. ðŸŽ‰
This issue now tracks the work of implementing the proposal.
â€” rsc for the proposal review group


--- Comment #12 by gopherbot ---
Change https://go.dev/cl/388915 mentions this issue: `crypto/x509: add CertPool.Equal`

--- Comment #13 by gopherbot ---
Change https://go.dev/cl/398237 mentions this issue: `api: add x509.CertPool.Equal to next/46057.txt`

--- Comment #14 by ericlagergren ---
> // Equal reports whether s and other are equal.

@rolandshoemaker Under what conditions are two `CertPools` equal? The docs are a truism. I understand wanting to keep it a bit vague, but being too vague just causes people to look at the implementation.
